var APP={i18n:{},utils:{},config:{},map:{},interactiveMap:{},filter:{},fileuploader:{},multifields:{},subforms:{},anagrafica:{},anagrafica_ss:{}};$.extend(APP.i18n,{locale:{},setLocale:function(data){if(!APP.utils.isset(data.data)){APP.utils.showErrMsg(data);return}APP.i18n.locale=data.data},loadLocale:function(language){$.ajax({type:"GET",async:false,url:APP.config.localConfig.urls.i18n+language,success:APP.i18n.setLocale,error:APP.utils.showErrMsg})},translate:function(key){return this.locale.hasOwnProperty(key)?this.locale[key]:key}});$.extend(APP.utils,{isset:function(o){if(typeof o=="undefined")return false;else if(o===null)return false;return true},addslashes:function(str){str=str.replace(/\\/g,"\\\\");str=str.replace(/\'/g,"\\'");str=str.replace(/\"/g,'\\"');str=str.replace(/\0/g,"\\0");return str},stripslashes:function(str){str=str.replace(/\\'/g,"'");str=str.replace(/\\"/g,'"');str=str.replace(/\\0/g,"\x00");str=str.replace(/\\\\/g,"\\");return str},capitalize:function(string){return string.charAt(0).toUpperCase()+string.slice(1)},isEmptyString:function(elemento){elemento=elemento.toString();for(var i=0;i<elemento.length;i++)if(elemento.charAt(i)!=" "&&elemento.charAt(i)!="	")return false;return true},replaceAll:function(find,rep,str){while(str.indexOf(find)!==-1)str=str.replace(find,rep);return str},showErrMsg:function(param,dialogMode){var msgString="";var titleString="";if(this.isset(param.error)&&this.isset(param.error.errcode)){var errCodeInt=parseInt(param.error.errcode);switch(errCodeInt){case 403:window.location.href=APP.config.localConfig.urls.logout;return;case 1e4:titleString=param.error.errmsg;break;default:msgString+=param.error.errmsg+"<BR>";titleString=APP.i18n.translate("error")+" "+param.error.errcode;$.each(param.error.errdata,function(i,v){msgString+=v+"<br>"});break}}else{titleString=APP.i18n.translate("error");msgString=param.status+" "+param.statusText;console.log(titleString+": "+msgString);return}if(this.isset(param.statusText)&&param.statusText=="abort")return;if(this.isset(dialogMode)&&dialogMode===true)this.showMsg({title:titleString,content:msgString});else this.showNoty({title:titleString,content:msgString,type:"error"})},showMsg:function(obj){var div=this.isset(obj.div)?obj.div:$("#defaultMessageDialog");div.find(".modal-title").html(obj.title);div.find(".modal-body").html(obj.content);if(this.isset(obj.buttons))div.find(".modal-footer").html(obj.buttons);if(this.isset(obj.onCloseEvent)&&$.isFunction(obj.onCloseEvent))div.on("hidden",obj.onCloseEvent);else div.on("hidden",false);div.modal("show")},showNoty:function(obj){var n=noty({text:"<strong>"+obj.title+"</strong><br>"+obj.content,type:obj.type,dismissQueue:true,layout:"topCenter",timeout:this.isset(obj.timeout)?obj.timeout:3e3,buttons:this.isset(obj.buttons)?obj.buttons:false})},createModal:function(o){var myModal=null;if(o.container&&o.id)myModal=o.container.find("#"+o.id);if(myModal.length>0)myModal.remove();myModal=$('<div class="modal fade">						<div class="modal-dialog">							<div class="modal-content">								<div class="modal-header">									<button type="button" class="btn-lg close" data-dismiss="modal" aria-hidden="true"><span class="glyphicon glyphicon-remove"></span></button>									<h3 class="lead"></h3>								</div>								<div class="modal-body">								</div>								<div class="modal-footer">									<button type="button" class="btn btn-default" data-dismiss="modal">'+APP.i18n.translate("close")+"</button>								</div>							</div>						</div>					</div>");if(o.id)myModal.attr("id",o.id);if(o.size)myModal.find(".modal-dialog").removeClass().addClass("modal-dialog modal-"+o.size);if(o.header)myModal.find(".modal-header h3").html(o.header);if(o.body)myModal.find(".modal-body").html(o.body);if(o.onShown&&$.isFunction(o.onShown)){myModal.on("shown.bs.modal",function(){o.onShown()})}if(o.onHidden&&$.isFunction(o.onHidden)){myModal.on("hidden.bs.modal",function(){o.onHidden()})}if(o.container)o.container.append(myModal);return myModal},getThumbnailUrl:function(urls,v){if(urls.thumbnail){var url=urls.thumbnail;$.each(urls.thumbnail_options,function(laChiave,ilValore){url=APP.utils.replaceAll(laChiave,v[ilValore],url)});return url}return null},isImageFile:function(filename){if(filename&&!this.isEmptyString(filename)){var imageExtensions=["jpg","jpeg","gif","png"];var exts=filename.split(".");var extension=exts[exts.length-1].toLowerCase();if($.inArray(extension,imageExtensions)!==-1)return true}return false},getStyleByCssParams:function(fieldName,css_params){var resArr=["",""];if(this.isset(css_params)&&css_params.hasOwnProperty(fieldName)){$.each(css_params[fieldName],function(k,v){switch(k){case"background":resArr[1]+=" background-color:"+v+";";break;default:resArr[1]+=" "+k+":"+v+";"}})}return resArr},setLookTable:function(tableDiv){var filter=tableDiv.find(".dataTables_filter");var label=filter.find("label");var input=filter.find("input").clone(true);input.addClass("form-control");input.attr("placeholder",label.text());label.html(input)},chosenFieldInit:function(elem){var defaultObj={allow_single_deselect:true,disable_search_threshold:5,no_results_text:APP.i18n.translate("no result")};elem.chosen(defaultObj)},setLookForm:function(form,id){var that=this;if(form.find(".textEditor")){$.each(form.find(".textEditor"),function(){var myId=$(this).attr("id");var g=tinymce.get(myId);if(g)tinymce.remove("#"+myId);var oo={selector:"#"+myId,inline:false,menubar:false,readonly:$(this).attr("disabled")};var myToolbar=$(this).data().toolbar;if(myToolbar&&$.isArray(myToolbar)&&myToolbar.length>0){oo.toolbar="";$.each(myToolbar,function(x,y){oo.toolbar+=y;if(x<myToolbar.length-1)oo.toolbar+=" | "})}var myPlugins=$(this).data().plugins;if(myPlugins&&$.isArray(myPlugins)&&myPlugins.length>0){oo.plugins="";$.each(myPlugins,function(x,y){oo.plugins+=y;if(x<myPlugins.length-1)oo.plugins+=" "})}tinymce.init(oo)})}if(form.find(".mapBoxColor").length>0&&form.find(".mapboxDiv").length>0){APP.map.changeColors(form.find(".mapBoxColor").val())}form.find(".datepicker").datepicker({dateFormat:"dd/mm/yy"});var timepickerInputs=form.find(".time");$.each(timepickerInputs,function(i,v){$(v).timepicker({timeFormat:"H:i"})});var chosenInputs=form.find(".chosen");$.each(chosenInputs,function(i,v){that.chosenFieldInit($(v))});if(form.find(".fileupload").length>0)APP.fileuploader.init(form);var ip=form.find(".input-group-prefix");if(ip.length>0){$.each(ip,function(i,v){var input=$(v).find("input").first();var w1=input.width();var w2=30;input.width(w1-w2)})}var ia=form.find(".input-group-suffix");if(ia.length>0){$.each(ia,function(i,v){var input=$(v).find("input").first();var w1=input.width();var w2=30})}var inps=form.find(":input");$.each(inps,function(i,v){that.setChangeProperty($(v));$(v).data().mode=that.isset(id)?"update":"insert"});if(APP.utils.isset(id)){$.each(inps,function(i,v){v=$(v);var data=v.data();if(APP.utils.isset(data)&&APP.utils.isset(data.change)){v.data().mode="first_update";v.change()}})}if(form.hasClass("wizard")){var settings=form.data().jWizardSettings;var fb=form.find("#formButtons").clone(true,true);form.find("#formButtons").remove();form.jWizard(settings);form.prepend(fb.show());form.find(".ui-widget-content").addClass("ui-corner-all");form.find(".jw-button-finish").prepend('<i class="icon icon-ok"></i> ');form.find(".chosen-container").css("width","100%")}form.find(".tooltipElement").tooltip()},checkError:function(error,param){switch(error.errcode){case 0:return false;case 1e4:$.each(error.errdata,function(i,v){var el=param.find("#APP-"+i);if(el.length>0)APP.utils.renderError(el,v);else{APP.multifields.validation(param,i,v)}});break;default:break}return true},resetFormErrors:function(form){var cGroups=form.find(".form-group");$.each(cGroups,function(i,v){v=$(v);v.removeClass("has-error");v.find(".help-block").remove()})},renderError:function(el,v){var cgd=el.parents(".form-group").first();cgd.addClass("has-error");var span='<span class="help-block"><small>'+v+"</small></span>";var hi=cgd.find(".help-block");hi.length>0?hi.html(span):cgd.find(".controls").append(span)},confirmMsg:function(text,btnLabels,callbacks){var that=this;var confirm=$("body").find("#confirmModal");if(confirm.length>0)confirm.remove();confirm=$('<div id="confirmModal" class="modal fade" role="dialog">							<div class="modal-dialog">								<div class="modal-content">									<div class="modal-header">										<button type="button" class="close negativeResponse" aria-hidden="true">&times;</button>										<h4 class="modal-title">'+APP.i18n.translate("Confirm")+'</h4>									</div>									<div class="modal-body">										<p>'+text+'</p>									</div>									<div class="modal-footer">										<button type="button" class="btn btn-success"><i class="icon icon-ok"></i> '+btnLabels["yes"]+'</button>										<button type="button" class="btn btn-default negativeResponse">'+btnLabels["no"]+"</button>									</div>								</div>							</div>						</div>");confirm.find(".btn-success").click(function(){confirm.modal("hide");if(that.isset(callbacks["yes"])&&$.isFunction(callbacks["yes"]))callbacks["yes"]()});confirm.find(".negativeResponse").click(function(){confirm.modal("hide");if(that.isset(callbacks["no"])&&$.isFunction(callbacks["no"]))callbacks["no"]()});$("body").append(confirm);confirm.modal("show")},setChangeProperty:function(elem){var that=this;if(!APP.utils.isset(elem.data().change))return;var form=elem.parents("form").first();var sectionTarget=elem.data().sectionTarget;elem.change(function(){$.ajax({type:"GET",url:elem.data().change+$(this).val(),dataType:"json",success:function(data){if(!APP.utils.checkError(data.error,null)){$.each(data.data,function(fieldName,fieldObj){var fieldToChange=elem.hasClass("multifield")?elem.parents("tr:first").find("#APP-"+fieldName):form.find("#APP-"+fieldName);$.each(fieldObj,function(action,actionObj){if(that.isset(actionObj.available)){var ind=$.inArray(elem.data().mode,actionObj.available);if(ind===-1)return true}switch(action){case"value":if(fieldToChange.is("select")){var oldValue=fieldToChange.val();var arr=[];$.each(fieldObj.value.items,function(j,k){var label=APP.config.getValue(k,fieldObj.value.label_toshow,fieldObj.value.label_toshow_params);var valueField=APP.utils.isset(k[fieldObj.value.value_field])?fieldObj.value.value_field:"id";if(!APP.utils.isset(k[valueField])||APP.utils.isEmptyString(k[valueField])||!APP.utils.isset(label)||APP.utils.isEmptyString(label))return true;arr.push({name:label,value:k[valueField]})});fieldToChange.html(that.createOptions(arr));if(fieldToChange.find("option").length===1)fieldToChange.attr("disabled",true);else fieldToChange.val(oldValue);break}if(fieldToChange.is("input")&&fieldToChange.hasClass("mapbox")){APP.map.updateLayerGroups(elem.attr("id"),"mapboxDiv-"+fieldToChange.attr("name"),fieldObj.value.items);break}fieldToChange.val(fieldObj.value.items[0]);break;case"notify":var to=APP.utils.isset(actionObj.timeout)?actionObj.timeout:3e3;APP.utils.showNoty({title:actionObj.title,type:actionObj.type,content:actionObj.msg,timeout:to});break;case"required":if(actionObj.value){fieldToChange.attr("required",true);if(fieldToChange.parents(".form-group").first().find(".control-label").find(".requiredSymbol").length===0)fieldToChange.parents(".form-group").first().find(".control-label").prepend(that.getRequiredSymbol())}else{fieldToChange.attr("required",false);fieldToChange.parents(".form-group").first().find(".control-label").find(".requiredSymbol").remove()}break;case"disabled":if(actionObj.value){fieldToChange.attr("disabled",true)}else{fieldToChange.attr("disabled",false)}break;case"hidden":if(actionObj.value){fieldToChange.parents(".form-group:first").fadeOut(600)}else{fieldToChange.parents(".form-group:first").fadeIn(600)}break;default:console.log("Francesco, aggiungi questa action: "+action)}});if(fieldToChange.hasClass("chosen"))fieldToChange.trigger("chosen:updated")})}else APP.utils.showErrMsg(data)},error:function(result){APP.utils.showErrMsg(result)},complete:function(result){if(elem.data().mode==="first_update")elem.data().mode="update"}})})},getColorFromActivity:function(ai){var defaultColour="yellow";ai=parseInt(ai);if(isNaN(ai))return defaultColour;var index=this.getIndexFromField(APP.config.localConfig.sessione_decodifica_attivita,"id",ai);if(index>-1){if(this.isset(APP.config.localConfig.sessione_decodifica_attivita[index])&&this.isset(APP.config.localConfig.sessione_decodifica_attivita[index].color))return APP.config.localConfig.sessione_decodifica_attivita[index].color;else return defaultColour}else return defaultColour},createOptions:function(obj){var htmlString="<option value=''></option>";$.each(obj,function(i,v){htmlString+="<option value='"+v.value+"'>"+v.name+"</option>"});return htmlString},getSyncJxValues:function(urlValue){var that=this;var result=null;$.ajax({type:"GET",url:urlValue,async:false,dataType:"json",success:function(data){if(!APP.utils.checkError(data.error,null))result=data;else APP.utils.showErrMsg(data)},error:function(result){APP.utils.showErrMsg(result)}});return result},getDataFromUrl:function(url_values){var data=[];if(APP.utils.isset(url_values)){var jxValues=this.getSyncJxValues(url_values);if(APP.utils.isset(jxValues))data=jxValues.data.items}return data},getForeignValue:function(column,valori,par){var that=this;var urlV=column.url_values;var data=null;if(APP.utils.isset(column.url_values_params)){$.each(column.url_values_params,function(i,v){if(APP.utils.isset(par)){urlV=that.replaceAll(i,par,urlV)}else{if(typeof v=="object"){$.each(APP.config.breadCrumb,function(ii,vv){if(!that.isset(vv.data)||!that.isset(vv.level)||vv.level!==v.level)return true;urlV=that.replaceAll(i,vv.data[v.field],urlV);return false})}else{urlV=that.replaceAll(i,APP.config.breadCrumb[APP.config.breadCrumb.length-1].data[v.field],urlV)}}})}if(APP.utils.isset(column.default_value)){var t=column.default_value;var livello="";if(that.currentSection=="fleetgroup"){var node=APP.orgchart.getNodeFromId(APP.orgchart.selectedItem);livello="&livello="+(APP.utils.isset(options.livello)?options.livello:node.livello)}switch(t){case"data":data=that.getDataFromUrl(urlV+livello);if(that.isset(valori)&&valori!=""){if($.isArray(valori)){$.each(valori,function(i,v){data.push(v)})}else{if(typeof valori=="object")data.push(valori)}}break;case"data-id":var idsString="";var tempData=[];if(that.isset(valori)&&valori!=""){if($.isArray(valori)){$.each(valori,function(i,v){idsString+=v.id+",";tempData.push(v)})}}else{data=[];break}idsString=idsString.substring(0,idsString.length-1);if(idsString!="")data=that.getDataFromUrl(urlV+"&default_current_id="+idsString+livello);$.merge(data,tempData);break;case"url":data=that.getDataFromUrl(urlV+livello);break;default:console.log("Aggiungi questo default_value: "+t)}}else data=that.getDataFromUrl(urlV);return data},getOptionsSelect:function(valori,name,options,sectionTarget,par){var that=this;var inp="";var ind=APP.utils.getIndexFromField(sectionTarget.columns,"name",name);if(ind>-1){var data=null;if(APP.utils.isset(sectionTarget.columns[ind].foreign_key)){var fValues=APP.config.localConfig[sectionTarget.columns[ind].foreign_key];data=APP.utils.isset(fValues)?fValues:[];name=sectionTarget.columns[ind].foreign_key}else{data=this.getForeignValue(sectionTarget.columns[ind],valori,par)}var groups={};var group=sectionTarget.columns[ind].foreign_group_field;var valueField=this.isset(sectionTarget.columns[ind].foreign_value_field)?sectionTarget.columns[ind].foreign_value_field:"id";$.each(data,function(j,k){var label=APP.config.getValue(k,sectionTarget.columns[ind].foreign_toshow,sectionTarget.columns[ind].foreign_toshow_params);if(!APP.utils.isset(k[valueField])||APP.utils.isEmptyString(k[valueField])||!APP.utils.isset(label)||APP.utils.isEmptyString(label))return true;var string="";var selected="";if(!$.isArray(valori))valori=[parseInt(valori)];if(typeof valori[0]=="object"&&valori[0]!==null)selected=APP.utils.getIndexFromField(valori,valueField,k[valueField])===-1?"":"selected";else selected=$.inArray(parseInt(k[valueField]),valori)===-1?"":"selected";if(APP.utils.isset(group)){if(!APP.utils.isset(groups[k[group]]))groups[k[group]]=[];groups[k[group]].push("<option value='"+k[valueField]+"' "+selected+">"+label+"</option>")}else inp+="<option value='"+k[valueField]+"' "+selected+">"+label+"</option>"});if(!$.isEmptyObject(groups)){$.each(groups,function(i,v){if(!APP.utils.isset(i)||i=="")return true;inp+='<optgroup label="'+i+'">';$.each(v,function(j,k){inp+=k});inp+="</optgroup>"})}}return inp},getRequiredSymbol:function(){return'<small class="requiredSymbol"><i class="icon icon-asterisk text-danger"></i></small> '},getInputFormat:function(identifier,obj,required,sectionLabel,sectionTarget,context,v,valore,form){var that=this;var inp=null;switch(v.form_input_type){case"input":{switch(v.data_type){case"boolean":var tValue=valore===true||valore=="true"?" selected ":"";var fValue=valore===false||valore=="false"?" selected ":"";inp="<select id='APP-"+v.name+"' name='"+v.name+"' class='form-control chosen' data-placeholder='"+APP.i18n.translate("click_to_select")+"' "+required+">									<option value=''></option>									<option value='true' "+tValue+">"+APP.i18n.translate("yes")+"</option>									<option value='false' "+fValue+">"+APP.i18n.translate("no")+"</option>								</select>";break;case"subform":if(!this.isset(sectionTarget.subforms))sectionTarget.subforms={};if(!this.isset(sectionTarget.subforms[v.name]))sectionTarget.subforms[v.name]={};inp="<div id='APP-"+v.name+"'></div>";var uri=APP.config.localConfig.urls["dStruct"]+"?tb="+v.name;$.ajax({type:"GET",url:uri,dataType:"json",success:function(data){if(!APP.utils.checkError(data.error,null)){sectionTarget.subforms[v.name]=APP.utils.setBaseStructure(v.name,sectionLabel);context.loadStructure(data,sectionTarget.subforms[v.name]);sectionTarget.subforms[v.name].subformValidationUrl=that.isset(v.validation_url)?v.validation_url:null;sectionTarget.subforms[v.name].token=0;context.loadData(APP.config.localConfig.urls[v.name]+"?filter="+v.foreign_key+":"+identifier,sectionTarget.subforms[v.name],function(obj){var oggetto={};$.extend(oggetto,{subformName:v.name,sectionTarget:sectionTarget,ctx:context,res:obj,idl:APP.config.default_iDisplayLength});APP.subforms.showSubformTable(oggetto)})}else APP.utils.showErrMsg(data)},error:function(result){APP.utils.showErrMsg(result)}});break;case"multifield":if(!this.isset(sectionTarget.multifields))sectionTarget.multifields={};if(!this.isset(sectionTarget.multifields[v.name]))sectionTarget.multifields[v.name]={};inp="<div id='APP-"+v.name+"'></div>";var uri=APP.config.localConfig.urls["dStruct"]+"?tb="+v.name;$.ajax({type:"GET",url:uri,dataType:"json",success:function(data){if(!APP.utils.checkError(data.error,null)){sectionTarget.multifields[v.name]=APP.utils.setBaseStructure(v.name,sectionLabel);context.loadStructure(data,sectionTarget.multifields[v.name]);sectionTarget.multifields[v.name].multifieldValidationUrl=that.isset(v.validation_url)?v.validation_url:null;sectionTarget.multifields[v.name].token=0;var index=APP.utils.getIndexFromField(sectionTarget.values,"id",identifier);var obj=null;if(index>-1){obj=sectionTarget.values[index][v.name];sectionTarget.multifields[v.name].values=sectionTarget.values[index][v.name]}var oggetto={};$.extend(oggetto,{multifieldName:v.name,sectionTarget:sectionTarget,ctx:context,res:obj,idl:APP.config.default_iDisplayLength,div:inp});APP.multifields.showMultifieldTable(oggetto)}else APP.utils.showErrMsg(data)},error:function(result){APP.utils.showErrMsg(result)}});break;case"subtable":inp="<div id='APP-"+v.name+"' class='table-responsive'></div>";$.ajax({type:"GET",url:v.url_values+"?filter="+v.foreign_key+":"+identifier,dataType:"json",success:function(data){if(!APP.utils.checkError(data.error,null)){var table=$('<table class="table table-striped table-bordered table-condensed datatable">														<thead><tr></tr></thead>														<tbody></tbody>													</table>');var theadtr=table.find("thead tr");var tbody=table.find("tbody");var cols=[];if(data.data.items.length===0){form.find("#APP-"+v.name).html("<p><i>"+APP.i18n.translate("no result")+"</i></p>");return}$.each(data.data.items,function(ii,vv){if(ii===0){$.each(vv,function(iii,vvv){cols.push(iii);theadtr.append("<td>"+iii+"</td>")})}var tr=$("<tr></tr>");$.each(cols,function(iii,vvv){tr.append("<td>"+vv[vvv]+"</td>")});tbody.append(tr)});form.find("#APP-"+v.name).html(table);form.find("#APP-"+v.name).find("table").dataTable({bProcessing:true,bFilter:false,bLengthChange:false,bInfo:false,bPaginate:false,iDisplayLength:false,oLanguage:APP.utils.getDataTableLanguage()})}else APP.utils.showErrMsg(data)},error:function(result){APP.utils.showErrMsg(result)}});break;case"file":var tmpArr=[];if($.isArray(obj))tmpArr=obj;else if(!$.isEmptyObject(obj))tmpArr.push(obj);inp=APP.fileuploader.getString({name:v.name,value:tmpArr,multiple:v.multiple,urls:v.urls,options:v.data_options,capabilities:sectionTarget.capabilities});break;default:inp="<input type='text' class='form-control' id='APP-"+v.name+"' name='"+v.name+"' "+required+">";inp=$(inp).val(valore)}break}case"subdatastruct":if(APP.utils.isset(valore)){inp=$('<div id="APP-'+v.name+'"></div>');$.ajax({type:"GET",url:valore,dataType:"json",async:false,success:function(data){if(!APP.utils.checkError(data.error,null)&&APP.utils.isset(data.data)&&APP.utils.isset(data.data.groups)&&data.data.groups.length>0){$.each(data.data.groups,function(iGr,vGr){var grdiv=$('<div class="form-group"></div>');grdiv.append('<label class="control-label" style="text-align:left">'+vGr.name+"</label>");$.each(vGr.fields,function(iFd,vFd){if(!APP.utils.isset(data.data.fields[vFd].name))data.data.fields[vFd].name=vFd;var vvaalloorree=APP.utils.isset(data.data.values)&&APP.utils.isset(data.data.values[vFd])?data.data.values[vFd]:"";var inppp=that.getInputFormat(null,{},required,sectionLabel,data.data,context,data.data.fields[vFd],vvaalloorree,form);inppp.css("margin-bottom",10);if(APP.utils.isset(data.data.fields[vFd].css_class)){if(inppp.is(":input"))inppp.addClass(data.data.fields[vFd].css_class);else inppp.find(":input").addClass(data.data.fields[vFd].css_class)}if(APP.utils.isset(obj[v.name+"_values"])&&APP.utils.isset(obj[v.name+"_values"][vFd])){if(data.data.fields[vFd].form_input_type==="radiobutton"){var radios=inppp.find("#APP-"+vFd);$(radios[parseInt(obj[v.name+"_values"][vFd])-1]).attr("checked",true)}else{if(inppp.is(":input"))inppp.val(obj[v.name+"_values"][vFd]);else inppp.find(":input").val(obj[v.name+"_values"][vFd])}}if(APP.utils.isset(data.data.fields[vFd].label))grdiv.append("<small>"+data.data.fields[vFd].label+"</small>");grdiv.append(inppp)});inp.append(grdiv)})}else APP.utils.showErrMsg(data)},error:function(result){APP.utils.showErrMsg(result)}})}break;case"password":inp="<input type='password' class='form-control' id='APP-"+v.name+"' name='"+v.name+"' "+required+">";inp=$(inp).val(valore);break;case"radioswitch":inp=$('<div class="form-group"></div>');$.each(v.values,function(radioI,radioV){inp.append('<label for="APP-'+v.name+"_"+radioI+'">'+radioV+"</label>");inp.append('<input id="APP-'+v.name+'" type="radio" class="bootstrapSwitch"  name="'+v.name+'">');inp.append("<br>")});inp.find(".bootstrapSwitch").bootstrapSwitch();break;case"radiobutton":inp=$("<div></div>");if(v.radio_inline){$.each(v.values,function(radioI,radioV){var rblabel=$('<label class="radio-inline"></label>');rblabel.append('<input type="radio" id="APP-'+v.name+'" name="'+v.name+'" value="'+radioI+'">');rblabel.append(radioV);inp.append(rblabel)})}else{$.each(v.values,function(radioI,radioV){var divRadio=$('<div class="radio"></div>');var rblabel=$("<label></label>");rblabel.append('<input type="radio" id="APP-'+v.name+"_"+radioI+'" name="'+v.name+'" value="'+radioI+'">');rblabel.append(radioV);divRadio.append(rblabel);inp.append(divRadio)})}break;case"file":alert("per il campo file, il form_input_type deve essere 'input' ed il data_type 'file'");return;case"hidden":inp="<input type='hidden' id='APP-"+v.name+"' name='"+v.name+"' "+required+">";inp=$(inp).val(valore);break;case"datebox":if(that.isset(valore)&&!that.isEmptyString(valore))valore=that.convertiData(valore);inp="<input type='text' id='APP-"+v.name+"' class='form-control datepicker' name='"+v.name+"' value='"+valore+"' "+required+">";break;case"timebox":inp="<input type='text' id='APP-"+v.name+"' class='form-control time' name='"+v.name+"' value='"+valore+"' "+required+">";break;case"datetimebox":inp="<input type='text' class='form-control' id='APP-"+v.name+"' name='"+v.name+"' "+required+">";valore=that.convertiDateTime(valore);inp=$(inp).val(valore);break;case"textarea":inp=$("<textarea id='APP-"+v.name+"' name='"+v.name+"' rows='9' class='form-control' "+required+"></textarea>");inp.text(valore);if(APP.utils.isset(v.editor)&&v.editor===true){inp.addClass("textEditor");inp.data({toolbar:v.editor_buttons,plugins:v.editor_plugins})}break;case"cleartext":inp=$('<p id="APP-'+v.name+'" name="'+v.name+'"></p>');inp.text(valore);break;case"htmltext":inp=$('<p id="APP-'+v.name+'" name="'+v.name+'"></p>');inp.html(valore);break;case"combobox":inp=$("<select id='APP-"+v.name+"' class='form-control chosen' data-placeholder='"+APP.i18n.translate("click_to_select")+"' "+required+"></select>");if(APP.utils.isset(v.foreign_mode)&&v.foreign_mode=="multiselect"){inp.attr("name",v.name+"[]");inp.attr("multiple",true)}else inp.attr("name",v.name);inp.append("<option value=''></option>");if(that.isset(v.slave_of)){var parVal=form.find("#APP-"+v.slave_of).length>0?form.find("#APP-"+v.slave_of).val():"";if(that.isset(parVal)&&!that.isEmptyString(parVal)){if(v.data_type==="integer")parVal=parseInt(parVal);inp.append(this.getOptionsSelect(valore,v.name,obj,sectionTarget,parVal))}else inp.attr("disabled",true);if(inp.find("option").length===1)inp.attr("disabled",true)}else inp.append(this.getOptionsSelect(valore,v.name,obj,sectionTarget));break;case"button":inp=null;var btn=$('<span id="APP-'+v.name+'" class="btn btn-lg btn-'+v.input_class+' tooltipElement" data-toggle="tooltip" data-placement="bottom" title="'+v.description+'">'+" "+v.label+"</span>");if(v.icon)btn.prepend('<span class="icon icon-'+v.icon+'"></span>');switch(v.data_type){case"pdf_print":btn.click(function(){var urlV=v.url_values;if(that.isset(v.url_values_params)){$.each(v.url_values_params,function(j,k){urlV=that.replaceAll(j,form.find("#APP-"+k).val(),urlV)})}$.fileDownload(urlV,{httpMethod:"GET"}).fail(function(){APP.utils.showNoty({title:APP.i18n.translate("error"),type:"error",content:APP.i18n.translate("download_failure")})})});break;case"mailer":btn.click(function(){var labels={yes:APP.i18n.translate("save"),no:APP.i18n.translate("cancel")};var callbacks={yes:function(){context.formSubmit(identifier,sectionTarget.resource,function(){APP.mailer.start()})},no:null};var saveRequiredMsg=APP.utils.isset(that.sections[section].messages)&&APP.utils.isset(that.sections[section].messages["save_required"])?that.sections[section].messages["save_required"]:APP.i18n.translate("save_required");APP.utils.confirmMsg(saveRequiredMsg,labels,callbacks)});APP.mailer.init({div:$("#"+sectionTarget.resource+"Container"),actionUrl:"application/Email.php?action=send",addressesUrl:"application/Uffici.php",valuesUrl:"application/Reclami.php?action=emailvalues&id="+identifier});break;default:break}var fb=form.find("#formButtons");fb.append(btn);break;case"colorpicker":inp="<input type='color' id='APP-"+v.name+"' name='"+v.name+"' class='form-control' value='"+valore+"' "+required+">";break;case"mapbox":inp=$("<div  style='width: 100%;'></div>");inp.append("<div id='mapboxDiv-"+v.name+"' class='mapbox mapboxDiv' style='width: 100%; height: 400px;'></div>");var tmpInp=$("<input type='hidden' id='APP-"+v.name+"' name='"+v.name+"' class='mapbox'>");if(valore!="")tmpInp.val(JSON.stringify(valore));inp.append(tmpInp);break;case"mapbox_color":inp="<input type='color' id='APP-"+v.name+"' name='"+v.name+"' class='form-control mapBoxColor' value='"+valore+"' "+required+">";inp=$(inp);inp.change(function(){APP.map.changeColors($(this).val())});break;default:console.log("Aggiungi questo form_input_type: "+v.form_input_type)}if(inp===null)return null;inp=$(inp);if(this.isset(v.change)){inp.data({change:v.change,sectionTarget:sectionTarget})}if(that.isset(v.slave_of)&&v.form_input_type!=="combobox"){var parent=form.find("#APP-"+v.slave_of);if(parent.length===0)return;var parVal=parent.val();if(!that.isset(parVal)||that.isEmptyString(parVal))inp.attr("disabled",true)}var globalDiv=$("<div></div>");if(this.isset(v.prefix)||this.isset(v.suffix)){if(this.isset(v.prefix)&&!this.isset(v.suffix)){var inpGrp=$('<div class="input-group input-group-prefix"></div>');inpGrp.append('<span class="input-group-addon">'+v.prefix+"</span>");inpGrp.append(inp);globalDiv.append(inpGrp)}if(this.isset(v.suffix)&&!this.isset(v.prefix)){var inpGrp=$('<div class="input-group input-group-suffix"></div>');inpGrp.append(inp);inpGrp.append('<span class="input-group-addon">'+v.suffix+"</span>");globalDiv.append(inpGrp)}if(this.isset(v.suffix)&&this.isset(v.prefix)){var inpGrp=$('<div class="input-group input-group-prefix input-group-suffix"></div>');inpGrp.append('<span class="input-group-addon">'+v.prefix+"</span>");inpGrp.append(inp);inpGrp.append('<span class="input-group-addon">'+v.suffix+"</span>");globalDiv.append(inpGrp)}}else globalDiv.append(inp);return globalDiv},getFormField:function(name,v){var that=this;var uneditable="";var required=this.isset(v.required)?" required ":"";var inp=null;var valore=this.isset(v.values)?v.values:"";v.name=name;switch(v.form_input_type){case"input":if(v.sorttype=="boolean"){var tValue=valore===true||valore=="true"?" selected ":" ";var fValue=valore===false||valore=="false"?" selected ":" ";inp="<select id='APP-"+v.name+"' name='"+v.name+"' class='form-control chosen "+uneditable+"' "+required+">							<option value='true' "+tValue+">SI</option>							<option value='false' "+fValue+">NO</option>						</select>"}else inp="<input type='text' id='APP-"+v.name+"' name='"+v.name+"' value='"+valore+"' class='form-control "+uneditable+"' "+required+">";break;case"datebox":valore=$.isArray(valore)?valore:["",""];inp="<div class='row'>							<div class='col-md-6'>								<input type='text' id='APP-"+v.name+"_from' class='form-control datepicker' placeholder='"+APP.i18n.translate("from")+"' name='"+v.name+"_from' value='"+valore[0]+"' "+required+">							</div>							<div class='col-md-6'>								<input type='text' id='APP-"+v.name+"_to' class='form-control datepicker' placeholder='"+APP.i18n.translate("to")+"' name='"+v.name+"_to' value='"+valore[1]+"' "+required+">							</div>						</div>";break;case"colorpicker":inp="<input id='APP-"+v.name+"' name='"+v.name+"' class='form-control minicolors minicolors-input' value='"+valore+"' "+required+">";break;case"textarea":inp="<textarea id='APP-"+v.name+"' name='"+v.name+"' class='form-control "+uneditable+"' "+required+">"+valore+"</textarea>";break;case"combobox":inp="<select id='APP-"+v.name+"' name='"+v.name+"' data-placeholder='"+APP.i18n.translate("click_to_select")+"' class='form-control chosen "+uneditable+"' ";if(v.mode=="multiselect")inp+=" multiple ";if(APP.utils.isset(v.required))inp+=v.required;inp+=">";inp+=that.createOptions(valore,v.label);inp+="</select>";break;default:console.log("Aggiungi questo form_input_type: "+v.form_input_type);break}return inp},setManualPagination:function(table,numCol,pageObj,urlObj,callback){var that=this;var MAX_PAGES_NUM=10;var from=parseInt(pageObj.offset+1);var to=parseInt(from+pageObj.items_per_page-1);if(to>pageObj.tot_items)to=pageObj.tot_items;var tfoot=table.find("tfoot");tfoot.append("<td colspan='"+numCol+"'>							<div class='pagination pagination-right'>								<ul></ul>							</div>							<div>								"+APP.i18n.translate("rows")+": "+APP.i18n.translate("from")+" <b>"+from+"</b> "+APP.i18n.translate("to")+" <b>"+to+"</b> "+APP.i18n.translate("of")+" <b>"+pageObj.tot_items+"</b>							</div>						</td>");
if(pageObj.tot_pages>MAX_PAGES_NUM){var schema=parseInt(pageObj.offset/(MAX_PAGES_NUM*pageObj.items_per_page));if(from>=MAX_PAGES_NUM*pageObj.items_per_page){var firstLi=$("<li><a href='#'>&laquo;</a></li>");firstLi.data({page:parseInt(schema*MAX_PAGES_NUM)});tfoot.find(".pagination ul").append(firstLi)}var j=0;for(var i=schema*MAX_PAGES_NUM+1;j<MAX_PAGES_NUM&&i<=pageObj.tot_pages;j++){var cl=i===pageObj.page?"active":"";var li=$("<li class='"+cl+"'><a href='#'>"+i+"</a></li>");li.data({page:i});tfoot.find(".pagination ul").append(li);i++}var nextPage=parseInt(schema*MAX_PAGES_NUM+1+MAX_PAGES_NUM);if(nextPage<=pageObj.tot_pages){var lastLi=$("<li><a href='#'>&raquo;</a></li>");lastLi.data({page:nextPage});tfoot.find(".pagination ul").append(lastLi)}}else{for(var i=1;i<=pageObj.tot_pages;i++){var cl=i===pageObj.page?"class='active'":"";var li=$("<li "+cl+"><a href='#'>"+i+"</a></li>");li.data({page:i});tfoot.find(".pagination ul").append(li)}}tfoot.find("li").click(function(){if($(this).hasClass("active"))return;$.ajax({type:"GET",url:urlObj.base+urlObj.fs+"&page="+$(this).data().page,dataType:"json",success:function(data){callback(data.data,urlObj.fs)},error:function(result){that.showErrMsg(result)}})});table.dataTable({bProcessing:true,bServerSide:false,oLanguage:APP.utils.getDataTableLanguage(),bRetrieve:true,bDestroy:true,bPaginate:false,bInfo:false,bFilter:false})},getSecondaryValue:function(param){var that=this;var valore="";if(this.isset(param.value)){$.each(APP.config.breadCrumb,function(i,v){if(!that.isset(v.data)||!that.isset(v.level)||v.level!==param.value.level)return true;valore=v.data[param.value.field];return false});return valore}if(this.isset(param.default_value))if(param.default_value!=="")valore=param.default_value;return valore},displayData:function(data,t){switch(t.form_input_type){case"input":switch(t.data_type){case"boolean":data=this.boolToString(data);break;default:break}break;case"datebox":data=this.convertiData(data);break;case"datetimebox":data=this.convertiDateTime(data);break;case"colorpicker":case"mapbox_color":data="<div style='width: 100%; height: 30px; background-color: "+data+"'></div>";break;default:break}var preff=APP.utils.isset(t.prefix)?t.prefix+" ":"";var suff=APP.utils.isset(t.suffix)?" "+t.suffix:"";data=data.length>APP.config.maxStringsLength?data.substr(0,APP.config.maxStringsLength-1)+"... ":data;return preff+data+suff},convertiData:function(dateString){if(!this.isset(dateString))return"";var dateArr=dateString.split("-");return dateArr.length==3?dateArr[2]+"/"+dateArr[1]+"/"+dateArr[0]:dateString},convertiDateTime:function(datetimeString){if(!this.isset(datetimeString))return"";var dateArr=datetimeString.split(" ");if($.isArray(dateArr)&&dateArr.length===2)return this.convertiData(dateArr[0])+" "+dateArr[1];else return""},boolToString:function(b){if(b===true)return"<h5 style='margin: 0px'><span class='label label-success'> "+APP.i18n.translate("yes").toUpperCase()+" </span></h5>";if(b===false)return"<h5 style='margin: 0px'><span class='label label-danger'> "+APP.i18n.translate("no").toUpperCase()+" </span></h5>";return b},getDataTableLanguage:function(){return{sSearch:APP.i18n.translate("search")+": ",oPaginate:{sFirst:APP.i18n.translate("start"),sLast:APP.i18n.translate("end"),sPrevious:'<i class="icon icon-chevron-left"></i>',sNext:'<i class="icon icon-chevron-right"></i>'},sInfo:APP.i18n.translate("rows")+": "+APP.i18n.translate("from")+" _START_ "+APP.i18n.translate("to")+" _END_ "+APP.i18n.translate("of")+" <b>_TOTAL_</b>",sInfoFiltered:"",sInfoEmpty:"",sEmptyTable:APP.i18n.translate("empty_table"),sLengthMenu:APP.i18n.translate("view")+" _MENU_ "+APP.i18n.translate("rows"),sProcessing:APP.i18n.translate("processing"),sZeroRecords:APP.i18n.translate("no result")}},setBaseStructure:function(titolo,res){return{title:titolo,resource:res,columns:[],form:null,groups:[]}},toggleLoadingImage:function(bShow){var div=$("#loadingImageDiv");if(bShow){if(div.is(":visible"))return;var h=$(window).height();var w=$(window).width();var divWidth=parseInt(div.css("width"));div.css("top",h/2);div.css("left",w/2-divWidth);div.show()}else{if(!div.is(":visible"))return;div.hide()}},dateFormatter:function(date){var y=date.getFullYear();var m=date.getMonth()+1;var d=date.getDate();return(d<10?"0"+d:d)+"/"+(m<10?"0"+m:m)+"/"+y},dateParser:function(s){var t=Date.parse(s);if(!isNaN(t))return new Date(t);return new Date},trimlast:function(str){return str.substr(0,str.length-1)},stringQuery2Obj:function(query){var that=this;var myobj={};var re=/([^=&]+)=?([^&]*)?/g;while(match=re.exec(query)){var value="undefined"!=typeof match[2]?decodeURIComponent(match[2]):"";myobj[match[1]]=value.replace(/\+/g," ")}return myobj},obj2StringQuery:function(o,kvsep,sep){var kvsep=kvsep!=null?kvsep:"=";var sep=sep!=null?sep:"&";var query="";var str="";for(var k in o){str=o[k];if($.isArray(o[k])){str="[";for(var i=0;i<o[k].length;i++){for(var j in o[k][i])str+=j+":"+o[k][i][j]+",";str=str.substr(0,str.length-1)+";"}if(o[k].length>0)str=str.substr(0,str.length-1);str+="]"}if($.isPlainObject(o[k])&&!$.isEmptyObject(o[k])){str="{";$.each(o[k],function(i,v){str+=i+":"+v+","});str=str.substr(0,str.length-1)+"}"}if($.isPlainObject(o[k])&&$.isEmptyObject(o[k])){str="{}"}query=query+k+kvsep+str+sep}return this.trimlast(query)},updateBreadcrumb:function(action,params,context,pos){var bcUl=$("ul.breadcrumb");switch(action){case"add":APP.config.breadCrumb.push(params);break;case"addAt":APP.config.breadCrumb.splice(pos,0,params);break;case"remove":APP.config.breadCrumb.pop();break;case"replaceLast":APP.config.breadCrumb[APP.config.breadCrumb.length-1]=params;break;case"rebuild":APP.config.breadCrumb=[params];break;case"empty":APP.config.breadCrumb=[];bcUl.empty();break;case"refresh":bcUl.empty();break;default:console.log("Aggiungi voce "+action+" in APP.utils.updateBreadcrumb");return}$.each(APP.config.breadCrumb,function(i,v){var active=i===APP.config.breadCrumb.length-1?"class='active'":"";var leftIcon=APP.utils.isset(v.icon)?'<i class="icon icon-'+v.icon+' pull-left" style="margin-top: 2px; margin-right: 3px"></i>':"";var li=null;if(active!=="")li=$("<li "+active+">"+leftIcon+v.label+"</li>");else li=$('<li><a href="#">'+leftIcon+v.label+"</a></li>");v.window=i+1;li.data(v).click(function(){var selectedLi=$(this);var fromW=parseInt(APP.config.breadCrumb.length);var toW=parseInt(selectedLi.data().window);var diff=fromW-toW;if(isNaN(diff))return;for(var ii=0;ii<diff;ii++){if(APP.config.serverSide)APP.anagrafica_ss.destroyWindow();else APP.anagrafica.destroyWindow()}});if(i===0)bcUl.html(li);else bcUl.append(li)})},getIndexFromField:function(array,field,value){var j=-1;$.each(array,function(i,v){if(v[field]===value){j=i;return false}});return j},amIAdmin:function(){var mri=parseInt(APP.config.localConfig.authuser.main_role_id);var index=this.getIndexFromField(APP.config.localConfig.role,"id",mri);return APP.i18n.translate(APP.config.localConfig.role[index]).name===APP.i18n.translate("admin_role")?true:false}});$.extend(APP.config,{localConfig:{},currentConfigSection:null,default_iDisplayLength:10,breadCrumb:[],fadeInDelay:400,fadeOutDelay:100,maxStringsLength:128,periodicRequestsIds:[],serverSide:false,bc_getLastSrcElement:function(){return this.breadCrumb.length-1>=0?this.breadCrumb[this.breadCrumb.length-1].srcElement:null},xhrObj:{queue:[],init:function(){$.ajaxSetup({cache:false});$(document).bind("ajaxStart",function(jqXHR){APP.config.xhrObj.queue.push(jqXHR)}).bind("ajaxSend",function(){APP.utils.toggleLoadingImage(true)}).bind("ajaxComplete",function(jqXHR){}).bind("ajaxStop",function(jqXHR){APP.utils.toggleLoadingImage(false);var index=APP.config.xhrObj.queue.indexOf(jqXHR);if(index>-1)APP.config.xhrObj.queue.splice(index,1)})},abortAll:function(){var that=this;$.each(APP.config.xhrObj.queue,function(idx,jqXHR){if(APP.utils.isset(jqXHR)&&$.isFunction(jqXHR.abort))jqXHR.abort()});APP.config.xhrObj.queue=[]}},getToken:function(ds){var that=this;ds=APP.utils.isset(ds)&&ds!==""?"?datastruct="+ds:"";var token="";$.ajax({type:"GET",url:APP.config.localConfig.urls["token"]+ds,dataType:"json",async:false,success:function(data){if(!APP.utils.checkError(data.error,null)){token=data.data.token}else APP.utils.showErrMsg(data)},error:function(result){APP.utils.showErrMsg(result)}});return token},getValue:function(obj,stringTemplate,params){$.each(params,function(i,v){stringTemplate=obj.hasOwnProperty(v)?stringTemplate.replace(i,obj[v]):stringTemplate.replace(i,"")});return stringTemplate},createTabs:function(div,menu){var that=this;var tabs=menu.items;if(!APP.utils.isset(div)||!APP.utils.isset(tabs))return;var ul=$('<ul class="nav nav-tabs"></ul>');var counter=0;$.each(tabs,function(i,v){var active=counter===0?'class="active"':"";var li=$('<li id="'+v.id+'" '+active+'><a href="#"><i class="icon icon-'+v.icon+'"></i> '+v.name+"</a></li>");li.data({data:v,label:i});li.click(function(){var item=$(this);that.removeActiveClasses($(".nav-tabs"),"li");item.addClass("active");var dataItem=item.data();div.find("#tabsContent").empty();if(!APP.utils.isset(that.localConfig.urls[dataItem.label]))that.localConfig.urls[dataItem.label]=dataItem.data.url;that.checkMenuType("tabsContent",dataItem.label,dataItem.data.name,item,dataItem.data.menu)});ul.append(li);counter++});div.html(ul);div.append("<div id='tabsContent' style='padding-top: 20px'></div>");div.find("ul.nav.nav-tabs").find("li.active").click()},createAffix:function(div,menu){var that=this;var items=menu.items;if(!APP.utils.isset(div)||!APP.utils.isset(items))return;var ul=$('<div class="list-group"></div>');var counter=0;$.each(items,function(i,v){var active=counter===0?'class="list-group-item active"':'class="list-group-item"';var li=$('<a id="'+v.id+'" '+active+' href="#"><i class="icon icon-'+v.icon+' pull-left"></i><i class="icon icon-chevron-right pull-right"></i>&nbsp;&nbsp;'+v.name+"</a>");li.data({data:v,label:i});li.click(function(){var item=$(this);that.removeActiveClasses(item.parents(".list-group"),"a");item.addClass("active");var dataItem=item.data();div.find("#affixContent").empty();if(!APP.utils.isset(that.localConfig.urls[dataItem.label]))that.localConfig.urls[dataItem.label]=dataItem.data.url;that.checkMenuType("affixContent",dataItem.label,dataItem.data.name,item,dataItem.data.menu)});ul.append(li);counter++});var row=$('<div class="row">						<div class="col-md-3"></div>						<div class="col-md-9" id="affixContent"></div>					</div>');row.find(".col-md-3").html(ul);div.html(row);ul.find(".active").click()},createCollapse:function(div,menu){var that=this;var items=menu;if(!APP.utils.isset(div)||!APP.utils.isset(items))return;var accordionDiv=$('<div class="accordion" id="accordion_'+that.currentConfigSection+'"></div>');$.each(items,function(i,v){var ag=$('<div class="accordion-group">							<div class="accordion-heading">								<a class="accordion-toggle" data-toggle="collapse" data-parent="#accordion_'+that.currentConfigSection+'" href="#collapse_'+v.id+'">									<i class="icon icon-'+v.icon+'"></i> '+v.name+'								</a>							</div>							<div id="collapse_'+v.id+'" class="accordion-body collapse">								<div class="accordion-inner">								</div>							</div>						</div>');ag.find(".accordion-toggle").data({data:v,label:i}).click(function(){var item=$(this);var dataItem=item.data();var destDiv=item.parents(".accordion-group").first().find(".accordion-inner").first();if(!APP.utils.isset(that.localConfig.urls[dataItem.label]))that.localConfig.urls[dataItem.label]=dataItem.data.url;destDiv.empty();that.checkMenuType("accordion_"+that.currentConfigSection,dataItem.label,dataItem.data.name,item,dataItem.data.menu)});accordionDiv.append(ag)});div.html(accordionDiv);accordionDiv.find("div.accordion-group").first().find(".accordion-toggle").click()},checkMenuType:function(divId,section,label,button,menuObj){if(APP.utils.isset(menuObj)&&!$.isEmptyObject(menuObj)){switch(menuObj.type){case"tabs":this.createTabs($("#mainContent").find("#"+divId),menuObj);break;case"affix":this.createAffix($("#mainContent").find("#"+divId),menuObj);break;case"collapse":this.createCollapse($("#mainContent").find("#"+divId),menuObj);break;default:console.log("Francesco, aggiungi il seguente menuObj.type: "+menuObj.type)}}else{if(APP.config.serverSide)APP.anagrafica_ss.start(button,label,section,$("#"+divId));else APP.anagrafica.start(button,label,section,$("#"+divId))}},insertContent:function(button,section){var that=this;this.removeActiveClasses($(".navbar"),"li");button.closest("li").addClass("active");var prevDiv=$("#mainContent").find("#"+this.currentConfigSection+"Container");if(prevDiv.length>0)prevDiv.remove();switch(this.currentConfigSection){default:if(APP.config.serverSide)APP.anagrafica_ss.finish();else APP.anagrafica.finish();break}this.currentConfigSection=section;APP.utils.updateBreadcrumb("empty");var divId=this.currentConfigSection+"Container";$("#mainContent").append("<div id='"+divId+"' style='padding-top: 20px'></div>");this.checkMenuType(divId,section,button.text(),button,this.localConfig.menu[this.currentConfigSection].menu)},removeActiveClasses:function(group,elemType){this.xhrObj.abortAll();$.each(group.find(elemType),function(i,v){v=$(v);if(v.hasClass("active")){v.removeClass("active");return false}})},setPeriodicRequests:function(){if(APP.utils.isset(APP.config.localConfig.periodic_requests)){$.each(APP.config.localConfig.periodic_requests,function(i,v){periodicRequestsIds.push(setInterval(function(){$.ajax({type:"GET",url:v.url,dataType:"json",success:function(result){if(!APP.utils.checkError(result.error,null)){$.each(result.data.messages,function(j,obj){APP.utils.showNoty({title:obj.title,type:obj.type,content:obj.content})});$.each(result.data.badges,function(j,obj){$.each($("#APP-"+j).attr("class").toString(),function(k,className){if(className!=="notification")$("#APP-"+j).removeClass(className)});$("#APP-"+j).addClass(obj.type);$("#APP-"+j).html(obj.content)});$.each(result.data.labels,function(j,obj){$.each($("#APP-"+j).attr("class").toString(),function(k,className){if(className!=="label")$("#APP-"+j).removeClass(className)});$("#APP-"+j).addClass("label-"+obj.type);$("#APP-"+j).html(obj.content)})}else APP.utils.showErrMsg(result)},error:function(result){APP.utils.showErrMsg(result)}})},v.frequency))})}},setConfig:function(data){if(!APP.utils.isset(data.data.config)){APP.utils.showErrMsg(data);return}APP.config.localConfig=data.data.config;APP.i18n.loadLocale(APP.config.localConfig.i18n);$.datepicker.setDefaults($.datepicker.regional[APP.config.localConfig.i18n.split("-")[0]]);APP.config.setPeriodicRequests()},loadConfig:function(){$.ajax({type:"GET",async:false,url:BOOTSTRAP_URL,success:APP.config.setConfig,error:APP.utils.showErrMsg})},setMsgDialog:function(){$("body").append('<div id="defaultMessageDialog" class="modal fade" role="dialog">								<div class="modal-dialog">									<div class="modal-content">										<div class="modal-header">											<button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>											<h4 class="modal-title">Bootstrap Modal</h4>										</div>										<div class="modal-body"></div>										<div class="modal-footer">											<button class="btn btn-default" data-dismiss="modal" aria-hidden="true">'+APP.i18n.translate("close")+"</button>										</div>									</div>								</div>							</div>");$("#defaultMessageDialog").modal({show:false})},setLoadingImage:function(){$("body").append('<div id="loadingImageDiv" class="panel panel-success" style="display: none; position: fixed; z-index: 10000;">								<div class="panel-heading"><i class="icon-spinner icon-spin icon-large"></i>&nbsp;&nbsp;<b>'+APP.i18n.translate("loading")+'</b>...</div>								<div class="panel-body" style="display: none"></div>							</div>')},setMenu:function(){var that=this;if(!that.localConfig.menu){APP.interactiveMap.start();return}$.each(that.localConfig.menu,function(i,v){var button=$("#"+v.id+"Button");var callBack=i==="logout"?function(){location.href=v.url}:function(){tinymce.remove(".textEditor");that.insertContent($(this),v.id)};button.click(callBack)})},setMainContent:function(){$("body").append("<div id='mainContent' style='padding: 60px 15px 60px 15px'></div>")},setFilterDialogsDiv:function(){$("body").append("<div id='filterDialogsDiv'></div>")},setEuroDate:function(){$.extend(jQuery.fn.dataTableExt.oSort,{"date-euro-pre":function(a){if($.trim(a)!=""){var frDatea=$.trim(a).split(" ");if($.isArray(frDatea)&&frDatea.length<2)return 1e13;var frTimea=frDatea[1].split(":");var frDatea2=frDatea[0].split("/");var x=(frDatea2[2]+frDatea2[1]+frDatea2[0]+frTimea[0]+frTimea[1]+frTimea[2])*1}else{var x=1e13}return x},"date-euro-asc":function(a,b){return a-b},"date-euro-desc":function(a,b){return b-a}})},setDateEu:function(){jQuery.extend(jQuery.fn.dataTableExt.oSort,{"date-eu-pre":function(date){var date=date.replace(" ","");if(date.indexOf(".")>0){var eu_date=date.split(".")}else{var eu_date=date.split("/")}if($.isArray(eu_date)&&eu_date.length<2)return 1e13;if(eu_date[2]){var year=eu_date[2]}else{var year=0}var month=eu_date[1];if(month.length==1){month=0+month}var day=eu_date[0];if(day.length==1){day=0+day}return(year+month+day)*1},"date-eu-asc":function(a,b){return a<b?-1:a>b?1:0},"date-eu-desc":function(a,b){return a<b?1:a>b?-1:0}})},setResize:function(){$(window).on("resize",function(){APP.map.resizeMap();APP.interactiveMap.resize()})},init:function(){if($("#login").length===1)return;this.xhrObj.init();this.setResize();this.setLoadingImage();this.setMsgDialog();this.setDateEu();this.setEuroDate();this.loadConfig();this.setMainContent();this.setFilterDialogsDiv();this.setMenu();return}});$.extend(APP.filter,{filterDialogs:{},hasActiveFilter:function(section){if(this.filterDialogs.hasOwnProperty(section)&&this.filterDialogs[section].filterToggle)return true;return false},getActiveFilterString:function(section){var str="";if(!this.filterDialogs.hasOwnProperty(section)||!APP.utils.isset(this.filterDialogs[section].appliedForm))return str;$.each(this.filterDialogs[section].appliedForm,function(i,v){str+=v.name+":"+v.value+","});if(str.length>0)str=str.substr(0,str.length-1);var filterString=str.length>0?"?filter="+str:"";return filterString},init:function(btn,section,cb){var that=this;btn.off("click").click(function(){that.openFilterPane(section)});if(that.filterDialogs.hasOwnProperty(section))return;that.filterDialogs[section]={};that.filterDialogs[section].dlg=$('<div id="filterDialog_'+section+'" class="modal fade" role="dialog">												<div class="modal-dialog">													<div class="modal-content">														<div class="modal-header">															<button type="button" class="close" data-dismiss="modal" aria-hidden="true"><strong>&times;</strong></button>															<h4 class="modal-title">'+APP.i18n.translate("search")+'</h4>														</div>														<div class="modal-body"></div>														<div class="modal-footer panel-footer">															<button type="button" id="filterButton" class="btn btn-success"><i class="icon icon-ok"></i> '+APP.i18n.translate("apply")+'</button>															<button type="button" id="removeFilterButton" class="btn btn-primary"><i class="icon icon-eraser"></i> '+APP.i18n.translate("reset")+'</button>															<button type="button" class="btn btn-default" data-dismiss="modal" aria-hidden="true">'+APP.i18n.translate("close")+"</button>														</div>													</div>												</div>											</div>");that.filterDialogs[section].dlg.find("#filterButton").click(function(){var f=that.filterDialogs[section].dlg.find(".modal-body form");that.filterDialogs[section].appliedForm=f.serializeArray();var dirty=false;$.each(that.filterDialogs[section].appliedForm,function(i,v){if(v.value!==""){dirty=true;return false}});that.filterDialogs[section].filterToggle=dirty;that.applyFilter({form:f,baseUrl:APP.config.localConfig.urls[section],callback:function(result,fs){if(!APP.utils.checkError(result.error,f)){that.filterDialogs[section].dlg.modal("hide");cb(result)}else APP.utils.showErrMsg(result)}})});that.filterDialogs[section].dlg.find("#removeFilterButton").first().click(function(e){var f=that.filterDialogs[section].dlg.find(".modal-body form");APP.utils.resetFormErrors(f);f[0].reset();f.find(".chosen").trigger("chosen:updated");that.filterDialogs[section].appliedForm=f.serializeArray();that.filterDialogs[section].filterToggle=false;that.applyFilter({form:f,baseUrl:APP.config.localConfig.urls[section],callback:function(result,fs){if(!APP.utils.checkError(result.error,f)){cb(result)}else APP.utils.showErrMsg(result)}})});that.filterDialogs[section].dlg.modal({show:false});$("#filterDialogsDiv").append(that.filterDialogs[section].dlg)},openFilterPane:function(section){var that=this;if(this.filterDialogs[section].dlg.find(".modal-body").children().length===0){$.ajax({type:"GET",url:APP.config.localConfig.urls.filter+section,success:function(result){if(result.status){that.createFilterForm(result,section);var f=that.filterDialogs[section].dlg.find("form").first();that.filterDialogs[section].dlg.on("shown.bs.modal",function(){APP.utils.setLookForm(f,null);that.filterDialogs[section].dlg.off("shown.bs.modal")});that.filterDialogs[section].dlg.modal("show")}else APP.utils.showErrMsg(result)},error:function(result){APP.utils.showErrMsg(result)}})}else{APP.utils.resetFormErrors(this.filterDialogs[section].dlg.find(".modal-body form"));var f=this.filterDialogs[section].dlg.find(".modal-body form");f[0].reset();f.find(".chosen").trigger("chosen:updated");if(APP.utils.isset(that.filterDialogs[section].appliedForm)){$.each(that.filterDialogs[section].appliedForm,function(i,v){var el=f.find("#APP-"+v.name);el.val(v.value);if(el.hasClass("chosen"))el.trigger("chosen:updated")})}that.filterDialogs[section].dlg.modal("show")}},createFilterForm:function(data,section){var that=this;var f=that.getFilterForm(data.data);var formDiv=that.filterDialogs[section].dlg.find(".modal-body");formDiv.html(f)},getFilterForm:function(data,formId){var that=this;var f=$("<form class='form-horizontal' style='padding-top: 10px'></form>");if(APP.utils.isset(data)){$.each(data,function(i,v){var fg=$("<div class='form-group'>							<label class='control-label col-md-4' for='APP-"+i+"'><small>"+v.label+":</small></label>							<div class='controls col-md-8'></div>						</div>");var inp=$(APP.utils.getFormField(i,v));fg.find(".controls").append(inp);f.append(fg)})}f.find(":input").addClass("input-sm");return f},getFilterString:function(form){var dataStr=form.serialize();var dataObj=APP.utils.stringQuery2Obj(dataStr);return APP.utils.obj2StringQuery(dataObj,":",",")},applyFilter:function(obj){var that=this;APP.utils.resetFormErrors(obj.form);var fs=this.getFilterString(obj.form);var filterString=APP.utils.isset(fs)?"?filter="+fs:"";$.ajax({type:"GET",url:obj.baseUrl+filterString,success:function(result){if(!APP.utils.checkError(result.error,obj.form))obj.callback(result,filterString);else APP.utils.showErrMsg(result)},error:function(result){APP.utils.showErrMsg(result)}})}});$.extend(APP.fileuploader,{fileRows:{},displayTagFromFilename:function(name,fileObj){var that=this;var thumbnail="";var tipo=null;if(!fileObj.type){if(APP.utils.isImageFile(fileObj[name])){var tu=APP.utils.getThumbnailUrl(that.fileRows[name].urls,fileObj);if(tu)return'<img src="'+tu+'" alt="" class="img-responsive img-thumbnail">';return'<i class="icon icon-file-alt"></i>'+fileObj[name]}return'<i class="icon icon-file-alt"></i>'+fileObj[name]}else tipo=fileObj.type.split("/")[0];switch(tipo){case"image":thumbnail='<img src="'+fileObj.thumbnail_url+'" class="img-responsive img-thumbnail" alt=""/>';break;default:thumbnail='<i class="icon icon-file-alt icon-large"></i>';break}return thumbnail},getTrString:function(name,fileObj){var that=this;var thumbnail=that.displayTagFromFilename(name,fileObj);var downUrl=that.fileRows[name].urls.download;if(!APP.utils.isset(fileObj.url)){$.each(that.fileRows[name].urls.download_options,function(i,v){downUrl=APP.utils.replaceAll(i,fileObj[v],downUrl)})}else downUrl=fileObj.url;var filename=$('<span class="text-info fileDownloadSimpleRichExperience" style="cursor: pointer">'+fileObj[that.fileRows[name].inputName]+"</span>");filename.click(function(){$.fileDownload(downUrl).fail(function(){APP.utils.showNoty({title:APP.i18n.translate("error"),type:"error",content:APP.i18n.translate("download_failure")})})});var display=$.inArray("delete",that.fileRows[name].capabilities)>-1?"":"display:none";var tr=$('<tr>					<td style="vertical-align: middle">						<span class="pull-left">						'+thumbnail+'						</span>						<span class="filenameContainer" style="padding-left: 3px"></span>						<span class="pull-right moreActions">							<button type="button" class="close fileupload cancel tooltipElement" style="'+display+'" data-toggle="tooltip" title="'+APP.i18n.translate("remove")+'" aria-hidden="true">&times;</button>						</span>					</td>				</tr>');tr.data({inputName:name});tr.find(".filenameContainer").html(filename);return tr},onFileAdd:function(form,inputName,data){var that=this;var table=form.find("#APP-"+inputName).parents(".controls:first").find(".fileToUploadTable");if(!data.hasOwnProperty(inputName))data[inputName]=data.name;data.stato="I";that.fileRows[inputName].myFiles.push(data);var str=this.getTrString(inputName,data);str.find("button.cancel").click(function(){APP.fileuploader.onFileRemove(form,$(this))});if($.inArray("delete",that.fileRows[inputName].capabilities)===-1)str.find("button.cancel").hide();var tbody=table.find("tbody");tbody.append(str);if(!that.fileRows[inputName].bMultiple){form.find("#APP-"+inputName).parents(".controls:first").find(".fileinput-button").addClass("disabled");form.find("#APP-"+inputName).parents(".controls:first").find(".fileinput-button").find("input").attr("disabled",true)}table.find(".tooltipElement").tooltip();if(!table.is(":visible"))table.show()},onFileRemove:function(form,btn){var that=this;var tr=btn.parents("tr").first();var inputName=tr.data().inputName;var table=tr.parents("table").first();var filename=tr.find(".filenameContainer").text();var onFileRemoved=function(){tr.remove();if(table.find("tr").length===1){table.hide();form.find("#APP-"+inputName).parents(".row:first").find(".fileinput-button").find("input").removeAttr("disabled");form.find("#APP-"+inputName).parents(".row:first").find(".fileinput-button").removeClass("disabled")}};var index=APP.utils.getIndexFromField(that.fileRows[inputName].myFiles,inputName,filename);if(index==-1)return;if(!APP.utils.isset(that.fileRows[inputName].myFiles[index].id)){if(APP.utils.isset(that.fileRows[inputName].myFiles[index].delete_url)&&APP.utils.isset(that.fileRows[inputName].myFiles[index].delete_type)){$.ajax({type:that.fileRows[inputName].myFiles[index].delete_type,url:that.fileRows[inputName].myFiles[index].delete_url,dataType:"json",success:function(data){if(!APP.utils.checkError(data.error,null)){that.fileRows[inputName].myFiles.splice(index,1);onFileRemoved()}else that.showErrMsg(data)},error:function(result){APP.utils.showErrMsg(result,false)}})}else{that.fileRows[inputName].myFiles[index].stato="D";onFileRemoved()}}else{that.fileRows[inputName].myFiles[index].stato="D";onFileRemoved()}},getString:function(params){var that=this;that.fileRows[params.name]={};that.fileRows[params.name].inputName=params.name;that.fileRows[params.name].urls=params.urls;that.fileRows[params.name].bMultiple=params.multiple;that.fileRows[params.name].validationOptions=params.options;that.fileRows[params.name].myFiles=[];that.fileRows[params.name].capabilities=params.capabilities;var mulAr=that.fileRows[params.name].bMultiple===true?["[]","multiple"]:["",""];var obj=params.v;var tableDiv=$('<div class="row">								<div class="table-responsive col-md-12" style="margin: 5px 0px 0px 0px">									<table style="display: none;" class="table table-striped table-hover fileToUploadTable">										<thead style="display: none">											<tr style=""><th colspan="1"></th></tr>										</thead>										<tbody class="files"></tbody>									</table>								</div>							</div>');var tbody=tableDiv.find("tbody");$.each(params.value,function(i,v){if(i==0)tableDiv.find("table").show();if(!APP.utils.isset(v[that.fileRows[params.name].inputName]))return true;if($.isArray(v[that.fileRows[params.name].inputName])){$.each(v[that.fileRows[params.name].inputName],function(ii,vv){if(vv==="")return true;var o={};$.extend(o,v);$.extend(o[that.fileRows[params.name].inputName],vv);that.fileRows[params.name].myFiles.push(o);tbody.append(that.getTrString(params.name,o))})}else{that.fileRows[params.name].myFiles.push($.extend({},v));tbody.append(that.getTrString(params.name,v))}});var disClass=that.fileRows[params.name].myFiles.length>0&&!that.fileRows[params.name].bMultiple?"disabled":"";var div=$("<div></div>");div.append('<div class="row" style="height: 40px">						<div class="col-md-5">							<span id="APP-'+that.fileRows[params.name].inputName+'" class="btn btn-warning fileinput-button '+disClass+'">								<span><i class="icon icon-search"></i> '+APP.i18n.translate("select")+'</i></span>								<input type="file" class="fileupload" name="'+that.fileRows[params.name].inputName+'[]" '+mulAr[1]+" "+disClass+' >							</span>						</div>						<div class="col-md-7">							<div id="progress" class="progress progress-striped" style="display: none">								<div class="progress-bar progress-bar-success"></div>							</div>						</div>					</div>');div.append(tableDiv);return div},init:function(form){var that=this;$.each(that.fileRows,function(key,value){var chiave=key;var obj={url:this.urls.data,dataType:"json",add:function(e,data){form.find("#APP-"+chiave).parents(".row:first").find("#progress").show();APP.utils.toggleLoadingImage(false);APP.utils.resetFormErrors(form);var jqXHR=data.submit().success(function(result,textStatus,jqXHR){if(!APP.utils.checkError(result.error,form))that.onFileAdd(form,chiave,result.data[chiave][0]);else APP.utils.showErrMsg(result)}).error(function(jqXHR,textStatus,errorThrown){var t}).complete(function(result,textStatus,jqXHR){setTimeout(function(){form.find("#APP-"+chiave).parents(".row:first").find("#progress").fadeOut(1e3,function(){form.find("#APP-"+chiave).parents(".row:first").find("#progress .progress-bar").css("width",0)})},1e3)})},done:function(e,data){},always:function(e,data){},progressall:function(e,data){var progress=parseInt(data.loaded/data.total*100,10);form.find("#APP-"+chiave).parents(".row:first").find("#progress .progress-bar").css("width",progress+"%")},previewMaxWidth:100,previewMaxHeight:100,previewCrop:true};if(APP.utils.isset(this.validationOptions)&&$.isPlainObject(this.validationOptions)&&!$.isEmptyObject(this.validationOptions)){$.extend(obj,this.validationOptions)}var inp=form.find('input.fileupload[name="'+this.inputName+'[]"]');inp.fileupload(obj)});form.find("button.fileupload.cancel").click(function(){APP.fileuploader.onFileRemove(form,$(this))});form.find(".tooltipElement").tooltip()},preserialize:function(inputName){var that=this;var filesToSend=[];inputName=inputName.split("[]")[0];$.each(that.fileRows[inputName].myFiles,function(){var obj={name:this[inputName]};obj.stato=APP.utils.isset(this.stato)?this.stato:"U";filesToSend.push(obj)});var str=JSON.stringify(filesToSend);return{name:inputName,value:str}}});$.extend(APP.subforms,{sectionTarget:null,subformRows:{},finish:function(){this.subformRows={}},setTooltips:function(div){div.find(".icon-eye-open").parents("button").first().tooltip({title:APP.i18n.translate("show")});div.find(".icon-pencil").parents("button").first().tooltip({title:APP.i18n.translate("edit")});div.find(".icon-trash").parents("button").first().tooltip({title:APP.i18n.translate("remove")});div.find(".icon-lock").parents("button").first().tooltip({title:APP.i18n.translate("off")});div.find(".icon-off").parents("button").first().tooltip({title:APP.i18n.translate("on")})
},generateActionButtonsString:function(i,subformName){var that=this;var str=$('<div class="actionButtonsString"></div>');str.css("white-space","nowrap");if($.inArray("update",that.sectionTarget.subforms[subformName].capabilities)>-1)str.append("<button type='button' id='edit_"+i+"' data-subformname='"+subformName+"' name='edit' class='btn btn-default' ><i class='icon-pencil'></i></button>");else str.append("<button type='button' id='show_"+i+"' data-subformname='"+subformName+"' name='show' class='btn btn-default' ><i class='icon-eye-open'></i></button>");if($.inArray("delete",that.sectionTarget.subforms[subformName].capabilities)>-1)str.append("<button type='button' id='remove_"+i+"' data-subformname='"+subformName+"' name='remove' class='btn btn-danger' ><i class='icon-trash'></i></button>");return str.html()},preserialize:function(subformName){var that=this;var str="";$.each(that.subformRows[subformName],function(){str+=$.param(this)+";"});str=str.substr(0,str.length-1);return{name:subformName,value:str}},setActionButtonsClick:function(recipient,params){var that=this;var buttons=recipient.find(".btn");$.each(buttons,function(i,v){$(v).data(params);$(v).click(function(){that.onActionButtonClick($(this),recipient)})});that.setTooltips(recipient)},addSubformItem:function(form,tableDiv,subformName){var that=this;var table=tableDiv.find(".datatable").dataTable();var serializedData=form.serializeArray();var data={};var ths=table.find("th");$.each(ths,function(i,v){data[$(v).attr("name")]=""});var obj={};$.each(form.find(":input").not(":button"),function(i,v){switch(v.tagName){case"SELECT":var t=$(v.selectedOptions);var value="";var text="";$.each(t,function(ii,vv){value+=$(vv).val()+",";text+=$(vv).text()+"<br><br>"});value=value.substr(0,value.length-1);text=text.substr(0,text.length-8);var name=$(v).attr("name");data[name]=text;break;case"INPUT":case"TEXTAREA":var name=$(v).attr("name");if(!APP.utils.isset(name)||name=="")break;if($(v).hasClass("fileupload")){var value="";name=name.split("[]")[0];$.each(APP.fileuploader.fileRows[name].myFiles,function(ii,vv){if(vv.stato==="D")return true;if(vv.type.split("/")[0]==="image")value+='<img class="img-responsive img-thumbnail" src="'+vv.thumbnail_url+'" alt="">|';else value+='<i class="icon icon-file-alt"></i>'+vv[name]+"|"});value=value.substr(0,value.length-1);data[name]=APP.utils.replaceAll("|","<br>",value);obj[name]=APP.fileuploader.fileRows[name].myFiles[APP.fileuploader.fileRows[name].myFiles.length-1][name];break}var value=$(v).val();data[name]=value;break;default:console.log("Aggiungi questo tagName: "+v.tagName)}});data.actions=that.generateActionButtonsString(that.sectionTarget.subforms[subformName].token,subformName);var dataArr=[];$.each(data,function(i,v){dataArr.push(v)});var newRowIndex=table.fnAddData(dataArr);var tr=$(table.find("tbody").find("tr")[newRowIndex[0]]);tr.find("td").addClass("table-td");tr.css("cursor","pointer");$.each(serializedData,function(i,v){if(v.name.substr(v.name.length-2)=="[]"){var name=v.name.substr(0,v.name.length-2);if(!$.isArray(obj[name]))obj[name]=[];obj[name].push(v.value)}else obj[v.name]=v.value});$.extend(obj,{token:that.sectionTarget.subforms[subformName].token,stato:"I"});tr.data(obj);if(!APP.utils.isset(that.subformRows[subformName]))that.subformRows[subformName]=[];that.subformRows[subformName].push(obj);that.setActionButtonsClick(tr,obj);that.sectionTarget.subforms[subformName].token++},editSubformItem:function(form,tableDiv,btn,subformName){var that=this;var table=tableDiv.find(".datatable").dataTable();var serializedData=form.serializeArray();var tr=btn.parents("tr");var data={};var ths=table.find("th");$.each(ths,function(i,v){data[$(v).attr("name")]=""});var obj={};$.each(form.find(":input").not(":button"),function(i,v){switch(v.tagName){case"SELECT":var t=$(v.selectedOptions);var value="";var text="";$.each(t,function(ii,vv){value+=$(vv).val()+",";text+=$(vv).text()+"<br><br>"});value=value.substr(0,value.length-1);text=text.substr(0,text.length-8);var name=$(v).attr("name");data[name]=text;break;case"INPUT":case"TEXTAREA":var name=$(v).attr("name");if(!APP.utils.isset(name)||name=="")break;if($(v).hasClass("fileupload")){var value="";var name=name.split("[]")[0];$.each(APP.fileuploader.fileRows[name].myFiles,function(ii,vv){if(vv.stato==="D")return true;if(vv.type){if(vv.type.split("/")[0]==="image")value+='<img class="img-responsive img-thumbnail" src="'+vv.thumbnail_url+'" alt="">|';else value+='<i class="icon icon-file-alt"></i>'+vv[name]+"|"}else{if(APP.utils.isImageFile(vv[name])){var index=APP.utils.getIndexFromField(that.sectionTarget.subforms[subformName].columns,"name",name);var tu=APP.utils.getThumbnailUrl(that.sectionTarget.subforms[subformName].columns[index].urls,vv);if(tu)value+='<img src="'+tu+'" alt="" class="img-responsive img-thumbnail">|';else value+='<i class="icon icon-file-alt"></i>'+vv[name]+"|"}else value+='<i class="icon icon-file-alt"></i>'+vv[name]+"|"}});value=value.substr(0,value.length-1);data[name]=APP.utils.replaceAll("|","<br>",value);obj[name]=APP.fileuploader.fileRows[name].myFiles[APP.fileuploader.fileRows[name].myFiles.length-1][name];break}var value=$(v).val();data[name]=value;break;default:console.log("Aggiungi questo tagName: "+v.tagName)}});$.each(serializedData,function(i,v){if(v.name.substr(v.name.length-2)=="[]"){var name=v.name.substr(0,v.name.length-2);if(!$.isArray(obj[name]))obj[name]=[];obj[name].push(v.value)}else obj[v.name]=v.value});var btnData=btn.data();obj.stato=APP.utils.isset(btnData[that.sectionTarget.subforms[subformName].primary_key])?"U":btnData.stato;obj.token=btnData.token;var index=APP.utils.getIndexFromField(that.subformRows[subformName],"token",obj.token);if(index==-1)return;$.extend(that.subformRows[subformName][index],obj);data.actions=that.generateActionButtonsString(obj.token,subformName);var dataArr=[];$.each(data,function(i,v){dataArr.push(v)});table.fnUpdate(dataArr,tr[0]);that.setActionButtonsClick(tr,obj)},removeSubformItem:function(btn,subformName){var that=this;var btnData=$(btn).data();var token=btnData.token;var index=APP.utils.getIndexFromField(that.subformRows[subformName],"token",token);if(index==-1)return;if(APP.utils.isset(that.subformRows[subformName][index][that.sectionTarget.subforms[subformName].primary_key]))that.subformRows[subformName][index].stato="D";else that.subformRows[subformName].splice(index,1);var table=btn.parents("table").first().dataTable();var tr=btn.parents("tr");table.fnDeleteRow(tr[0])},createFormDialog:function(params){var that=this;var identifier=APP.utils.isset(params.token)?params.token:null;var enctype=APP.utils.isset(that.sectionTarget.subforms[params.subformName].enctype)?'enctype="'+that.sectionTarget.subforms[params.subformName].enctype+'"':"";var form=$('<form class="form-horizontal" '+enctype+' role="form"></form>');if(APP.utils.isset(APP.config.getToken)&&$.isFunction(APP.config.getToken))form.append('<input type="hidden" name="csrf_token" class="tokenInput subform" value="'+APP.config.getToken(params.subformName)+'">');params.div.html(form);$.each(that.sectionTarget.subforms[params.subformName].columns,function(j1,v){var required=APP.utils.isset(v.required)&&v.required?" required ":"";var inp=null;var valore="";var obj=null;if(params.type=="edit"||params.type=="show"){var index=APP.utils.getIndexFromField(that.subformRows[params.subformName],"token",identifier);if(index==-1)return;obj=that.subformRows[params.subformName][index];if(v.data_type=="integer"){if($.isArray(obj[v.name])){$.each(obj[v.name],function(ii,vv){var number=parseInt(vv);if(isNaN(number))number="";obj[v.name][ii]=number})}else{var number=parseInt(obj[v.name]);if(isNaN(number))number="";obj[v.name]=number}}valore=obj[v.name]}valore=APP.utils.isset(obj)&&APP.utils.isset(obj[v.name])?obj[v.name]:"";if(!APP.utils.isset(valore)||valore==="")valore=APP.utils.getSecondaryValue(v);if($.type(v.form_show)==="boolean"&&!v.form_show||$.isPlainObject(v.form_show)&&(!v.form_show.insert&&!APP.utils.isset(identifier)||!v.form_show.update&&APP.utils.isset(identifier)))return true;inp=APP.utils.getInputFormat(identifier,obj,required,params.subformName,that.sectionTarget.subforms[params.subformName],that,v,valore,null);inp.find(":input").addClass("subform");var displayOnOff=v.form_input_type=="hidden"?"style='display: none'":"";var ctrlGrp=$("<div class='form-group'>								<label class='control-label col-md-4' for='APP-"+v.name+"' "+displayOnOff+">"+v.label+":</label>								<div class='controls col-md-7' "+displayOnOff+"></div>								<div class='descrInput col-md-1'></div>							</div>");ctrlGrp.find(".controls").append(inp);if(APP.utils.isset(v.description))ctrlGrp.find(".descrInput").append($('<span id="description_'+v.name+'" data-toggle="tooltip" title="'+v.description+'" data-placement="auto" data-container="#subformContent" class="tooltipElement text-muted" style="padding-left: 5px"><i class="icon icon-info-sign"></i></span>'));form.append(ctrlGrp);if($.type(v.editable)==="boolean"&&!v.editable||$.isPlainObject(v.editable)&&(!v.editable.insert&&!APP.utils.isset(identifier)||!v.editable.update&&APP.utils.isset(identifier))||APP.utils.isset(identifier)&&$.inArray("update",that.sectionTarget.subforms[params.subformName].capabilities)===-1||!APP.utils.isset(identifier)&&$.inArray("insert",that.sectionTarget.subforms[params.subformName].capabilities)===-1)params.div.find("#APP-"+v.name).attr("disabled",true)})},formValidator:function(form,url,mtype){var that=this;var result=false;APP.utils.resetFormErrors(form);mtype=mtype==="add"?"PUT":mtype==="edit"?"POST":null;if(form.find(".textEditor").length>0)tinyMCE.triggerSave();if(APP.utils.isset(url)&&APP.utils.isset(mtype)){var d=form.serializeArray();form.find(":disabled").each(function(){if($(this).hasClass("fileupload"))return true;var o={};o.name=$(this).attr("name");o.value=$(this).val();d.push(o)});if(form.attr("enctype")==="multipart/form-data"){$.each(form.find(".fileupload"),function(){var n=$(this).attr("name");if(APP.utils.isset(n))d.push(APP.fileuploader.preserialize(n))})}$.ajax({type:mtype,url:url,data:d,async:false,success:function(data){if(!APP.utils.checkError(data.error,form)){result=true}else APP.utils.showErrMsg(data)},error:function(result){APP.utils.showErrMsg(result)}})}else{var inputs=$(form).find(":input");result=true;$.each(inputs,function(){var value=$(this).val();if(this.required&&(APP.utils.isEmptyString(value)||!APP.utils.isset(value))){result=false;APP.utils.renderError($(this),APP.i18n.translate("required_field"))}})}return result},onActionButtonClick:function(btn,div){var that=this;var data=btn.data();var type=btn.attr("name");var tkn=null;$("#modalSubform").find(".modal-title").html(APP.i18n.translate(type));var closeBtn=$('<button class="btn btn-default" type="button" data-dismiss="modal" aria-hidden="true">'+APP.i18n.translate("cancel")+"</button>");var savebtn=$('<button class="btn btn-primary" type="button"><i class="icon icon-ok"></i> '+APP.i18n.translate("apply")+"</button>");switch(type){case"add":tkn=that.sectionTarget.subforms[data.subformname].token;savebtn.click(function(){var form=$("#modalSubform").find("form");if(!that.formValidator(form,that.sectionTarget.subforms[data.subformname].subformValidationUrl,type))return;that.addSubformItem(form,div,data.subformname);$("#modalSubform").modal("hide")});break;case"edit":tkn=data.token;savebtn.click(function(){var form=$("#modalSubform").find("form");if(!that.formValidator(form,that.sectionTarget.subforms[data.subformname].subformValidationUrl,type))return;that.editSubformItem(form,$("#div_"+data.subformname),btn,data.subformname);$("#modalSubform").modal("hide")});break;case"show":tkn=data.token;savebtn.hide();break;case"remove":var btns=$('<button class="btn btn-primary" type="button" style="width: 60px">'+APP.i18n.translate("yes")+'</button><button class="btn btn-default" data-dismiss="modal" aria-hidden="true" style="width: 60px">'+APP.i18n.translate("no")+"</button>");var yesBtn=$(btns[0]);yesBtn.click(function(){that.removeSubformItem(btn,data.subformname);$("#defaultMessageDialog").modal("hide")});var deleteConfirmMsg=APP.utils.isset(that.sectionTarget.messages)&&APP.utils.isset(that.sectionTarget.messages["delete_confirm"])?that.sectionTarget.messages["delete_confirm"]:APP.i18n.translate("remove_confirm");APP.utils.showMsg({title:APP.i18n.translate("warning"),content:deleteConfirmMsg,buttons:btns});return;default:console.log("Aggiungi questo tipo: "+type)}$("#modalSubform").find(".modal-footer").html(savebtn);$("#modalSubform").find(".modal-footer").append(closeBtn);that.createFormDialog({div:$("#subformContent"),type:type,token:tkn,subformName:data.subformname});$("#modalSubform").one("shown.bs.modal",function(){APP.utils.setLookForm($("#subformContent").find("form"),null)});$("#modalSubform").modal("show")},showSubformTable:function(params){var that=this;that.sectionTarget=params.sectionTarget;var subformName=params.subformName;that.subformRows[subformName]=that.sectionTarget.subforms[subformName].values;if(!APP.utils.isset(that.sectionTarget.subforms)){alert("non e' settato l'array subforms in "+that.sectionTarget.resource);return}var s=$('<div id="div_'+subformName+'">						<div class="table-responsive">							<table name="'+subformName+'" class="table table-striped table-bordered table-hover datatable subformTable">								<thead><tr></tr></thead>								<tbody></tbody>							</table>						</div>						<div id="modalSubform" class="modal fade" role="dialog">							<div class="modal-dialog">								<div class="modal-content">									<div class="modal-header">										<button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>										<h4 class="modal-title"></h4>									</div>									<div class="modal-body" id="subformContent" ></div>									<div class="modal-footer"></div>								</div>							</div>						</div>					</div>');var div=$("#APP-"+subformName);if($.inArray("insert",that.sectionTarget.subforms[subformName].capabilities)>-1){var addSpan=$('<span id="add_'+subformName+'" name="add" data-subformname="'+subformName+'" class="btn btn-primary" style="margin-bottom: 20px; margin-right: 40px; float: left"><i class="icon-plus icon-white"></i> '+APP.i18n.translate("add")+"</span>");s.prepend(addSpan)}div.html(s);$("#modalSubform").modal({show:false});that.setActionButtonsClick(div,subformName);var thead=div.find("thead").find("tr");var tbody=div.find("tbody");var cols=[];var obj=that.sectionTarget.subforms[subformName];var valori={};$.each(obj.columns,function(i,v){if(!v.subform_table_show)return true;var suffix=v.foreign_mode=="multiselect"?"[]":"";if(APP.utils.isset(v.description)){var tthh=$('<th name="'+v.name+suffix+'" class="table-th" data-container="#APP-'+subformName+'" data-toggle="tooltip " data-placement="top" title="'+v.description+'">'+v.label+"</th>");tthh.tooltip();thead.append(tthh)}else thead.append('<th name="'+v.name+suffix+'" class="table-th">'+v.label+"</th>");if(!v.hasOwnProperty("foreign_key")&&v.form_input_type=="combobox")valori[v.name]=APP.utils.getForeignValue(v,null);cols.push(v)});thead.append("<th name='actions'>"+APP.i18n.translate("actions")+"</th>");if(APP.utils.isset(obj.values)){$.each(obj.values,function(i,v){var tr=$("<tr></tr>");tr.css("cursor","pointer");tr.data(v);$.each(cols,function(j,k){if(APP.utils.isset(k.foreign_key)){var fValues=APP.config.localConfig[k.foreign_key];var data=APP.utils.isset(v[k.name])?v[k.name]:[];var str="";if(!$.isArray(data))data=[data];$.each(data,function(x,y){y=!$.isPlainObject(y)?y:y[that.sectionTarget.subforms[subformName].primary_key];var oi=APP.utils.getIndexFromField(fValues,that.sectionTarget.subforms[subformName].primary_key,y);if(oi>-1)str+=APP.config.getValue(fValues[oi],k.foreign_toshow,k.foreign_toshow_params)+", "});str=str.substr(0,str.length-2);return true}if(k.form_input_type=="combobox"){var fValues=valori[k.name];var data=APP.utils.isset(v[k.name])?v[k.name]:[];var str="";if(!$.isArray(data))data=[data];$.each(data,function(x,y){y=!$.isPlainObject(y)?y:y[that.sectionTarget.subforms[subformName].primary_key];var oi=APP.utils.getIndexFromField(fValues,that.sectionTarget.subforms[subformName].primary_key,y);if(oi>-1)str+=APP.config.getValue(fValues[oi],k.foreign_toshow,k.foreign_toshow_params)+", "});str=str.substr(0,str.length-2);tr.append("<td class='table-td'>"+APP.utils.displayData(str,k)+"</td>");return true}if(!APP.utils.isset(v[k.name])){var str=APP.utils.getSecondaryValue(k);tr.append("<td class='table-td'>"+APP.utils.displayData(str,k)+"</td>");return true}if(k.form_input_type==="input"&&k.data_type==="file"){var tipo=APP.utils.isImageFile(v[k.name])?"image":null;var stringa="";switch(tipo){case"image":var tu=APP.utils.getThumbnailUrl(k.urls,v);if(tu)stringa='<img src="/'+tu+'" class="img-responsive img-thumbnail">';else stringa='<i class="icon icon-file-alt">'+v[k.name]+"</i>";break;default:stringa='<i class="icon icon-file-alt">'+v[k.name]+"</i>";break}tr.append("<td class='table-td'>"+stringa+"</td>");return true}tr.append("<td class='table-td'>"+APP.utils.displayData(v[k.name],k)+"</td>")});var tiddi=$("<td></td>");tiddi.append(that.generateActionButtonsString(that.sectionTarget.subforms[subformName].token,subformName));tr.append(tiddi);$.extend(v,{token:that.sectionTarget.subforms[subformName].token});that.sectionTarget.subforms[subformName].token++;that.setActionButtonsClick(tr,v);tbody.append(tr)})}if(APP.utils.isset(obj.sortable)&&obj.sortable===true)tbody.sortable({update:function(event,ui){var sfn=$(ui.item[0]).parents("table:first").attr("name");var sfrCopy=that.subformRows[sfn];if(sfrCopy.length===0)return;that.subformRows[sfn]=[];$.each(this.children,function(){var d=$(this).data();delete d["sortableItem"];var fieldKey=that.sectionTarget.subforms[sfn].primary_key;var elIndex=APP.utils.getIndexFromField(sfrCopy,fieldKey,d[fieldKey]);d.token=sfrCopy[elIndex].token;that.subformRows[sfn].push(d)})}});div.find(".datatable").dataTable({bRetrieve:true,bPaginate:false,bFilter:false,bSort:false,oLanguage:APP.utils.getDataTableLanguage()})}});$.extend(APP.anagrafica,{finish:function(){tinymce.remove(".textEditor");$("body").off("table_shown");APP.map.finish();APP.subforms.finish()},start:function(el,titolo,section,div){var that=this;this.windows=[];this.sections={};this.previousSection=null;this.currentSection=section;this.selectedItem=null;this.tmpSelectedItem=el;this.mainDiv=APP.utils.isset(div)?div:$("#"+section+"Container");$("body").one("table_shown",function(){});if(this.previousSection==null)this.previousSection=this.currentSection;this.createWindow();if(section==="home"){}else{this.processSectionsProperty({title:titolo,section:this.currentSection,filterString:APP.filter.getActiveFilterString(section),loadCallback:function(res){var obj={section:that.currentSection,items_per_page:res.data.items_per_page,tableContainer:that.windows[0].hide(),window:that.windows[0],oldWindow:that.windows[0],sort_fields:res.data.sort_fields,onSelectRow:function(t){that.onSelectTableRow(t,that.currentSection,that.windows[0])}};that.showTable(obj)}})}},createWindow:function(){var l=this.windows.length;var div=$("<div id='window_"+l+"'></div>");this.mainDiv.append(div);this.windows.push(div);if(l>0)this.toggleWindow(this.windows[this.windows.length-1],this.windows[l-1])},destroyWindow:function(){tinymce.remove(".textEditor");var l=this.windows.length;if(l>1)this.toggleWindow(this.windows[l-2],this.windows[l-1]);if(l>0){this.windows.pop();this.mainDiv.find("#window_"+this.windows.length).remove();APP.utils.updateBreadcrumb("remove")}this.finish()},toggleWindow:function(newDiv,oldDiv){oldDiv.hide();newDiv.show()},processSectionsProperty:function(params){var that=this;var section=params.section;var filterString=params.filterString;if(!this.sections.hasOwnProperty(section)){this.sections[section]=APP.utils.setBaseStructure(params.title,section);this.getStructure(APP.config.localConfig.urls["dStruct"]+"?tb="+this.sections[section].resource,section,filterString,params.loadCallback)}else this.loadData(APP.config.localConfig.urls[section]+filterString,that.sections[section],params.loadCallback)},getStructure:function(u,section,filterString,callback){var that=this;$.ajax({type:"GET",url:u,dataType:"json",success:function(data){if(!APP.utils.checkError(data.error,null)){that.loadStructure(data,that.sections[section]);if(!APP.utils.isset(APP.config.localConfig.urls[section])){alert("Inserire nel CONFIG l'url per la sezione "+section);return}else that.loadData(APP.config.localConfig.urls[section]+filterString,that.sections[section],callback)}else{APP.utils.showErrMsg(data)}},error:function(result){APP.utils.showErrMsg(result)}})},loadStructure:function(data,subSection){var that=this;var obj=APP.utils.isset(subSection)?subSection:that.sections[this.currentSection];$.each(data.data.fields,function(ii,vv){var o={name:ii,sortable:true};$.extend(o,vv);obj.columns.push(o)});$.extend(obj,data.data);delete obj.fields},loadData:function(u,target,callback){var that=this;if($.inArray("list",target.capabilities)>-1){$.ajax({type:"GET",url:u,success:function(result){if(result.status){if(APP.utils.isset(result.data)&&APP.utils.isset(target))target.values=result.data.items;if(APP.utils.isset(callback)&&$.isFunction(callback))callback(result)}else APP.utils.showErrMsg(result)},error:function(result){APP.utils.showErrMsg(result)}})}else APP.utils.showNoty({title:APP.i18n.translate("error"),type:"error",content:APP.i18n.translate("list_capability_denied")})},onSelectTableRow:function(t,subSection,contentDiv){var that=this;that.selectedItem=that.tmpSelectedItem;if(APP.utils.isset(that.sections[subSection].menu)){that.createWindow();that.showItem(t,that.windows[that.windows.length-1],that.windows[that.windows.length-2],subSection)}else{if(contentDiv.find("#subMainTableDiv").length>0){var arr=[{htmlString:'<a id="button_list" data-toggle="tooltip" data-placement="bottom" title="'+APP.i18n.translate("list")+'" class="btn btn-default btn-lg tooltipElement" href="#"><i class="icon-list"></i></a>',onClick:function(){that.selectedItem.click()}}];if($.inArray("update",that.sections[subSection].capabilities)>-1){arr.push({htmlString:'<a id="button_save" data-toggle="tooltip" data-placement="bottom" title="'+APP.i18n.translate("save")+'" class="btn btn-lg btn-success tooltipElement" href="#"><i class="icon-ok icon-white"></i></a>',onClick:function(){that.formSubmit(t[that.sections[subSection].primary_key],subSection,function(){that.finish();that.selectedItem.click()})}})}if($.inArray("delete",that.sections[subSection].capabilities)>-1){arr.push({htmlString:'<a id="button_remove" data-toggle="tooltip" data-placement="bottom" title="'+APP.i18n.translate("remove")+'" class="btn btn-lg btn-danger tooltipElement" href="#"><i class="icon-remove icon-trash"></i></a>',onClick:function(){that.removeItem(t[that.sections[subSection].primary_key],{section:subSection,contentDiv:contentDiv,callback:function(){that.selectedItem.click()}})}})}that.editItem(t[that.sections[subSection].primary_key],t,contentDiv.find("#subMainTableDiv"),subSection,arr)}else{that.createWindow();var arr=[];arr.push({htmlString:'<a id="button_cancel" data-toggle="tooltip" data-placement="bottom" title="'+APP.i18n.translate("cancel")+'" class="btn btn-default btn-lg tooltipElement" href="#"><i class="icon-arrow-left"></i></a>',onClick:function(){that.tmpSelectedItem=that.selectedItem;that.destroyWindow();that.selectedItem=APP.config.bc_getLastSrcElement()}});if($.inArray("update",that.sections[subSection].capabilities)>-1){arr.push({htmlString:'<a id="button_save" data-toggle="tooltip" data-placement="bottom" title="'+APP.i18n.translate("save")+'" class="btn btn-lg btn-success tooltipElement" href="#"><i class="icon-ok icon-white"></i></a>',onClick:function(){that.formSubmit(t[that.sections[subSection].primary_key],subSection,function(){that.finish();that.selectedItem.click()})}})}if(subSection=="administration_roles"){arr.push({htmlString:'<a id="button_capabilities" data-toggle="tooltip" data-placement="bottom" title="'+APP.i18n.translate("grid_mode")+'" class="btn btn-lg btn-info tooltipElement" href="#"><i class="icon-th"></i></a>',onClick:function(){that.showCapabilitiesGrid(t,[],that.windows[that.windows.length-1])}})}if($.inArray("delete",that.sections[subSection].capabilities)>-1){arr.push({htmlString:'<a id="button_remove" data-toggle="tooltip" data-placement="bottom" title="'+APP.i18n.translate("remove")+'" class="btn btn-lg btn-danger tooltipElement" href="#"><i class="icon-remove icon-trash"></i></a>',onClick:function(){that.removeItem(t[that.sections[subSection].primary_key],{section:subSection,contentDiv:contentDiv,callback:function(){that.selectedItem.click()}})}})}that.editItem(t[that.sections[subSection].primary_key],t,that.windows[that.windows.length-1],subSection,arr)}}},showCapabilitiesGrid:function(obj,permissions,parentDiv){var that=this;that.createWindow();var arr=[];arr.push({htmlString:'<a id="button_cancel" data-toggle="tooltip" data-placement="bottom" title="'+APP.i18n.translate("cancel")+'" class="btn btn-default btn-lg tooltipElement" href="#"><i class="icon-arrow-left"></i></a>',onClick:function(){that.destroyWindow()}});arr.push({htmlString:'<a id="button_save" data-toggle="tooltip" data-placement="bottom" title="'+APP.i18n.translate("save")+'" class="btn btn-lg btn-success tooltipElement" href="#"><i class="icon-ok icon-white"></i></a>',onClick:function(){that.finish();var activeButtons=that.windows[that.windows.length-1].find("button.active");var o={};$.each(activeButtons,function(i,v){o[$(v).text()]=true});$.ajax({type:"POST",url:"/jx/administration/aclroles/"+obj.id,data:o,dataType:"json",success:function(data){if(!APP.utils.checkError(data.error,null)){}else APP.utils.showErrMsg(data)},error:function(result){APP.utils.showErrMsg(result)}})}});var div=that.windows[that.windows.length-1];var mainButtonsRow=$('<div class="row" style="margin-bottom: 20px">									<div class="row col-md-6">										<div class="row">											<div class="col-md-4"></div>											<div class="col-md-8"></div>										</div>									</div>								</div>');$.each(arr,function(i,v){var str=$(v.htmlString);str.tooltip();str.css("margin-right","5px");str.click(function(){v.onClick($(this))});mainButtonsRow.find(".col-md-8").append(str)});div.append(mainButtonsRow);$.ajax({type:"GET",url:"/jx/administration/aclroles/"+obj.id,dataType:"json",success:function(data){if(!APP.utils.checkError(data.error,null)){var row=null;var colonne=4;$.each(data.data.items[0],function(i,v){if(i===0||i%colonne===0)row=$('<div class="row" style="height: 70px"></div>');$.each(v,function(j,k){var btnClass=k?"btn-success":"btn-danger";var active=k?"active":"";var button=$('<button type="button" class="btn btn-sm '+btnClass+" "+active+'">'+j+"</button>");button.click(function(){var btn=$(this);btn.toggleClass("active");btn.toggleClass("btn-success");btn.toggleClass("btn-danger")});var sp2=$('<div class="col-md-'+parseInt(12/colonne)+'"></div>');sp2.append(button);row.append(sp2);if(i%colonne===0||i===data.length-1)div.append(row)})})}else APP.utils.showErrMsg(data)},error:function(result){APP.utils.showErrMsg(result)}})},showTable:function(params){var that=this;var tableDiv=params.tableContainer;var section=APP.utils.isset(params.section)?params.section:this.currentSection;if(!APP.utils.isset(this.sections[section].values))return;var iDisplayLength=params.items_per_page===this.sections[section].values.length?APP.config.default_iDisplayLength:params.items_per_page;var contentDiv=APP.utils.isset(params.window)?params.window:tableDiv;var oldContentDiv=APP.utils.isset(params.oldWindow)?params.oldWindow:contentDiv;var onSelectRowCallback=APP.utils.isset(params.onSelectRow)&&$.isFunction(params.onSelectRow)?params.onSelectRow:function(){};var aaSorting=APP.utils.isset(params.sort_fields)?params.sort_fields:[[0,"desc"]];var table=$('<table class="table table-bordered table-striped table-hover datatable">							<thead>								<tr></tr>							</thead>							<tbody></tbody>						</table>');var thead=table.find("thead tr");var tbody=table.find("tbody");var cols=[];var dateboxFields=[];var datetimeboxFields=[];var valori={};$.each(this.sections[section].columns,function(i,v){if(!v.table_show)return true;if(APP.utils.isset(v.description)){var tthh=$('<th class="table-th" title="'+v.description+'">'+v.label+"</th>");tthh.tooltip({container:"#"+contentDiv.attr("id"),placement:"auto"});thead.append(tthh)}else thead.append('<th class="table-th">'+v.label+"</th>");if(!v.hasOwnProperty("foreign_key")&&v.form_input_type=="combobox"&&!APP.utils.isset(v.slave_of))valori[v.name]=APP.utils.getForeignValue(v,null);cols.push(v);if(v.form_input_type==="datebox"){dateboxFields.push(cols.length-1)}if(v.form_input_type==="datetimebox"){datetimeboxFields.push(cols.length-1)}});$.each(this.sections[section].values,function(i,v){var tr=$("<tr></tr>");tr.css("cursor","pointer");tr.data(v);tr.click(function(){APP.utils.toggleLoadingImage(true);var t=$(this).data();onSelectRowCallback(t)});$.each(cols,function(j,k){var classesAndStyles=APP.utils.getStyleByCssParams(k.name,v.css_params);if(APP.utils.isset(k.foreign_key)){var fValues=APP.config.localConfig[k.foreign_key];var data=APP.utils.isset(v[k.name])?v[k.name]:[];var str="";if(!$.isArray(data))data=[data];$.each(data,function(x,y){var primary_key=APP.utils.isset(k.primary_key)?k.primary_key:"id";y=!$.isPlainObject(y)?y:y[primary_key];var oi=APP.utils.getIndexFromField(fValues,primary_key,y);if(oi>-1)str+=APP.config.getValue(fValues[oi],k.foreign_toshow,k.foreign_toshow_params)+", "});str=str.substr(0,str.length-2);tr.append("<td class='table-td "+classesAndStyles[0]+"' style='"+classesAndStyles[1]+"'>"+APP.utils.displayData(str,k)+"</td>");return true}if(k.form_input_type=="combobox"){var fValues=valori[k.name];var data=APP.utils.isset(v[k.name])?v[k.name]:[];var str="";if(!$.isArray(data))data=[data];$.each(data,function(x,y){var primary_key=APP.utils.isset(k.primary_key)?k.primary_key:"id";y=!$.isPlainObject(y)?y:y[primary_key];var oi=APP.utils.getIndexFromField(fValues,primary_key,y);if(oi>-1)str+=APP.config.getValue(fValues[oi],k.foreign_toshow,k.foreign_toshow_params)+", "});str=str.substr(0,str.length-2);tr.append("<td class='table-td "+classesAndStyles[0]+"' style='"+classesAndStyles[1]+"'>"+APP.utils.displayData(str,k)+"</td>");return true}if(!APP.utils.isset(v[k.name])){var str=APP.utils.getSecondaryValue(k);tr.append("<td class='table-td "+classesAndStyles[0]+"' style='"+classesAndStyles[1]+"'>"+APP.utils.displayData(str,k)+"</td>");return true}tr.append("<td class='table-td "+classesAndStyles[0]+"' style='"+classesAndStyles[1]+"'>"+APP.utils.displayData(v[k.name],k)+"</td>")});tbody.append(tr)});var s=$("<div></div>");if($.inArray("insert",this.sections[section].capabilities)>-1)s.append('<button type="button" id="addItemButton_'+section+'" class="btn btn-primary"><i class="icon-plus"></i> '+APP.i18n.translate("add")+"</button>");if(this.sections[section].hasOwnProperty("filter")&&this.sections[section].filter){var btnClass=APP.filter.hasActiveFilter(section)?"btn-warning":"btn-default";s.append('<button type="button" id="filterButton_'+section+'" class="btn '+btnClass+'" style="margin-left: 5px"><i class="icon-search"></i> '+APP.i18n.translate("search")+"</button>")}if(s.children().length>0){s.css("margin-bottom",20)}tableDiv.empty();tableDiv.html(s);var tabResp=$('<div class="table-responsive"></div>');tabResp.append(table);tableDiv.append(tabResp);var cb=function(result){var ow=that.windows.length-2>=0?that.windows[that.windows.length-2]:that.windows[that.windows.length-1];var obj={section:section,tableContainer:ow.hide(),window:that.windows[that.windows.length-1],oldWindow:ow,items_per_page:result.data.items_per_page,sort_fields:result.data.sort_fields,onSelectRow:function(t){that.onSelectTableRow(t,section,that.windows[that.windows.length-1])
}};that.sections[section].values=result.data.items;that.showTable(obj)};tableDiv.find("table.datatable").dataTable({bProcessing:true,bRetrieve:true,bPaginate:true,sPaginationType:"full_numbers",iDisplayLength:iDisplayLength,aaSorting:aaSorting,bJQueryUI:false,aoColumnDefs:[{sType:"date-eu",aTargets:dateboxFields},{sType:"date-euro",aTargets:datetimeboxFields}],oLanguage:APP.utils.getDataTableLanguage(),fnDrawCallback:function(oSettings){tableDiv.fadeIn(APP.config.fadeInDelay);if(!!that.sections[section].filter)APP.filter.init(tableDiv.find("#filterButton_"+section).first(),section,cb)},fnInitComplete:function(oSettings,json){$("body").trigger("table_shown")}});tableDiv.find("#viewList_"+section).click(function(){that.showItem(t,tableDiv,that.windows[that.windows.length-1],section)});tableDiv.find("#addItemButton_"+section).click(function(){var t=null;var ot=contentDiv;that.selectedItem=that.tmpSelectedItem;if(tableDiv.attr("id")==="subMainTableDiv"){t=tableDiv}else{that.createWindow();t=that.windows[that.windows.length-1];ot=contentDiv}that.addItem(null,t,ot,section)})},addItem:function(dataObject,contentDiv,oldContentDiv,section){var that=this;var arr=[];if(contentDiv.attr("id")==="subMainTableDiv"){arr.push({htmlString:'<a id="button_list" data-toggle="tooltip" data-placement="bottom" title="'+APP.i18n.translate("list")+'" class="btn btn-default btn-lg tooltipElement" href="#"><i class="icon-th-list"></i></a>',onClick:function(){that.selectedItem.click()}});if($.inArray("insert",that.sections[section].capabilities)>-1){arr.push({htmlString:'<a id="button_save" data-toggle="tooltip" data-placement="bottom" title="'+APP.i18n.translate("save")+'" class="btn btn-lg btn-success tooltipElement" href="#"><i class="icon-ok icon-white"></i></a>',onClick:function(){that.formSubmit(null,section,function(){that.finish();that.selectedItem.click()})}})}}else{arr.push({htmlString:'<a id="button_cancel" data-toggle="tooltip" data-placement="bottom" title="'+APP.i18n.translate("cancel")+'" class="btn btn-default btn-lg tooltipElement" href="#"><i class="icon-arrow-left"></i></a>',onClick:function(){that.tmpSelectedItem=that.selectedItem;that.destroyWindow();that.selectedItem=APP.config.bc_getLastSrcElement()}});if($.inArray("insert",that.sections[section].capabilities)>-1){arr.push({htmlString:'<a id="button_save" data-toggle="tooltip" data-placement="bottom" title="'+APP.i18n.translate("save")+'" class="btn btn-lg btn-success tooltipElement" href="#"><i class="icon-ok icon-white"></i></a>',onClick:function(){that.formSubmit(null,section,function(){that.finish();that.selectedItem.click()})}})}}this.editItem(null,dataObject,contentDiv,section,arr)},showItem:function(data,contentDiv,oldContentDiv,section){var that=this;var title="-";if(APP.utils.isset(this.sections[section].title)&&APP.utils.isset(this.sections[section].title.title_toshow)){title=this.sections[section].title.title_toshow;$.each(this.sections[section].title.title_toshow_params,function(ii,vv){title=APP.utils.replaceAll(ii,data[vv],title)})}var div=$('<div class="row" style="margin-bottom: 20px">						<div class="col-md-9 col-md-offset-3">							<ul class="breadcrumb"></ul>						</div>					</div>					<div class="row">						<div class="col-md-3">							<div class="row" style="margin-bottom: 20px">								<div class="col-xs-3">									<a id="button_cancel" data-toggle="tooltip" data-placement="bottom" title="'+APP.i18n.translate("cancel")+'" class="btn btn-default btn-lg tooltipElement" href="#"><i class="icon-arrow-left"></i></a>								</div>								<div class="col-xs-9">									<h1 class="text-danger" style="padding: 0px; margin: 0px"><strong>'+title+'</strong></h1>								</div>							</div>							<div class="row">								<div class="col-md-12">									<ul id="itemsRecipient" class="list-group">									</ul>								</div>							</div>						</div>						<div class="col-md-9">							<div id="subMainTableDiv"></div>						</div>					</div>');var items=APP.utils.isset(that.sections[section].menu)?that.sections[section].menu:[];var ul=div.find("ul.list-group");$.each(items,function(i,v){var leftIcon=APP.utils.isset(v.icon)?'<i class="icon icon-'+v.icon+' pull-left" style="margin-top: 1px; margin-right: 10px"></i>':"";var li=$('<li class="list-group-item">							'+leftIcon+'<i class="icon icon-chevron-right pull-right"></i> '+APP.i18n.translate(v.label)+"						</li>");li.data(v);li.click(function(){var actualLi=$(this);var dataLi=actualLi.data();var smtd=that.windows[that.windows.length-1].find("#subMainTableDiv").first();smtd.hide();that.tmpSelectedItem=$(this);APP.config.removeActiveClasses(div.find(".list-group"),"li");actualLi.addClass("active");var arr=[];if($.inArray("update",that.sections[section].capabilities)>-1){arr.push({htmlString:'<a id="button_save" data-toggle="tooltip" data-placement="bottom" title="'+APP.i18n.translate("save")+'" class="btn btn-lg btn-success tooltipElement" href="#"><i class="icon-ok icon-white"></i></a>',onClick:function(){that.formSubmit(data[that.sections[section].primary_key],section,function(){that.selectedItem=APP.config.bc_getLastSrcElement();that.destroyWindow();if(that.windows.length===1)oldContentDiv.empty();that.selectedItem.click()})}})}if($.inArray("delete",that.sections[section].capabilities)>-1){arr.push({htmlString:'<a id="button_remove" data-toggle="tooltip" data-placement="bottom" title="'+APP.i18n.translate("remove")+'" class="btn btn-lg btn-danger tooltipElement" href="#"><i class="icon-remove icon-trash"></i></a>',onClick:function(){that.removeItem(data[that.sections[section].primary_key],{section:section,contentDiv:contentDiv,callback:function(){that.selectedItem=APP.config.bc_getLastSrcElement();that.destroyWindow();if(that.windows.length===1)oldContentDiv.empty();that.selectedItem.click()}})}})}switch(dataLi.url){case null:that.editItem(data[that.sections[section].primary_key],data,contentDiv.find("#subMainTableDiv"),section,arr);break;default:var subSection=null;var uuu=dataLi.url.split("?")[0];$.each(APP.config.localConfig.urls,function(i,v){if(uuu===v)subSection=i});if(!APP.utils.isset(subSection)){alert("Aggiungi alla voce urls della richiesta config: "+dataLi.url);return}var uri=dataLi.url;$.each(dataLi.url_params,function(ii,vv){uri=APP.utils.replaceAll(ii,data[vv],uri)});that.processSectionsProperty({title:APP.i18n.translate(dataLi.label),section:subSection,filterString:"?"+uri.split("?")[1],loadCallback:function(res){var obj={section:subSection,items_per_page:res.data.items_per_page,sort_fields:res.data.sort_fields,tableContainer:contentDiv.find("#subMainTableDiv").hide(),window:contentDiv,oldWindow:oldContentDiv,onSelectRow:function(t){that.onSelectTableRow(t,subSection,contentDiv)}};that.showTable(obj)}})}});ul.append(li)});contentDiv.html(div);APP.utils.updateBreadcrumb("add",{icon:that.sections[section].icon,label:title,data:data,level:section,srcElement:that.selectedItem});ul.find("li").first().click();contentDiv.find("#button_cancel").tooltip().click(function(){that.tmpSelectedItem=that.selectedItem;that.destroyWindow();that.selectedItem=APP.config.bc_getLastSrcElement()})},editItem:function(id,dataObject,contentDiv,section,buttons){var that=this;contentDiv=APP.utils.isset(contentDiv)?contentDiv:that.windows[that.windows.length-1];contentDiv.html(this.createFormTemplate(id,dataObject,this.sections[section],section,buttons));contentDiv.show();var form=contentDiv.find("#fm_"+section);if(form.find("div.mapbox").length>0){var ddd=form.find("div.mapbox");APP.map.setMap({container:ddd});var index=APP.utils.getIndexFromField(this.sections[this.currentSection].columns,"form_input_type","mapbox");if(index>-1){if(APP.utils.isset(APP.map.globalData[APP.map.currentMapId].drawnItems))APP.map.globalData[APP.map.currentMapId].map.removeLayer(APP.map.globalData[APP.map.currentMapId].drawnItems);APP.map.globalData[APP.map.currentMapId].drawnItems=new L.FeatureGroup;APP.map.globalData[APP.map.currentMapId].map.addLayer(APP.map.globalData[APP.map.currentMapId].drawnItems);var obj=this.sections[this.currentSection].columns[index];if(obj.map_box_editing){var opt={draw:{polyline:false,polygon:false,circle:false,marker:false,rectangle:false},edit:{featureGroup:APP.map.globalData[APP.map.currentMapId].drawnItems,edit:obj.editable}};$.each(obj.map_box_editing_geotype,function(i,v){opt.draw[v]={title:APP.i18n.translate(v)}});APP.map.toggleDrawEditor(APP.map.currentMapId,true,opt);APP.map.globalData[APP.map.currentMapId].map.on("draw:created",function(e){var type=e.layerType;var layer=e.layer;{APP.map.globalData[APP.map.currentMapId].drawnItems.addLayer(layer)}});APP.map.globalData[APP.map.currentMapId].map.on("draw:edited",function(e){console.log("imposta l'evento draw:edited")});APP.map.globalData[APP.map.currentMapId].map.on("draw:deleted",function(o){$.each(o.layers.getLayers(),function(ij,vj){APP.map.globalData[APP.map.currentMapId].drawnItems.removeLayer(vj)})})}if(obj.map_box_fileloading){var options_eraseall={layer:APP.map.globalData[APP.map.currentMapId].drawnItems};APP.map.globalData[APP.map.currentMapId].eraseAllControl=new L.Control.EraseALL(options_eraseall);APP.map.globalData[APP.map.currentMapId].map.addControl(APP.map.globalData[APP.map.currentMapId].eraseAllControl);L.Control.FileLayerLoad.LABEL='<i class="icon-folder-open"></i>';var control=L.Control.fileLayerLoad({fitBounds:true,layerOptions:{pointToLayer:function(data,latlng){return L.circleMarker(latlng)}}}).addTo(APP.map.globalData[APP.map.currentMapId].map);control.loader.on("data:loaded",function(e){var ttt=arguments;APP.map.globalData[APP.map.currentMapId].drawnItems.addLayer(e.layer)})}var inp=form.find("input.mapbox");if(inp.length>0&&inp.val()!=""){if(!APP.map.globalData[APP.map.currentMapId].map.hasLayer(APP.map.globalData[APP.map.currentMapId].drawnItems)){APP.map.globalData[APP.map.currentMapId].drawnItems=new L.FeatureGroup;APP.map.globalData[APP.map.currentMapId].map.addLayer(APP.map.globalData[APP.map.currentMapId].drawnItems)}var value=inp.val();var gj=new L.geoJson($.parseJSON(value),{onEachFeature:function(feature,layer){if($.isArray(feature.geometries)){$.each(feature.geometries,function(ij,vj){APP.map.globalData[APP.map.currentMapId].drawnItems.addLayer(L.GeoJSON.geometryToLayer(vj))})}else APP.map.globalData[APP.map.currentMapId].drawnItems.addLayer(L.GeoJSON.geometryToLayer(feature))},pointToLayer:function(data,latlng){return L.circleMarker(latlng)}});APP.map.globalData[APP.map.currentMapId].map.fitBounds(APP.map.globalData[APP.map.currentMapId].drawnItems.getBounds())}}}APP.utils.setLookForm(form,id)},deactiveItem:function(id,section,contentDiv){var that=this;var deactiveConfirmMsg=APP.utils.isset(that.sections[section].messages)&&APP.utils.isset(that.sections[section].messages["deactive_confirm"])?that.sections[section].messages["deactive_confirm"]:APP.i18n.translate("off_confirm");APP.utils.showMsg({title:APP.i18n.translate("warning"),content:deactiveConfirmMsg,buttons:[{text:APP.i18n.translate("yes"),click:function(){$.ajax({type:"POST",url:APP.config.localConfig.urls[section]+"/"+id,data:{attivato:false},success:function(data){that.loadData(APP.config.localConfig.urls[section],that.sections[section])},error:function(result){APP.utils.showErrMsg(result)}});$(this).parents(".modal").first().modal("hide")}},{text:APP.i18n.translate("no"),click:function(){$(this).parents(".modal").first().modal("hide")}}]})},activeItem:function(id,section,contentDiv){var that=this;var activeConfirmMsg=APP.utils.isset(that.sections[section].messages)&&APP.utils.isset(that.sections[section].messages["active_confirm"])?that.sections[section].messages["active_confirm"]:APP.i18n.translate("on_confirm");APP.utils.showMsg({title:APP.i18n.translate("warning"),content:activeConfirmMsg,buttons:[{text:APP.i18n.translate("yes"),click:function(){$.ajax({type:"POST",url:APP.config.localConfig.urls[section]+"/"+id,data:{attivato:true},success:function(data){that.loadData(APP.config.localConfig.urls[section],that.sections[section])},error:function(result){APP.utils.showErrMsg(result)}});$(this).parents(".modal").first().modal("hide")}},{text:APP.i18n.translate("no"),click:function(){$(this).parents(".modal").first().modal("hide")}}]})},createFormTemplate:function(identifier,dataObject,sectionTarget,sectionLabel,buttons){var that=this;var obj={};var index=null;if(APP.utils.isset(identifier)){{index=APP.utils.getIndexFromField(sectionTarget.values,sectionTarget.primary_key,identifier);if(index>-1)obj=sectionTarget.values[index]}}else{obj=APP.utils.isset(dataObject)?dataObject:obj}var enctype=APP.utils.isset(sectionTarget.enctype)?'enctype="'+sectionTarget.enctype+'"':"";var form=null;var v=null;var position=null;var displayInputs=function(k,parNode){$.each(k.fields,function(j1,k1){var index=APP.utils.getIndexFromField(sectionTarget.columns,"name",k1);if(index==-1)return true;var v=sectionTarget.columns[index];var valore=APP.utils.isset(obj[v.name])?obj[v.name]:"";if(!APP.utils.isset(valore)||valore==="")valore=APP.utils.getSecondaryValue(v);if($.type(v.form_show)==="boolean"&&!v.form_show||$.isPlainObject(v.form_show)&&(!v.form_show.insert&&!APP.utils.isset(identifier)||!v.form_show.update&&APP.utils.isset(identifier)))return true;var required=APP.utils.isset(v.required)?" required ":"";var displayOnOff=v.form_input_type=="hidden"?"style='display: none'":"";var inp=null;if(APP.utils.isset(v.scrollto_button)){var str=$('<a data-toggle="tooltip" data-placement="bottom" title="'+v.label+'" class="btn btn-lg btn-default tooltipElement" href="#"><i class="icon '+v.scrollto_button.icon+'"></i></a>');str.click(function(){$("html, body").animate({scrollTop:form.find("#APP-"+v.name).first().offset().top-60},1e3)});fb.append(str)}inp=APP.utils.getInputFormat(identifier,obj,required,sectionLabel,sectionTarget,that,v,valore,form);if(inp===null)return true;var spanValues=null;if(APP.utils.isset(sectionTarget.cols_relation))spanValues=sectionTarget.cols_relation;else spanValues=APP.utils.isset(position)&&position==="blockColForm"?[2,9,1]:[2,9,1];var myFieldLabel=APP.utils.isset(v.label)?v.label+":":"";var ctrlGrp=$("<div class='form-group' style=''>									<label class='control-label col-md-"+spanValues[0]+"' for='APP-"+v.name+"' "+displayOnOff+">"+(v.required?APP.utils.getRequiredSymbol():"")+myFieldLabel+"</label>									<div class='controls col-md-"+spanValues[1]+"' "+displayOnOff+"></div>									<div class='descrInput col-md-"+spanValues[2]+"'></div>								</div>");var cssClass=APP.utils.isset(v.css_class)?v.css_class:"";ctrlGrp.addClass(cssClass);ctrlGrp.find(".controls").append(inp);if(APP.utils.isset(v.description))ctrlGrp.find(".descrInput").append($('<span id="description_'+v.name+'" data-toggle="tooltip" title="'+v.description+'" data-placement="auto" data-container="body" class="tooltipElement text-muted" style="padding-left: 5px"><i class="icon icon-info-sign"></i></span>'));parNode.append(ctrlGrp);if($.type(v.editable)==="boolean"&&!v.editable||$.isPlainObject(v.editable)&&(!v.editable.insert&&!APP.utils.isset(identifier)||!v.editable.update&&APP.utils.isset(identifier))||APP.utils.isset(identifier)&&$.inArray("update",sectionTarget.capabilities)===-1||!APP.utils.isset(identifier)&&$.inArray("insert",sectionTarget.capabilities)===-1){if(parNode.find("#APP-"+v.name).is(":input"))parNode.find("#APP-"+v.name).attr("disabled",true);else parNode.find("#APP-"+v.name).find(":input").attr("disabled",true)}if(APP.utils.isset(v.send_with_file)&&v.send_with_file)parNode.find("#APP-"+v.name).addClass("sendWithFile")})};if(!APP.utils.isset(sectionTarget.groups)||sectionTarget.groups.length===0){sectionTarget.groups=[{name:sectionLabel,position:"left",fields:[]}];$.each(sectionTarget.columns,function(i,v){sectionTarget.groups[0].fields.push(v.name)})}if(APP.utils.isset(sectionTarget.wizard_mode)&&sectionTarget.wizard_mode===true&&sectionTarget.groups.length>1){form=$('<form id="fm_'+sectionLabel+'" class="form-horizontal wizard" '+enctype+' role="form"></form>');form.prepend('<p id="formButtons" class="row" style="margin-bottom: 30px; padding-left: 15px; display: none"></p>');$.each(buttons,function(i,v){var str=$(v.htmlString);if(str.attr("id")==="button_save"){form.on("wizardfinish",function(){v.onClick($(this))});return true}str.css("margin-right",7);str.click(function(){v.onClick($(this))});form.find("#formButtons").append(str)});$.each(sectionTarget.groups,function(j,k){var step=$("<fieldset>								<legend>"+APP.i18n.translate(k.name)+"</legend>							</fieldset>");form.append(step);displayInputs(k,step);form.data({jWizardSettings:{buttons:{cancel:false,next:{"class":"btn btn-primary",text:APP.i18n.translate("next"),type:"button"},prev:{"class":"btn btn-default",text:APP.i18n.translate("previous"),type:"button"},finish:{"class":"btn btn-success",text:APP.i18n.translate("done"),type:"button"}},allButtons:buttons,effects:{steps:{hide:{effect:"blind",direction:"right",duration:250},show:{effect:"fade",direction:"right",duration:250}}},wizardfinish:function(){}}})});form.find("fieldset").first().append('<input type="hidden" name="csrf_token" class="tokenInput" value="'+APP.config.getToken(sectionTarget.resource)+'">');return form}var form=$('<form id="fm_'+sectionLabel+'" class="form-horizontal" '+enctype+' role="form">						<input type="hidden" name="csrf_token" class="tokenInput" value="'+APP.config.getToken(sectionTarget.resource)+'">						<div class="row">							<div id="leftColForm" class="col-md-6">								<div class="row">									<div id="formButtons" class="col-md-offset-4" style="margin-bottom: 30px; padding-left: 15px"></div>								</div>							</div>							<div id="rightColForm" class="col-md-6"></div>						</div>						<div class="row">							<div id="blockColForm" class="col-md-12"></div>						</div>					</form>');var fb=form.find("#formButtons");$.each(buttons,function(i,v){var str=$(v.htmlString);str.click(function(){v.onClick($(this))});fb.append(str)});$.each(sectionTarget.groups,function(j,k){var group=$('<fieldset style="padding-bottom: 22px">								<legend class="text-info">'+APP.i18n.translate(k.name)+"</legend>							</fieldset>");position="leftColForm";if(APP.utils.isset(k.position)){switch(k.position){case"left":position="leftColForm";break;case"right":position="rightColForm";break;case"block":position="blockColForm";break;default:console.log("aggiungi questa posizione: "+k.position)}}form.find("#"+position).append(group);displayInputs(k,group)});return form},formSubmit:function(id,section,endCallBack){var form=$("#fm_"+section);APP.utils.resetFormErrors(form);var that=this;var mtype=APP.utils.isset(id)?"POST":"PUT";var queue=APP.utils.isset(id)?"/"+id:"";if(form.find(".textEditor").length>0)tinyMCE.triggerSave();var d=form.serializeArray();form.find(":input:disabled ").each(function(){if($(this).hasClass("fileupload")||$(this).hasClass("subform")||$(this).hasClass("multifield")||!APP.utils.isset($(this).attr("name"))||$(this).hasClass("mapbox"))return true;var o={};o.name=$(this).attr("name");o.value=$(this).val();d.push(o)});if(form.attr("enctype")=="multipart/form-data"){$.each(form.find(".fileupload"),function(){var n=$(this).attr("name");if(APP.utils.isset(n))d.push(APP.fileuploader.preserialize(n))})}if(form.find(".subformTable").length>0){$.each(form.find(".subformTable"),function(){var sfn=$(this).attr("name");d.push(APP.subforms.preserialize(sfn))})}if(form.find(".multifieldTable").length>0){$.each(form.find(".multifieldTable"),function(){var sfn=$(this).attr("name");d.push(APP.multifields.preserialize(sfn));var items=d[d.length-1].value.split(";");var uguaglianze=items[0].split("&");var namesArray=[];$.each(uguaglianze,function(i,v){var voce=v.split("=")[0];namesArray.push(voce)});var elemsToDelete=[];$.each(d,function(i,v){if($.inArray(v.name,namesArray)>-1)elemsToDelete.push(parseInt(i))});elemsToDelete.sort(function(a,b){return b-a});$.each(elemsToDelete,function(i,number){d.splice(number,1)})})}if(form.find(":input.mapbox").length>0){$.each(form.find(":input.mapbox"),function(i,v){var name=$(v).attr("name");var index=APP.utils.getIndexFromField(d,"name",name);if(index===-1)return true;d[index]=APP.map.preserialize(name)})}var sendNow=function(){$.ajax({type:mtype,url:APP.config.localConfig.urls[section]+queue,data:d,success:function(data){if(!APP.utils.checkError(data.error,form)){APP.utils.showNoty({title:APP.i18n.translate("success"),type:"success",content:APP.i18n.translate("operation_success")});if(APP.utils.isset(data.data.actions)){$.each(data.data.actions,function(j,k){switch(j){case"reinsert":var labels={yes:APP.i18n.translate("Yes"),no:'<i class="icon icon-remove"></i> '+APP.i18n.translate("No")};var callbacks={yes:function(){var newDiv=null;var oldDiv=null;that.destroyWindow();if(that.windows[that.windows.length-1].find("#subMainTableDiv").length>0){newDiv=that.windows[that.windows.length-1].find("#subMainTableDiv").first();oldDiv=that.windows[that.windows.length-1]}else{that.createWindow();newDiv=that.windows[that.windows.length-1];oldDiv=that.windows.length-2<0?0:that.windows.length-2}that.addItem(k,newDiv,oldDiv,section)},no:function(){defaultCallback()}};APP.utils.confirmMsg(APP.i18n.translate("reinsert_question"),labels,callbacks);break;default:break}})}else{if(APP.utils.isset(endCallBack)&&$.isFunction(endCallBack))endCallBack();else{that.selectedItem.click()}}}else APP.utils.showErrMsg(data)},error:function(result){APP.utils.showErrMsg(result)}})};var labels={yes:APP.i18n.translate("save"),no:APP.i18n.translate("cancel")};var callbacks={yes:function(){sendNow()},no:null};var saveConfirmMsg=APP.utils.isset(that.sections[section].messages)&&APP.utils.isset(that.sections[section].messages["save_confirm"])?that.sections[section].messages["save_confirm"]:APP.i18n.translate("save_confirm");APP.utils.confirmMsg(saveConfirmMsg,labels,callbacks)},removeItem:function(id,params){var that=this;var btns=$('<button class="btn btn-primary" type="button">'+APP.i18n.translate("yes")+'</button><button class="btn btn-default" data-dismiss="modal" aria-hidden="true">'+APP.i18n.translate("no")+"</button>");var yesBtn=$(btns[0]);yesBtn.click(function(){$.ajax({type:"DELETE",url:APP.config.localConfig.urls[params.section]+"/"+id,data:params.contentDiv.find("#fm_"+params.section).serializeArray(),success:function(data){if(!APP.utils.checkError(data.error,null)){params.callback()}else APP.utils.showErrMsg(data)},error:function(result){APP.utils.showErrMsg(result)}});$(this).parents(".modal").first().modal("hide")});var deleteConfirmMsg=APP.utils.isset(that.sections[params.section].messages)&&APP.utils.isset(that.sections[params.section].messages["delete_confirm"])?that.sections[params.section].messages["delete_confirm"]:APP.i18n.translate("remove_confirm");APP.utils.showMsg({title:APP.i18n.translate("warning"),content:deleteConfirmMsg,buttons:btns})}});$.extend(APP.multifields,{sectionTarget:null,multifieldRows:{},finish:function(){this.multifieldRows={}},setTooltips:function(div){div.find(".icon-eye-open").parents("button").first().tooltip({title:APP.i18n.translate("show")});div.find(".icon-pencil").parents("button").first().tooltip({title:APP.i18n.translate("edit")});div.find(".icon-trash").parents("button").first().tooltip({title:APP.i18n.translate("remove")});div.find(".icon-lock").parents("button").first().tooltip({title:APP.i18n.translate("off")});div.find(".icon-off").parents("button").first().tooltip({title:APP.i18n.translate("on")})},generateActionButtonsString:function(i,multifieldName){var that=this;var str=$('<div class="actionButtonsString"></div>');str.css("white-space","nowrap");if($.inArray("update",that.sectionTarget.multifields[multifieldName].capabilities)>-1)str.append("<button type='button' id='edit_"+i+"' data-multifieldname='"+multifieldName+"' name='edit' class='btn btn-default' ><i class='icon-pencil'></i></button>");else str.append("<button type='button' id='show_"+i+"' data-multifieldname='"+multifieldName+"' name='show' class='btn btn-default' ><i class='icon-eye-open'></i></button>");if($.inArray("delete",that.sectionTarget.multifields[multifieldName].capabilities)>-1)str.append("<button type='button' id='remove_"+i+"' data-multifieldname='"+multifieldName+"' name='remove' class='btn btn-danger' ><i class='icon-trash'></i></button>");return str.html()},validation:function(param,i,v){var nameAndIndexArray=i.split("-row");if(nameAndIndexArray.length===1)return true;el=param.find('[id="APP-'+nameAndIndexArray[0]+'"]');el=$(el[parseInt(nameAndIndexArray[1])]);var span='<span class="help-block"><small>'+v+"</small></span>";var cgd=el.parents("div").first();cgd.addClass("has-error");var hi=cgd.find(".help-block");if(hi.length>0)hi.html(span);else{if(el.is(":radio"))el.parents("div:first").append(span);else el.after(span)}},preserialize:function(multifieldName){var that=this;var fromServer=that.multifieldRows[multifieldName];fromServer=APP.utils.isset(fromServer)?fromServer:[];that.multifieldRows[multifieldName]=[];$("#APP-"+multifieldName).find(".has-error").removeClass("has-error");$.each($("#APP-"+multifieldName).find("table tbody tr"),function(){var obj={};$.each($(this).find(":input"),function(){obj[$(this).attr("name")]=$(this).val()});if($.isEmptyObject(obj))return true;obj.stato=obj.id?"U":"I";that.multifieldRows[multifieldName].push(obj);that.sectionTarget.multifields[multifieldName].token++});$.each(fromServer,function(i,v){var myIndex=APP.utils.getIndexFromField(that.multifieldRows[multifieldName],"id",""+v.id);if(myIndex===-1){v.stato="D";that.multifieldRows[multifieldName].push(v)}});var str="";$.each(that.multifieldRows[multifieldName],function(){str+=$.param(this)+";"});str=str.substr(0,str.length-1);return{name:multifieldName,value:str}},setActionButtonsClick:function(recipient,params){var that=this;var buttons=recipient.find(".btn");$.each(buttons,function(i,v){$(v).data(params);$(v).click(function(){that.onActionButtonClick($(this),recipient)})});that.setTooltips(recipient)},addMultifieldItem:function(form,tableDiv,multifieldName){var that=this;var table=tableDiv.find(".datatable").dataTable();var serializedData=form.serializeArray();var data={};var ths=table.find("th");$.each(ths,function(i,v){data[$(v).attr("name")]=""});var obj={};$.each(form.find(":input").not(":button"),function(i,v){switch(v.tagName){case"SELECT":var t=$(v.selectedOptions);var value="";var text="";$.each(t,function(ii,vv){value+=$(vv).val()+",";text+=$(vv).text()+"<br><br>"});value=value.substr(0,value.length-1);text=text.substr(0,text.length-8);var name=$(v).attr("name");data[name]=text;break;case"INPUT":case"TEXTAREA":var name=$(v).attr("name");if(!APP.utils.isset(name)||name=="")break;if($(v).hasClass("fileupload")){var value="";$.each(APP.fileuploader.myFiles,function(ii,vv){if(vv.stato==="D")return true;if(vv.type.split("/")[0]==="image")value+='<img src="'+vv.thumbnail_url+'" alt="">|';else value+='<i class="icon icon-file-alt"></i>'+vv[APP.fileuploader.inputName]+"|"});value=value.substr(0,value.length-1);data[APP.fileuploader.inputName]=APP.utils.replaceAll("|","<br>",value);obj[APP.fileuploader.inputName]=APP.fileuploader.myFiles[APP.fileuploader.myFiles.length-1][APP.fileuploader.inputName];break}var value=$(v).val();data[name]=value;break;default:console.log("Aggiungi questo tagName: "+v.tagName)}});data.actions=that.generateActionButtonsString(that.sectionTarget.multifields[multifieldName].token,multifieldName);var dataArr=[];$.each(data,function(i,v){dataArr.push(v)});var newRowIndex=table.fnAddData(dataArr);$(table.find("tbody").find("tr")[newRowIndex[0]]).find("td").addClass("table-td");$.each(serializedData,function(i,v){if(v.name.substr(v.name.length-2)=="[]"){var name=v.name.substr(0,v.name.length-2);if(!$.isArray(obj[name]))obj[name]=[];obj[name].push(v.value)}else obj[v.name]=v.value});$.extend(obj,{token:that.sectionTarget.multifields[multifieldName].token,stato:"I"});if(!APP.utils.isset(that.multifieldRows[multifieldName]))that.multifieldRows[multifieldName]=[];that.multifieldRows[multifieldName].push(obj);that.setActionButtonsClick($(table.find("tbody").find("tr")[newRowIndex[0]]),obj);that.sectionTarget.multifields[multifieldName].token++},editMultifieldItem:function(form,tableDiv,btn,multifieldName){var that=this;var table=tableDiv.find(".datatable").dataTable();var serializedData=form.serializeArray();var tr=btn.parents("tr");var data={};var ths=table.find("th");$.each(ths,function(i,v){data[$(v).attr("name")]=""});var obj={};$.each(form.find(":input").not(":button"),function(i,v){switch(v.tagName){case"SELECT":var t=$(v.selectedOptions);var value="";var text="";$.each(t,function(ii,vv){value+=$(vv).val()+",";text+=$(vv).text()+"<br><br>"});value=value.substr(0,value.length-1);text=text.substr(0,text.length-8);var name=$(v).attr("name");data[name]=text;break;case"INPUT":case"TEXTAREA":var name=$(v).attr("name");if(!APP.utils.isset(name)||name=="")break;if($(v).hasClass("fileupload")){var value="";$.each(APP.fileuploader.myFiles,function(ii,vv){if(vv.stato==="D")return true;if(vv.type){if(vv.type.split("/")[0]==="image")value+='<img src="'+vv.thumbnail_url+'" alt="">|';else value+='<i class="icon icon-file-alt"></i>'+vv[APP.fileuploader.inputName]+"|"}else{if(APP.utils.isImageFile(vv[APP.fileuploader.inputName])){var index=APP.utils.getIndexFromField(that.sectionTarget.multifields[multifieldName].columns,"name",APP.fileuploader.inputName);var tu=APP.utils.getThumbnailUrl(that.sectionTarget.multifields[multifieldName].columns[index].urls,vv);if(tu)value+='<img src="'+tu+'" alt="">|';else value+='<i class="icon icon-file-alt"></i>'+vv[APP.fileuploader.inputName]+"|"}else value+='<i class="icon icon-file-alt"></i>'+vv[APP.fileuploader.inputName]+"|"}});value=value.substr(0,value.length-1);data[APP.fileuploader.inputName]=APP.utils.replaceAll("|","<br>",value);obj[APP.fileuploader.inputName]=APP.fileuploader.myFiles[APP.fileuploader.myFiles.length-1][APP.fileuploader.inputName];break}var value=$(v).val();data[name]=value;break;default:console.log("Aggiungi questo tagName: "+v.tagName)}});$.each(serializedData,function(i,v){if(v.name.substr(v.name.length-2)=="[]"){var name=v.name.substr(0,v.name.length-2);if(!$.isArray(obj[name]))obj[name]=[];obj[name].push(v.value)}else obj[v.name]=v.value});var btnData=btn.data();obj.stato=APP.utils.isset(btnData[that.sectionTarget.multifields[multifieldName].primary_key])?"U":btnData.stato;obj.token=btnData.token;var index=APP.utils.getIndexFromField(that.multifieldRows[multifieldName],"token",obj.token);if(index==-1)return;$.extend(that.multifieldRows[multifieldName][index],obj);data.actions=that.generateActionButtonsString(obj.token,multifieldName);var dataArr=[];$.each(data,function(i,v){dataArr.push(v)});table.fnUpdate(dataArr,tr[0]);that.setActionButtonsClick(tr,obj)},removeMultifieldItem:function(btn,multifieldName){var that=this;var btnData=$(btn).data();var token=btnData.token;var index=APP.utils.getIndexFromField(that.multifieldRows[multifieldName],"token",token);if(index==-1)return;if(APP.utils.isset(that.multifieldRows[multifieldName][index][that.sectionTarget.multifields[multifieldName].primary_key]))that.multifieldRows[multifieldName][index].stato="D";else that.multifieldRows[multifieldName].splice(index,1);var table=btn.parents("table").first().dataTable();var tr=btn.parents("tr");table.fnDeleteRow(tr[0])},createFormDialog:function(params){var that=this;var identifier=APP.utils.isset(params.token)?params.token:null;var enctype=APP.utils.isset(that.sectionTarget.multifields[params.multifieldName].enctype)?'enctype="'+that.sectionTarget.multifields[params.multifieldName].enctype+'"':"";var form=$('<form class="form-horizontal" '+enctype+' role="form"></form>');if(APP.utils.isset(APP.config.getToken)&&$.isFunction(APP.config.getToken))form.append('<input type="hidden" name="csrf_token" class="tokenInput multifield" value="'+APP.config.getToken(params.multifieldName)+'">');params.div.html(form);$.each(that.sectionTarget.multifields[params.multifieldName].columns,function(j1,v){var required=APP.utils.isset(v.required)&&v.required?" required ":"";
var inp=null;var valore="";var obj=null;if(params.type=="edit"||params.type=="show"){var index=APP.utils.getIndexFromField(that.multifieldRows[params.multifieldName],"token",identifier);if(index==-1)return;obj=that.multifieldRows[params.multifieldName][index];if(v.data_type=="integer"){if($.isArray(obj[v.name])){$.each(obj[v.name],function(ii,vv){var number=parseInt(vv);if(isNaN(number))number="";obj[v.name][ii]=number})}else{var number=parseInt(obj[v.name]);if(isNaN(number))number="";obj[v.name]=number}}valore=obj[v.name]}valore=APP.utils.isset(obj)&&APP.utils.isset(obj[v.name])?obj[v.name]:"";if(!APP.utils.isset(valore)||valore==="")valore=APP.utils.getSecondaryValue(v);if($.type(v.form_show)==="boolean"&&!v.form_show||$.isPlainObject(v.form_show)&&(!v.form_show.insert&&!APP.utils.isset(identifier)||!v.form_show.update&&APP.utils.isset(identifier)))return true;inp=APP.utils.getInputFormat(identifier,obj,required,params.multifieldName,that.sectionTarget.multifields[params.multifieldName],that,v,valore,null);inp.find(":input").addClass("multifield");var displayOnOff=v.form_input_type=="hidden"?"style='display: none'":"";var ctrlGrp=$("<div class='form-group'>								<label class='control-label col-md-4' for='APP-"+v.name+"' "+displayOnOff+">"+v.label+":</label>								<div class='controls col-md-7' "+displayOnOff+"></div>								<div class='descrInput col-md-1'></div>							</div>");ctrlGrp.find(".controls").append(inp);if(APP.utils.isset(v.description))ctrlGrp.find(".descrInput").append($('<span id="description_'+v.name+'" data-toggle="tooltip" title="'+v.description+'" data-placement="auto" data-container="#multifieldContent" class="tooltipElement text-muted" style="padding-left: 5px"><i class="icon icon-info-sign"></i></span>'));form.append(ctrlGrp);if($.type(v.editable)==="boolean"&&!v.editable||$.isPlainObject(v.editable)&&(!v.editable.insert&&!APP.utils.isset(identifier)||!v.editable.update&&APP.utils.isset(identifier))||APP.utils.isset(identifier)&&$.inArray("update",that.sectionTarget.multifields[params.multifieldName].capabilities)===-1||!APP.utils.isset(identifier)&&$.inArray("insert",that.sectionTarget.multifields[params.multifieldName].capabilities)===-1)params.div.find("#APP-"+v.name).attr("disabled",true)})},formValidator:function(form,url,mtype){var that=this;var result=false;APP.utils.resetFormErrors(form);mtype=mtype==="add"?"PUT":mtype==="edit"?"POST":null;if(form.find(".textEditor").length>0)tinyMCE.triggerSave();if(APP.utils.isset(url)&&APP.utils.isset(mtype)){var d=form.serializeArray();form.find(":disabled").each(function(){if($(this).hasClass("fileupload"))return true;var o={};o.name=$(this).attr("name");o.value=$(this).val();d.push(o)});if(form.attr("enctype")==="multipart/form-data")d.push(APP.fileuploader.preserialize(form));$.ajax({type:mtype,url:url,data:d,async:false,success:function(data){if(!APP.utils.checkError(data.error,form)){result=true}else APP.utils.showErrMsg(data)},error:function(result){APP.utils.showErrMsg(result)}})}else{var inputs=$(form).find(":input");result=true;$.each(inputs,function(){var value=$(this).val();if(this.required&&(APP.utils.isEmptyString(value)||!APP.utils.isset(value))){result=false;APP.utils.renderError($(this),APP.i18n.translate("required_field"))}})}return result},onActionButtonClick:function(btn,div){var that=this;var data=btn.data();var type=btn.attr("name");var tkn=null;$("#modalMultifield").find(".modal-title").html(APP.i18n.translate(type));var closeBtn=$('<button class="btn btn-default" type="button" data-dismiss="modal" aria-hidden="true">'+APP.i18n.translate("cancel")+"</button>");var savebtn=$('<button class="btn btn-primary" type="button"><i class="icon icon-ok"></i> '+APP.i18n.translate("apply")+"</button>");switch(type){case"add":tkn=that.sectionTarget.multifields[data.multifieldname].token;savebtn.click(function(){var form=$("#modalMultifield").find("form");if(!that.formValidator(form,that.sectionTarget.multifields[data.multifieldname].multifieldValidationUrl,type))return;that.addMultifieldItem(form,div,data.multifieldname);$("#modalMultifield").modal("hide")});break;case"edit":tkn=data.token;savebtn.click(function(){var form=$("#modalMultifield").find("form");if(!that.formValidator(form,that.sectionTarget.multifields[data.multifieldname].multifieldValidationUrl,type))return;that.editMultifieldItem(form,$("#div_"+data.multifieldname),btn,data.multifieldname);$("#modalMultifield").modal("hide")});break;case"show":tkn=data.token;savebtn.hide();break;case"remove":var btns=$('<button class="btn btn-primary" type="button" style="width: 60px">'+APP.i18n.translate("yes")+'</button><button class="btn btn-default" data-dismiss="modal" aria-hidden="true" style="width: 60px">'+APP.i18n.translate("no")+"</button>");var yesBtn=$(btns[0]);yesBtn.click(function(){that.removeMultifieldItem(btn,data.multifieldname);$("#defaultMessageDialog").modal("hide")});var deleteConfirmMsg=APP.utils.isset(that.sectionTarget.messages)&&APP.utils.isset(that.sectionTarget.messages["delete_confirm"])?that.sectionTarget.messages["delete_confirm"]:APP.i18n.translate("remove_confirm");APP.utils.showMsg({title:APP.i18n.translate("warning"),content:deleteConfirmMsg,buttons:btns});return;default:console.log("Aggiungi questo tipo: "+type)}$("#modalMultifield").find(".modal-footer").html(savebtn);$("#modalMultifield").find(".modal-footer").append(closeBtn);that.createFormDialog({div:$("#multifieldContent"),type:type,token:tkn,multifieldName:data.multifieldname});$("#modalMultifield").one("shown.bs.modal",function(){APP.utils.setLookForm($("#multifieldContent").find("form"),null)});$("#modalMultifield").modal("show")},creaLinea:function(params){var that=this;var table=params.table;var arrayValues=[];var emptyValues=[];$.each(that.sectionTarget.multifields[params.multifieldName].columns,function(i,v){if(!v.subform_table_show)return true;emptyValues.push("");var identifier=APP.utils.isset(params.res)?params.res.id:null;var prn=APP.utils.isset(params.res)&&APP.utils.isset(params.res[v.name])?params.res[v.name]:null;if(!APP.utils.isset(prn)||prn==="")prn=APP.utils.getSecondaryValue(v);var inp=APP.utils.getInputFormat(identifier,params.res,APP.utils.isset(v.required)?v.required:"",v.label,that.sectionTarget.multifields[params.multifieldName],params.ctx,v,prn,null);if(inp.is(":input")){inp.addClass("multifield");if(v.change){APP.utils.setChangeProperty(inp);inp.data().mode=APP.utils.isset(identifier)?"update":"insert"}inp.attr("disabled",!v.editable)}else{inp.find(":input").addClass("multifield");if(v.change){APP.utils.setChangeProperty(inp.find(":input"));inp.find(":input").data().mode=APP.utils.isset(identifier)?"update":"insert"}inp.find(":input").attr("disabled",!v.editable)}arrayValues.push(inp)});emptyValues.push("");var closeBtn=$('<span class="close" aria-hidden="true">&times;</span>');closeBtn.click(function(){var myTable=$(this).parents("table:first");var myRow=$(this).parents("tr:first");myTable.dataTable().fnDeleteRow(myRow[0])});arrayValues.push(closeBtn);var trIndex=table.dataTable().fnAddData(emptyValues);var myTr=table.dataTable().fnGetNodes(trIndex[0]);var tdLength=$(myTr).find("td").length;$.each($(myTr).find("td"),function(i,v){$(this).html(arrayValues[i])})},showMultifieldTable:function(params){var that=this;that.sectionTarget=params.sectionTarget;var multifieldName=params.multifieldName;that.multifieldRows[multifieldName]=that.sectionTarget.multifields[multifieldName].values;if(!APP.utils.isset(that.sectionTarget.multifields)){alert("non e' settato l'array multifields in "+that.sectionTarget.resource);return}var s=$('<div id="div_'+multifieldName+'">						<div class="table-responsive">							<table name="'+multifieldName+'" class="table table-striped table-bordered table-hover datatable multifieldTable">								<thead><tr></tr></thead>								<tbody></tbody>							</table>						</div>						<div id="modalMultifield" class="modal fade" role="dialog">							<div class="modal-dialog">								<div class="modal-content">									<div class="modal-header">										<button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>										<h4 class="modal-title"></h4>									</div>									<div class="modal-body" id="multifieldContent" ></div>									<div class="modal-footer"></div>								</div>							</div>						</div>					</div>');var div=params.div;if($.inArray("insert",that.sectionTarget.multifields[multifieldName].capabilities)>-1){var addSpan=$('<span id="add_'+multifieldName+'" name="add" data-multifieldname="'+multifieldName+'" class="btn btn-primary" style="margin-bottom: 20px; margin-right: 40px; float: left"><i class="icon-plus icon-white"></i> '+APP.i18n.translate("add")+"</span>");s.prepend(addSpan)}div.html(s);$("#modalMultifield").modal({show:false});params.table=div.find("table");div.find("#add_"+multifieldName).click(function(){that.creaLinea(params)});var thead=div.find("thead").find("tr");var tbody=div.find("tbody");var cols=[];var obj=that.sectionTarget.multifields[multifieldName];var valori={};$.each(obj.columns,function(i,v){if(!v.subform_table_show)return true;var suffix=v.foreign_mode=="multiselect"?"[]":"";if(APP.utils.isset(v.description)){var tthh=$('<th name="'+v.name+suffix+'" style="width:'+v["table_col_width_%"]+'%" class="table-th" data-container="#APP-'+multifieldName+'" data-toggle="tooltip " data-placement="top" title="'+v.description+'">'+v.label+"</th>");tthh.tooltip();thead.append(tthh)}else thead.append('<th name="'+v.name+suffix+'" class="table-th" style="width:'+v["table_col_width_%"]+'%">'+v.label+"</th>");if(!v.hasOwnProperty("foreign_key")&&v.form_input_type=="combobox")valori[v.name]=APP.utils.getForeignValue(v,null);cols.push(v)});thead.append("<th name='actions'></th>");div.find(".datatable").dataTable({bRetrieve:true,bPaginate:false,bFilter:false,bSort:false,iDisplayLength:params.idl,oLanguage:APP.utils.getDataTableLanguage()});if(APP.utils.isset(params.res)){$.each(params.res,function(i,v){that.creaLinea({multifieldName:params.multifieldName,sectionTarget:params.sectionTarget,ctx:params.ctx,res:v,idl:params.idl,table:div.find(".datatable")})})}if(APP.utils.isset(obj.sortable)&&obj.sortable===true)tbody.sortable({stop:function(event,ui){var sfn=$(ui.item[0]).parents("table:first").attr("name");var sfrCopy=that.multifieldRows[sfn];if(sfrCopy.length===0)return;that.multifieldRows[sfn]=[];$.each(this.children,function(){var d=$(this).data();delete d["sortableItem"];var fieldKey=that.sectionTarget.multifields[sfn].primary_key;var elIndex=APP.utils.getIndexFromField(sfrCopy,fieldKey,d[fieldKey]);d.token=sfrCopy[elIndex].token;that.multifieldRows[sfn].push(d)})}})}});$.extend(APP.map,{globalData:{},currentMapId:null,sidebar:{div:null,control:null},currentPosition:{id:null,marker:null,centerize:false},cautionIcon:L.icon({iconUrl:"/public/img/map/caution.png",iconAnchor:[16,37]}),startIcon:L.icon({iconUrl:"/public/img/map/start.png",iconAnchor:[16,37]}),stopIcon:L.icon({iconUrl:"/public/img/map/finish.png",iconAnchor:[16,37]}),selectedMarker:L.icon({iconUrl:"/public/img/map/selected_marker.png",iconAnchor:[12,41]}),unselectedMarker:new L.Icon.Default,isset:function(o){if(typeof o=="undefined")return false;else if(o==null)return false;return true},finish:function(){$.each(this.globalData,function(i,v){v.map.remove()});this.globalData={};this.currentMapId=null},getMap:function(){return this.globalData[this.currentMapId].map},getLayer:function(id){var that=this;return that.globalData[that.currentMapId].addedLayers[id].layer},resizeMap:function(){if(!this.isset(this.currentMapId)||this.currentMapId.indexOf("mapboxDiv")===0)return;var div=$(this.globalData[this.currentMapId].map.getContainer());if(div.length>0)$(div[0]).height(div.parent().height()-120);this.globalData[this.currentMapId].map.invalidateSize(true)},setGlobalExtent:function(extent){var that=this;if(!APP.utils.isset(extent))return;if(!APP.utils.isset(APP.config.localConfig.default_extent)){alert("Walter dovresti inserire la voce default_extent nel config");return}if(!APP.utils.isset(this.globalData[this.currentMapId].globalExtent))this.globalData[this.currentMapId].globalExtent={};var value;if(APP.utils.isset(extent.maxx)){value=parseFloat(extent.maxx);if(!this.globalData[this.currentMapId].globalExtent.hasOwnProperty("maxx")||this.globalData[this.currentMapId].globalExtent.maxx<value)this.globalData[this.currentMapId].globalExtent.maxx=value}if(APP.utils.isset(extent.maxy)){value=parseFloat(extent.maxy);if(!this.globalData[this.currentMapId].globalExtent.hasOwnProperty("maxy")||this.globalData[this.currentMapId].globalExtent.maxy<value)this.globalData[this.currentMapId].globalExtent.maxy=value}if(APP.utils.isset(extent.minx)){value=parseFloat(extent.minx);if(!this.globalData[this.currentMapId].globalExtent.hasOwnProperty("minx")||this.globalData[this.currentMapId].globalExtent.minx>value)this.globalData[this.currentMapId].globalExtent.minx=value}if(APP.utils.isset(extent.miny)){value=parseFloat(extent.miny);if(!this.globalData[this.currentMapId].globalExtent.hasOwnProperty("miny")||this.globalData[this.currentMapId].globalExtent.miny>value)this.globalData[this.currentMapId].globalExtent.miny=value}},highlightLayer:function(id){var that=this;var selectedOpacity=1;var unselectedOpacity=.4;var defaultPathOpacity=.5;var defaultMarkerOpacity=1;var selectedZIndex=1e3;var unselectedZIndex=0;var setOpacity=function(layer,op){if(layer.setOpacity&&$.isFunction(layer.setOpacity))op!==null?layer.setOpacity(op):layer.setOpacity(defaultMarkerOpacity);else op!==null?layer.setStyle({opacity:op}):layer.setStyle({opacity:defaultPathOpacity})};var setZIndex=function(layer,z){if(layer.setZIndexOffset&&$.isFunction(layer.setZIndexOffset))z!==null?layer.setZIndexOffset(z):layer.setOpacity(unselectedZIndex)};$.each(that.globalData[this.currentMapId].addedLayers,function(i,v){if(id===null){setOpacity(v.layer,null);setZIndex(v.layer,unselectedZIndex)}else{if(i===id){setOpacity(v.layer,selectedOpacity);setZIndex(v.layer,selectedZIndex)}else{setOpacity(v.layer,unselectedOpacity);setZIndex(v.layer,unselectedZIndex)}}})},preserialize:function(name){var value="";if(APP.utils.isset(this.globalData[this.currentMapId].drawnItems)&&this.globalData[this.currentMapId].drawnItems.getLayers().length>0){var gj=this.globalData[this.currentMapId].drawnItems.toGeoJSON();value=JSON.stringify(gj)}return{name:name,value:value}},setMapControls:function(){if(APP.config.localConfig.menu)this.addFullScreenControl();L.control.scale().addTo(this.globalData[this.currentMapId].map)},setExtent:function(extent){var that=this;if(!this.isset(extent)||$.isEmptyObject(extent)||!this.isset(this.currentMapId))return;that.globalData[that.currentMapId].map.fitBounds([[parseFloat(extent.miny),parseFloat(extent.minx)],[parseFloat(extent.maxy),parseFloat(extent.maxx)]]);this.globalData[this.currentMapId].map.invalidateSize(true)},addLayer:function(obj){var that=this;var foundLayer=false;var myId=APP.utils.getIndexFromField(that.globalData[that.currentMapId].addedLayers,"id",obj.id);if(myId>-1)that.globalData[that.currentMapId].addedLayers[myId].visible=true;else that.globalData[that.currentMapId].addedLayers[obj.id]={id:obj.id,layer:obj.layer,visible:true,max_scale:obj.max_scale};if(!that.globalData[that.currentMapId].map.hasLayer(that.globalData[that.currentMapId].addedLayers[obj.id].layer))that.globalData[that.currentMapId].addedLayers[obj.id].layer.addTo(that.globalData[that.currentMapId].map)},showLayer:function(id){var that=this;var index=APP.utils.getIndexFromField(that.globalData[that.currentMapId].addedLayers,"id",id);if(index===-1)return false;that.globalData[that.currentMapId].addedLayers[index].visible=true;if(!that.globalData[that.currentMapId].map.hasLayer(that.globalData[that.currentMapId].addedLayers[index].layer))that.globalData[that.currentMapId].addedLayers[index].layer.addTo(that.globalData[that.currentMapId].map)},showAllLayers:function(){var that=this;$.each(that.globalData[that.currentMapId].addedLayers,function(i,v){that.showLayer(i)})},hideLayer:function(id){var that=this;var index=APP.utils.getIndexFromField(that.globalData[that.currentMapId].addedLayers,"id",id);if(index!==-1){that.globalData[that.currentMapId].addedLayers[index].visible=false;if(that.globalData[that.currentMapId].map.hasLayer(that.globalData[that.currentMapId].addedLayers[index].layer))that.globalData[that.currentMapId].map.removeLayer(that.globalData[that.currentMapId].addedLayers[index].layer)}},hideAllLayers:function(){var that=this;$.each(that.globalData[that.currentMapId].addedLayers,function(i,v){that.hideLayer(i)})},removeLayer:function(id){var that=this;var index=APP.utils.getIndexFromField(that.globalData[that.currentMapId].addedLayers,"id",id);if(index!==-1){if(that.globalData[that.currentMapId].map.hasLayer(that.globalData[that.currentMapId].addedLayers[index].layer))that.globalData[that.currentMapId].map.removeLayer(that.globalData[that.currentMapId].addedLayers[index].layer);delete that.globalData[that.currentMapId].addedLayers[index]}},removeAllLayers:function(){var that=this;$.each(that.globalData[that.currentMapId].addedLayers,function(i,v){that.removeLayer(i)})},changeColors:function(newColor){var that=this;if(that.globalData&&that.globalData[that.currentMapId]&&that.globalData[that.currentMapId].map){var ls=that.globalData[that.currentMapId].map._layers;$.each(ls,function(){if(this.setStyle)this.setStyle({color:newColor})});$.each(L.drawLocal.draw.handlers,function(i,v){var obj={};obj[i]={shapeOptions:{color:newColor}};that.globalData[that.currentMapId].drawControl.setDrawingOptions(obj)})}},toggleDrawEditor:function(mapId,b,options){var that=this;if(b){if(!APP.utils.isset(options)){this.globalData[mapId].drawnItems=new L.FeatureGroup;this.globalData[mapId].map.addLayer(this.globalData[mapId].drawnItems);options={edit:{featureGroup:that.globalData[mapId].drawnItems,edit:false}}}this.globalData[mapId].drawControl=new L.Control.Draw(options);this.globalData[mapId].map.addControl(this.globalData[mapId].drawControl)}else{if(!APP.utils.isset(this.globalData[mapId].drawControl))return;this.globalData[mapId].map.removeControl(this.globalData[mapId].drawControl);this.globalData[mapId].drawControl=null;if(this.globalData[mapId].map.hasLayer(this.globalData[mapId].drawnItems))this.globalData[mapId].map.removeLayer(this.globalData[mapId].drawnItems);this.globalData[mapId].drawnItems=null}},destroyMap:function(id){if(APP.utils.isset(this.globalData[id])&&APP.utils.isset(this.globalData[id].map)){this.globalData[id].map.remove();delete this.globalData[id];this.currentMapId=null}},changeMap:function(newMapId){this.currentMapId=APP.utils.isset(this.globalData[newMapId])?newMapId:null},updateLayerGroups:function(groupId,mapId,items){var that=this;var ls=that.globalData[mapId].layerGroups;var map=that.globalData[mapId].map;var elemId=groupId;if(!APP.utils.isset(ls))ls={};if(APP.utils.isset(ls[elemId])){$.each(ls[elemId],function(){map.removeLayer(this)})}ls[elemId]=[];$.each(items,function(){ls[elemId].push(L.geoJson(this.geoJSON));ls[elemId][ls[elemId].length-1].addTo(map)})},setMap:function(O){var that=this;var div=O.container;var id=div.attr("id");if(this.isset(this.currentMapId)&&this.currentMapId==id)return;this.globalData[id]={map:{},addedLayers:{},layerGroups:{},drawControl:null,drawnItems:null,miniMapControl:null};this.changeMap(id);var baseLayers={};var layers=[];var defLayName=null;var defLayUrl=null;var defaultLayer=null;if(APP.utils.isset(APP.config.localConfig)){$.each(APP.config.localConfig.background_layer,function(i,v){var l=null;switch(v.source){case"GOOGLE":l=new L.Google;break;case"BING":l=new L.BingLayer;break;default:switch(v.layer_type){case"tilelayer":l=new L.tileLayer(v.url,{attribution:v.description});break;case"tilelayer.wms":l=new L.tileLayer.wms(v.url,{layers:v.layers,version:v.version,styles:v.styles,format:v.format,transparent:v.trasparent,attribution:v.description,tileSize:1024});break}}if(v.def){defLayUrl=v.url;defaultLayer=l;defLayName=v.name}else{layers.push(l);baseLayers[v.name]=l}})}else{defLayUrl="http://{s}.tile.osm.org/{z}/{x}/{y}.png";defaultLayer=new L.tileLayer(defLayUrl,{attribution:"Mappa stradale"});defLayName="Openstreetmap"}layers.push(defaultLayer);that.globalData[id].map=new L.map(id,{center:O.center?O.center:new L.LatLng(44.160534,11.04126),zoom:O.zoom?O.zoom:9,layers:[defaultLayer]});that.setGlobalExtent(APP.config.localConfig.default_extent);if(!O.center)that.setExtent(that.globalData[id].globalExtent);baseLayers[defLayName]=defaultLayer;L.control.layers(baseLayers).addTo(that.globalData[id].map);that.setMapControls();if(APP.utils.isset(L.Hash))var hash=new L.Hash(that.globalData[id].map);if(APP.utils.isset(L.control.locate)){L.control.locate({position:"bottomright",icon:"icon-location-arrow",locateOptions:{enableHighAccuracy:true,timeout:6e4},onLocationError:function(err){console.log(err.message)}}).addTo(that.globalData[id].map)}if(L.control.sidebar&&$("#leafletSidebar").length>0){that.sidebar.control=L.control.sidebar("leafletSidebar",{position:"left"});that.sidebar.control.addTo(that.globalData[id].map)}if(APP.utils.isset(L.control.coordinates)){L.control.coordinates({position:"bottomleft"}).addTo(that.globalData[id].map)}if(APP.utils.isset(L.Control.MiniMap)){L.extend(L.Control.MiniMap.prototype,{hideText:APP.i18n.translate("hide_minimap"),showText:APP.i18n.translate("show_minimap")});var miniMapLayer=new L.TileLayer(defLayUrl,{minZoom:0,maxZoom:13});that.globalData[id].miniMapControl=new L.Control.MiniMap(miniMapLayer,{toggleDisplay:true}).addTo(that.globalData[id].map)}if(APP.utils.isset(L.Control.FullScreen)){L.control.fullscreen({position:"topleft",forceSeparateButton:true}).addTo(that.globalData[id].map)}{L.Control.EraseALL=L.Control.extend({options:{position:"topleft",buttonText:"X",buttonTitle:"Erase every feature",layer:new L.FeatureGroup},onAdd:function(map){var eraseName="leaflet-control-eraseall",container=L.DomUtil.create("div",eraseName+" leaflet-bar");this._map=map;this._eraseButton=this._createButton(this.options.buttonText,this.options.buttonTitle,eraseName+"-act",container,this._eraseAll,this);return container},_eraseAll:function(e){this.options.layer.clearLayers()},_createButton:function(html,title,className,container,fn,context){var link=L.DomUtil.create("a",className,container);link.innerHTML=html;link.href="#";link.title=title;var stop=L.DomEvent.stopPropagation;L.DomEvent.on(link,"click",stop).on(link,"mousedown",stop).on(link,"dblclick",stop).on(link,"click",L.DomEvent.preventDefault).on(link,"click",fn,context).on(link,"click",this._refocusOnMap,context);return link}})}},addFullScreenControl:function(){L.Control.FullScreen=L.Control.extend({options:{position:"topleft",title:APP.i18n.translate("Full Screen"),forceSeparateButton:false},onAdd:function(map){var className="leaflet-control-zoom-fullscreen",container;if(map.zoomControl&&!this.options.forceSeparateButton){container=map.zoomControl._container}else{container=L.DomUtil.create("div","leaflet-bar")}this._createButton(this.options.title,className,container,this.toogleFullScreen,map);return container},_createButton:function(title,className,container,fn,context){var link=L.DomUtil.create("a",className,container);link.href="#";link.title=title;L.DomEvent.addListener(link,"click",L.DomEvent.stopPropagation).addListener(link,"click",L.DomEvent.preventDefault).addListener(link,"click",fn,context);L.DomEvent.addListener(container,fullScreenApi.fullScreenEventName,L.DomEvent.stopPropagation).addListener(container,fullScreenApi.fullScreenEventName,L.DomEvent.preventDefault).addListener(container,fullScreenApi.fullScreenEventName,this._handleEscKey,context);L.DomEvent.addListener(document,fullScreenApi.fullScreenEventName,L.DomEvent.stopPropagation).addListener(document,fullScreenApi.fullScreenEventName,L.DomEvent.preventDefault).addListener(document,fullScreenApi.fullScreenEventName,this._handleEscKey,context);return link},toogleFullScreen:function(){this._exitFired=false;var container=this._container;if(this._isFullscreen){if(fullScreenApi.supportsFullScreen){fullScreenApi.cancelFullScreen(container)}else{L.DomUtil.removeClass(container,"leaflet-pseudo-fullscreen")}this.invalidateSize();this.fire("exitFullscreen");this._exitFired=true;this._isFullscreen=false}else{if(fullScreenApi.supportsFullScreen){fullScreenApi.requestFullScreen(container)}else{L.DomUtil.addClass(container,"leaflet-pseudo-fullscreen")}this.invalidateSize();this.fire("enterFullscreen");this._isFullscreen=true}},_handleEscKey:function(){if(!fullScreenApi.isFullScreen(this)&&!this._exitFired){this.fire("exitFullscreen");this._exitFired=true;this._isFullscreen=false}}});L.Map.addInitHook(function(){if(this.options.fullscreenControl){this.fullscreenControl=L.control.fullscreen(this.options.fullscreenControlOptions);this.addControl(this.fullscreenControl)}});L.control.fullscreen=function(options){return new L.Control.FullScreen(options)};var fullScreenApi={supportsFullScreen:false,isFullScreen:function(){return false},requestFullScreen:function(){},cancelFullScreen:function(){},fullScreenEventName:"",prefix:""},browserPrefixes="webkit moz o ms khtml".split(" ");if(typeof document.exitFullscreen!="undefined"){fullScreenApi.supportsFullScreen=true}else{for(var i=0,il=browserPrefixes.length;i<il;i++){fullScreenApi.prefix=browserPrefixes[i];if(typeof document[fullScreenApi.prefix+"CancelFullScreen"]!="undefined"){fullScreenApi.supportsFullScreen=true;break}}}if(fullScreenApi.supportsFullScreen){fullScreenApi.fullScreenEventName=fullScreenApi.prefix+"fullscreenchange";fullScreenApi.isFullScreen=function(){switch(this.prefix){case"":return document.fullScreen;case"webkit":return document.webkitIsFullScreen;default:return document[this.prefix+"FullScreen"]}};fullScreenApi.requestFullScreen=function(el){return this.prefix===""?el.requestFullscreen():el[this.prefix+"RequestFullScreen"]()};fullScreenApi.cancelFullScreen=function(el){return this.prefix===""?document.exitFullscreen():document[this.prefix+"CancelFullScreen"]()}}if(typeof jQuery!="undefined"){jQuery.fn.requestFullScreen=function(){return this.each(function(){var el=jQuery(this);if(fullScreenApi.supportsFullScreen){fullScreenApi.requestFullScreen(el)}})}}window.fullScreenApi=fullScreenApi}});$.extend(APP.interactiveMap,{leafletHash:null,bQrCode:false,previousSection:null,currentSection:null,currentItinerary:null,selectedElement:null,myData:{},body:null,navbars:{top:null,bottom:null},infoDelay:1e3,searchModal:null,itemsOnSidebar:true,mySidebar:{control:null,div:null},icons:{altitude_gap:"/public/img/dislivello.png",length:"/public/img/lunghezza.png",time:"/public/img/durata.png"},bouncingMarkers:false,searchUrl:"/jx/search?tofind=",pages:{},qrCodeEventObj:$(document),insertRowAlphabetically:function(container,row,selector,offset){var that=this;offset=offset?offset:0;var cs=container.children();if(offset===cs.length){container.append(row);return false}var node=$(cs[offset]);var nodeTitle=node.find(selector).text();var rowTitle=row.find(selector).text();if(nodeTitle>rowTitle)row.insertBefore(node);else that.insertRowAlphabetically(container,row,selector,offset+1)},getObjectTitle:function(section,id){var that=this;return section==="itinerary"?that.myData[section][id].data.name:that.myData[section][id].data.title},getOverviewImage:function(section,id,thumbnail){var that=this;if(that.myData[section][id].media&&that.myData[section][id].media.images&&$.isArray(that.myData[section][id].media.images)&&that.myData[section][id].media.images.length>0)return thumbnail?that.myData[section][id].media.images[0].image_thumb_url:that.myData[section][id].media.images[0].image_url;else return thumbnail&&APP.config.localConfig.default_overview_thumbnail?APP.config.localConfig.default_overview_thumbnail:APP.config.localConfig.default_overview_image},getTypology:function(typologyId){var index=APP.utils.getIndexFromField(APP.config.localConfig.typology,"id",typologyId);if(index>-1&&APP.utils.isset(APP.config.localConfig.typology[index]))return APP.config.localConfig.typology[index];return false},resize:function(){if(!APP.utils.isset(this.body))return;var x=this.body.find(".centerImage");x.css("width","100%");x.centerImage()},checkVideoUrl:function(url){var that=this;var arr=url.split("/");var id=arr[arr.length-1];id=id.split("?")[0];if(url.indexOf("vimeo")>=0)return{href:"https://vimeo.com/"+id,type:"text/html",vimeo:id};if(url.indexOf("youtube")>=0)return{href:"https://www.youtube.com/watch?v="+id,type:"text/html",youtube:id,poster:"https://img.youtube.com/vi/"+id+"/maxresdefault.jpg"};return false},highlightLayer:function(section,id){if(section!=="itinerary"){if(APP.map.globalData.mainContent.addedLayers[section+"_"+id].layer)APP.map.highlightLayer(section+"_"+id);this.selectedElement=id}},resetHighlightLayer:function(){this.unselectItem();APP.map.highlightLayer(null,null)},onItineraryClick:function(o){var that=this;var element=o.element;var section=o.section;var id=o.id;if(!that.checkIfMyDataExists(section,id))return;if(that.itemsOnSidebar&&L.control.sidebar&&that.mySidebar.div){var it=that.mySidebar.div.find("#item_"+section+"_"+id);if(it.length>0)it.addClass("active")}that.currentItinerary=id;APP.map.hideAllLayers();$.each(that.myData[section][id].data.areas,function(j,k){that.sendGeojsonLayerToMap(that.myData.area[k].geo,"area")});$.each(that.myData[section][id].data.paths,function(j,k){that.sendGeojsonLayerToMap(that.myData.path[k].geo,"path")});$.each(that.myData[section][id].data.pois,function(j,k){that.sendGeojsonLayerToMap(that.myData.poi[k].geo,"poi")});that.showBottomBar(section,id,function(){if(that.itemsOnSidebar&&L.control.sidebar&&that.mySidebar.control){that.mySidebar.div.find(".active").removeClass("active");that.mySidebar.control.hide()}else{that.body.find("#modal-"+section).find(".active").removeClass("active");that.body.find("#modal-"+section).modal("hide")}that.showItems(that.currentSection)});APP.utils.showNoty({content:"<p>"+APP.i18n.translate("You are currently viewing the elements of the following itinerary")+': <strong class="text-danger">'+that.getObjectTitle(section,id)+"</strong>.<br>"+APP.i18n.translate("To view all the elements again, exit from itinerary")+".</p>",title:APP.i18n.translate("Information"),type:"alert",timeout:3e3});that.zoomAt(section,id)},closeItinerary:function(onCloseCallback){var that=this;that.currentItinerary=null;that.selectedElement=null;that.hideBottomBar();APP.map.showAllLayers();that.resetHighlightLayer();APP.map.setExtent(APP.map.globalData[APP.map.currentMapId].globalExtent);if(APP.utils.isset(onCloseCallback)&&$.isFunction(onCloseCallback))onCloseCallback()},bindPopup:function(section,id,latlng){var that=this;var element=APP.map.getLayer(section+"_"+id);if(element.unbindPopup&&$.isFunction(element.unbindPopup))element.unbindPopup();var po={closeOnClick:true,maxWidth:that.body.width()>320?300:that.body.width()-that.body.width()*.3,minWidth:that.body.width()>320?280:that.body.width()-that.body.width()*.4,autoPan:false};if(section=="poi")po.offset=L.point(0,-25);var media='<div class="media">						<a class="pull-left" href="#">							<img class="media-object thumbnail" style="width: 75px" src="'+that.getOverviewImage(section,id,true)+'" alt="">						</a>						<div class="media-body">							<h4 class="media-heading hidden-xs hidden-sm">'+that.getObjectTitle(section,id)+'</h4>							<h5 class="media-heading hidden-md hidden-lg">'+that.getObjectTitle(section,id)+'</h5>							<div>								<button type="button" class="btn btn-default btn-sm popupDetailsBtn" style="margin-top: 10px"><i class="icon icon-search"></i> '+APP.i18n.translate("View data sheet")+"</button>							</div>						</div>					</div>";element.bindPopup(media,po);element.off("popupopen").on("popupopen",function(a){var myBtn=$(a.popup._container).find(".popupDetailsBtn");var closeBtn=$(a.popup._container).find(".leaflet-popup-close-button");closeBtn.off("click").click(function(){that.resetHighlightLayer()
});myBtn.off("click").click(function(){that.showInformation(section,id)})});element.off("popupclose").on("popupclose",function(a){if(a.layer)a.layer.unbindPopup();else if(a.target)a.target.unbindPopup()});if(section==="area"&&!APP.utils.isset(latlng))latlng=L.latLng(that.myData[section][id].geo.centroids[0].coordinates[1],that.myData[section][id].geo.centroids[0].coordinates[0]);element.openPopup(latlng)},unselectItem:function(element){var that=this;var lg=null;if(element)lg=element.parents(".accordion-list:first");else{if(that.itemsOnSidebar&&L.control.sidebar&&that.mySidebar.control){that.mySidebar.div.find(".list-group-item.active").removeClass("active")}else{}}if(lg)lg.find("a.active").removeClass("active")},checkIfMyDataExists:function(section,id){var that=this;var r=APP.utils.isset(that.myData[section])&&APP.utils.isset(that.myData[section][id]);if(r)return true;else{APP.utils.showNoty({title:APP.i18n.translate("error"),type:"error",content:APP.i18n.translate("not_found")+": "+section+"/"+id});return false}},onElementClick:function(o){var that=this;var element=o.element;var section=o.section;var id=o.id;var latlng=o.latlng;if(!that.checkIfMyDataExists(section,id))return;if(element&&element.hasClass&&element.hasClass("list-group-item")){that.unselectItem(element);element.addClass("active")}if(!APP.utils.isset(that.currentItinerary)){that.highlightLayer(section,id);if(that.itemsOnSidebar&&L.control.sidebar&&that.mySidebar.div){that.mySidebar.div.find(".list-group-item.active").removeClass("active");var it=that.mySidebar.div.find("#item_"+section+"_"+id);if(it.length>0)it.addClass("active")}}var afterHidden=function(){APP.map.showLayer(section+"_"+id);that.zoomAt(section,id);if(section==="itinerary")return false;that.bindPopup(section,id,latlng)};if(that.itemsOnSidebar&&L.control.sidebar&&that.mySidebar.control&&that.navbars.top.parents(".navbar").find(".navbar-toggle").is(":visible")){that.mySidebar.control.hide();setTimeout(function(){afterHidden()},600)}else afterHidden()},showInformation:function(section,id,onCloseCallback){var that=this;if(that.itemsOnSidebar&&L.control.sidebar&&that.mySidebar.control)APP.map.sidebar.control.hide();that.openInfo(section,id,onCloseCallback)},showBottomBar:function(section,id,onCloseCallback){var that=this;var myTitle=that.getObjectTitle(section,id);that.navbars.bottom=that.body.find(".navbar-fixed-bottom");if(that.navbars.bottom.length>0){that.body.find("#mainContent").height(that.body.find("#mainContent").height()+that.navbars.bottom.height());that.navbars.bottom.remove()}that.navbars.bottom=$('<nav class="navbar navbar-inverse navbar-fixed-bottom" role="navigation">									<div class="container-fluid">										<div class="navbar-header">											<button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#bottomNavbarCollapse">												<span class="sr-only">Toggle navigation</span>												<span class="icon-bar"></span>												<span class="icon-bar"></span>												<span class="icon-bar"></span>											</button>											<a class="navbar-brand" href="#" style="display:none; color:white">												<span class="hidden-sm hidden-xs">'+APP.i18n.translate(APP.utils.capitalize(section))+": </span> "+myTitle+'											</a>										</div>										<div id="bottomNavbarCollapse" class="navbar-collapse collapse">											<ul class="nav navbar-nav navbar-right">												<li><a href="#" class="detailsButton"><i class="icon icon-search"></i> '+APP.i18n.translate("Data sheet")+'</a></li>												<li><a href="#" class="closeButton"><i class="icon icon-remove"></i> '+APP.i18n.translate("Exit from itinerary")+"</a></li>											</ul>										</div>									</div>								</nav>");that.navbars.bottom.find(".detailsButton").click(function(){if(that.navbars.bottom.find(".navbar-collapse").hasClass("in"))that.navbars.bottom.find(".navbar-collapse").collapse("hide");that.showInformation(section,id,function(){})});that.navbars.bottom.find(".closeButton").click(function(){that.closeItinerary(onCloseCallback)});that.body.append(that.navbars.bottom);var h=that.body.find("#mainContent").height();that.body.find("#mainContent").height(h-that.navbars.bottom.height());that.navbars.bottom.find(".navbar-brand").click(function(){that.body.find("#bottomNavbarCollapse").collapse("toggle")}).fadeIn(1500)},hideBottomBar:function(){var that=this;var botNav=that.body.find(".navbar-fixed-bottom");if(botNav.length>0){var h=that.body.find("#mainContent").height();that.body.find("#mainContent").height(h+botNav.height());botNav.remove()}that.navbars.bottom=null},openInfo:function(section,id,onCloseCallback){var that=this;var myModal=that.body.find("#modal-"+section+"-info");if(myModal.length>0)myModal.remove();var myTitle=that.getObjectTitle(section,id);myModal=$('<div id="modal-'+section+'-info" class="modal fade" tabindex="-1" role="dialog" aria-labelledby="'+section+'" aria-hidden="true">						<div class="modal-dialog modal-lg">							<div class="modal-content">							  <div class="modal-header">								<button type="button" class="btn-lg close" data-dismiss="modal" aria-hidden="true"><span class="glyphicon glyphicon-remove"></span></button>								<h3 class="lead">'+myTitle+'</h3>							  </div>							  <div class="modal-body">								<div class="gallery" style="margin: -15px -15px 0px -15px">									<div class="overviewImage" style="width: 100%; height: 300px"></div>									<div class="row thumbnailsRow" style="padding: 20px; vertical-align: middle"></div>								</div>								<div class="row">									<div class="col-md-4">										<div class="panel panel-default categories" style="display: none">											<div class="panel-heading">												<h3 class="panel-title">'+APP.i18n.translate("categories")+'</h3>											</div>											<div class="panel-body">											</div>										</div>									</div>									<div class="col-md-8">										<div class="panel panel-default features" style="display: none">											<div class="panel-heading">												<h3 class="panel-title">'+APP.i18n.translate("features")+'</h3>											</div>											<div class="panel-body">											</div>										</div>									</div>								</div>								<div class="paragraphes text-justify"></div>							  </div>							  <div class="modal-footer">								<button type="button" data-dismiss="modal" class="btn btn-primary">'+APP.i18n.translate("close")+"</button>							  </div>							</div>						</div>					</div>");if(!APP.utils.isset(that.myData[section][id].media)||!APP.utils.isset(that.myData[section][id].media.images)||!$.isArray(that.myData[section][id].media.images)||that.myData[section][id].media.images.length===0){var img=$('<img alt="" class="img-responsive centerImage" style="width: 100%; height:100%;">');img.attr("src",APP.config.localConfig.default_overview_image);myModal.find(".overviewImage").append(img)}else{var imageGalleryId="big_"+section+"_"+id;$.each(that.myData[section][id].media.images,function(i,v){if(i===0){var img=$('<img alt="" data-toggle="tooltip" class="img-responsive centerImage" style="width: 100%; height:100%">');img.attr("src",v.image_url);img.tooltip({container:"#modal-"+section+"-info",placement:"top",title:$(v.description).text()});myModal.find(".overviewImage").append(img)}var thumbnail=$('<div class="col-xs-4 col-md-2">									<a href="'+v.image_url+'" title="'+$(v.description).text()+'" class="" data-gallery="#'+imageGalleryId+'">									  <img src="'+v.image_thumb_url+'" alt="'+v.description+'" class="img-thumbnail">									</a>								  </div>');thumbnail.find("img").tooltip({container:"#modal-"+section+"-info",placement:"auto",title:$(v.description).text()});myModal.find(".thumbnailsRow").append(thumbnail)});that.setBlueimpGalleryDiv({container:that.body,id:imageGalleryId,classes:"blueimp-gallery blueimp-gallery-controls",closeBtn:true})}var videosContainer=null;var videos=[];var parToAppend=[];var overviewToAppend={};var checkVoice=function(voice,type,moreParams){var div=$('<div class="'+voice+'"><h3>'+APP.i18n.translate(APP.utils.capitalize(voice))+"</h3></div>");var bInsert=true;switch(type){case"text":if(APP.utils.isset(that.myData[section][id].data[voice])&&!APP.utils.isEmptyString(that.myData[section][id].data[voice]))div.append(that.myData[section][id].data[voice]);else bInsert=false;break;case"ov-img":if(APP.utils.isset(that.myData[section][id].data[voice])&&APP.utils.isset(moreParams)&&$.isArray(moreParams.values)){if(!APP.utils.isset(overviewToAppend[moreParams.voiceResult]))overviewToAppend[moreParams.voiceResult]=[];var arr=[];if(!$.isArray(that.myData[section][id].data[voice]))arr[0]=that.myData[section][id].data[voice];else arr=that.myData[section][id].data[voice];$.each(arr,function(i,v){var ii=APP.utils.getIndexFromField(moreParams.values,"id",v);if(ii>-1){var img=$('<div class="media">												<a class="pull-left" href="#">													<img src="'+moreParams.values[ii][moreParams.icon]+'" class="img-responsive" style="margin-top: -3px; max-width: 32px" alt="'+moreParams.values[ii][moreParams.label]+'">												</a>												<div class="media-body">													<h5 class="media-heading"><span class="label label-'+(voice==="typology_id"?"danger":"default")+'">'+moreParams.values[ii][moreParams.label]+"</span></h5>												</div>											</div>");overviewToAppend[moreParams.voiceResult].push(img)}})}return;case"ov-icon":if(APP.utils.isset(that.myData[section][id].data[voice])&&!APP.utils.isEmptyString(that.myData[section][id].data[voice])){if(!APP.utils.isset(overviewToAppend[moreParams.voiceResult]))overviewToAppend[moreParams.voiceResult]=[];var span=$('<p><i class="icon icon-'+moreParams.icon+'"></i> <b>'+APP.i18n.translate(voice)+"</b>: "+that.myData[section][id].data[voice]+"</p>");overviewToAppend[moreParams.voiceResult].push(span)}return;case"ov-icage":if(APP.utils.isset(that.myData[section][id].data[voice])&&!APP.utils.isEmptyString(that.myData[section][id].data[voice])){if(!APP.utils.isset(overviewToAppend[moreParams.voiceResult]))overviewToAppend[moreParams.voiceResult]=[];var span=$("<p><b>"+APP.i18n.translate(voice)+"</b>: "+that.myData[section][id].data[voice]+"</p>");if(moreParams.image&&moreParams.image!=="")span.prepend('<img class="pull-left" src="'+moreParams.image+'" style="margin-right: 5px">');overviewToAppend[moreParams.voiceResult].push(span)}return;case"ov-descriptionWithInlineImages":if(APP.utils.isset(that.myData[section][id].data[voice])&&APP.utils.isset(moreParams)&&$.isArray(moreParams.values)){if(!APP.utils.isset(overviewToAppend[moreParams.voiceResult]))overviewToAppend[moreParams.voiceResult]=[];var arr=[];if(!$.isArray(that.myData[section][id].data[voice]))arr[0]=that.myData[section][id].data[voice];else arr=that.myData[section][id].data[voice];var span=$('<p class="pull-left"><b>'+APP.i18n.translate(moreParams.description)+"</b>: </p>");$.each(arr,function(i,v){var ii=APP.utils.getIndexFromField(moreParams.values,"id",v);if(ii>-1){var img=$('<img src="'+moreParams.values[ii][moreParams.icon]+'" class="img-responsive pull-right" style="margin-right: 3px; max-width: 30px" >');img.tooltip({title:moreParams.values[ii][moreParams.label]});span.append(img)}});overviewToAppend[moreParams.voiceResult].push(span)}return;case"paths":case"pois":case"areas":if(that.myData[section][id].data[voice].length===0)bInsert=false;else{var s=null;switch(type){case"paths":s="path";break;case"pois":s="poi";break;case"areas":s="area";break}var ul=$('<ul class="media-list"></ul>');$.each(that.myData[section][id].data[voice],function(i,v){var btn=$('<a href="#" class="btn-link">'+that.getObjectTitle(s,v)+"</a>");btn.data("id",v).click(function(){var myId=$(this).data("id");myModal.modal("hide");that.onElementClick({element:$(this),section:s,id:myId,latlng:null})});var typology=that.getTypology(that.myData[s][v].data.typology_id);var li=$('<li class="media">											<a class="pull-left" href="#">											</a>											<div class="media-body">												<h5 class="media-heading"></h5>											</div>										</li>');li.find(".media-heading").append(btn);if(typology){var iimmgg=$('<img class="media-object" src="'+typology.icon+'" alt="'+typology.name+'">');iimmgg.tooltip({title:APP.i18n.translate(typology.name)});li.find("a:first").append(iimmgg)}ul.append(li)});div.append(ul)}break;case"url":if(APP.utils.isset(that.myData[section][id].data[voice])&&!APP.utils.isEmptyString(that.myData[section][id].data[voice])){var dl=$("<ul></ul>");$.each(that.myData[section][id].data[voice],function(ii,vv){var li=$("<li></li>");var myUrl=vv.url.indexOf("http://")===-1?"http://"+vv.url:vv.url;li.append('<a class="btn-link" href="'+myUrl+'" target="_blank">'+vv.alias+"</a>");li.append('<span style="margin-left: 10px"><small><i>'+vv.description_url+"</i></small></span>");dl.append(li)});div.append(dl)}else bInsert=false;break;case"video":if(APP.utils.isset(that.myData[section][id].media)&&APP.utils.isset(that.myData[section][id].media.videos)&&$.isArray(that.myData[section][id].media.videos)&&that.myData[section][id].media.videos.length>0){var galleryId="bvg_"+section+"_"+id;that.setBlueimpGalleryDiv({container:div,id:galleryId,classes:"blueimp-gallery blueimp-gallery-controls blueimp-gallery-carousel",closeBtn:false});videosContainer=div.find("#"+galleryId);$.each(that.myData[section][id].media.videos,function(i,v){var vo=that.checkVideoUrl($(v.video_embed).attr("src"));if(vo){vo.title=v.title;videos.push(vo)}})}else bInsert=false;break;default:bInsert=false;break}if(bInsert)parToAppend.push(div)};switch(section){case"poi":checkVoice("typology_id","ov-img",{values:APP.config.localConfig.typology,label:"name",icon:"icon",voiceResult:"categories"});checkVoice("typologies","ov-img",{values:APP.config.localConfig.typology,label:"name",icon:"icon",voiceResult:"categories"});checkVoice("description","text");checkVoice("reason","text");checkVoice("period_schedule","text");checkVoice("accessibility","text");checkVoice("urls","url");checkVoice("video_poi","video");break;case"path":checkVoice("typology_id","ov-img",{values:APP.config.localConfig.typology,label:"name",icon:"icon",voiceResult:"categories"});checkVoice("typologies","ov-img",{values:APP.config.localConfig.typology,label:"name",icon:"icon",voiceResult:"categories"});checkVoice("description","text");checkVoice("length","ov-icage",{image:that.icons["length"],voiceResult:"features"});checkVoice("altitude_gap","ov-icage",{image:that.icons.altitude_gap,voiceResult:"features"});checkVoice("modes","ov-descriptionWithInlineImages",{values:APP.config.localConfig.path_mode,label:"mode",icon:"icon",voiceResult:"features",description:APP.i18n.translate("transportation_types")});checkVoice("reason","text");checkVoice("period_schedule","text");checkVoice("accessibility","text");checkVoice("urls","url");checkVoice("video_path","video");break;case"area":checkVoice("typology_id","ov-img",{values:APP.config.localConfig.typology,label:"name",icon:"icon",voiceResult:"categories"});checkVoice("typologies","ov-img",{values:APP.config.localConfig.typology,label:"name",icon:"icon",voiceResult:"categories"});checkVoice("description","text");checkVoice("plus_information","text");checkVoice("inquiry","text");checkVoice("urls","url");checkVoice("video_area","video");break;case"itinerary":checkVoice("typology_id","ov-img",{values:APP.config.localConfig.typology,label:"name",icon:"icon",voiceResult:"categories"});checkVoice("typologies","ov-img",{values:APP.config.localConfig.typology,label:"name",icon:"icon",voiceResult:"categories"});checkVoice("description","text");checkVoice("areas","areas");checkVoice("paths","paths");checkVoice("pois","pois");break;default:break}if(parToAppend.length>0){$.each(parToAppend,function(){myModal.find(".modal-body .paragraphes").append(this)})}$.each(overviewToAppend,function(key,value){var l=value.length;if(l===0)return true;var row=$("<div></div>");$.each(value,function(k1,v1){row.append(v1)});myModal.find(".modal-body ."+key+" .panel-body").append(row);if(!myModal.find(".modal-body ."+key+" .panel-body").is(":empty"))myModal.find(".modal-body ."+key).show()});myModal.on("shown.bs.modal",function(){myModal.find(".centerImage").centerImage();blueimp.Gallery(videos,{container:videosContainer,carousel:false})});myModal.on("hidden.bs.modal",function(){if(APP.utils.isset(onCloseCallback)&&$.isFunction(onCloseCallback))onCloseCallback()});that.body.append(myModal);myModal.modal()},zoomAt:function(section,id){var that=this;APP.map.globalData[APP.map.currentMapId].globalExtent={};switch(section){case"poi":var maxZoom=APP.map.globalData[APP.map.currentMapId].map.getMaxZoom();var currentZoom=APP.map.globalData[APP.map.currentMapId].map.getZoom();var latLng=L.latLng(that.myData[section][id].geo.geoJSON.coordinates[1],that.myData[section][id].geo.geoJSON.coordinates[0]);nextZoom=currentZoom>=maxZoom-3?currentZoom:maxZoom-3;APP.map.globalData[APP.map.currentMapId].map.setView(latLng,nextZoom,{animate:true});return;case"path":case"area":APP.map.setGlobalExtent(that.myData[section][id].geo.extent);break;case"itinerary":$.each(that.myData[section][id].data.paths,function(i,v){APP.map.setGlobalExtent(that.myData["path"][v].geo.extent)});$.each(that.myData[section][id].data.pois,function(i,v){APP.map.setGlobalExtent(that.myData["poi"][v].geo.extent)});break;default:break}APP.map.setExtent(APP.map.globalData[APP.map.currentMapId].globalExtent)},closeItems:function(section,callback){var that=this;if(that.itemsOnSidebar&&L.control.sidebar&&that.mySidebar.control)that.mySidebar.control.hide();else that.body.find("#modal-"+section).modal("hide")},showItems:function(section,callback){var that=this;if(that.previousSection===that.currentSection){if(that.itemsOnSidebar&&L.control.sidebar&&that.mySidebar.control)that.mySidebar.control.toggle();else that.body.find("#modal-"+section).modal("toggle")}else{if(that.itemsOnSidebar&&L.control.sidebar)that.showItemsOnSidebar(section,callback);else that.showItemsOnModal(section,callback)}},showItemsOnSidebar:function(section,callback){var that=this;that.mySidebar.div.empty();that.mySidebar.control.on("shown",function(e){that.navbars.top.find("#"+that.currentSection+"Button").parent().addClass("active")});that.mySidebar.control.show();that.mySidebar.control.on("hidden",function(e){APP.config.removeActiveClasses(that.navbars.top,"li")});switch(section){case"itinerary":var listGroup=$('<div class="list-group list-group-wo-radius" style="margin: 0px -23px 0px -23.5px; padding: -10px"></div>');$.each(that.myData[section],function(i,v){var media=$('<div class="media">									  <a class="pull-left" href="#">										<img class="media-object img-rounded" src="'+that.getOverviewImage(section,v.data.id,true)+'" alt="'+APP.i18n.translate("no_image")+'" style="max-width: 60px; max-height: 60px">									  </a>									  <div class="media-body">										<h4 class="media-heading">'+this.data.name+"</h4>									  </div>									</div>");var a=$('<a id="item_'+section+"_"+v.data.id+'" href="#" class="list-group-item '+(that.currentItinerary===v.data.id?"active":"")+'"></a>');a.data(v).append(media);a.click(function(){var lg=$(this).parents(".list-group:first");lg.find("a.active").removeClass("active");$(this).addClass("active");that.mySidebar.control.hide();that.onItineraryClick({element:$(this),section:section,id:$(this).data().data.id})});that.insertRowAlphabetically(listGroup,a,".media-heading")});that.mySidebar.div.html(listGroup);break;case"poi":case"path":case"area":var accordion=$('<div id="accordion-'+section+'" class="accordion-list" style="margin: 0px -23px 0px -23.5px; padding: -10px"></div>');$.each(APP.config.localConfig.typology,function(){var header=$('<h4 style="vertical-align: middle; border-radius:0px">										<span class="pull-left iconImage" style="margin-right: 5px"></span>										'+this.name+'										<span class="badge pull-right">0</span>									</h4>');var content=$('<div id="collapse_'+section+"_"+this.id+'" class="list-group list-group-wo-radius" style="padding: 0px; margin-bottom: 0px; border-radius:0px"></div>');var iconImage=$('<span class="glyphicon glyphicon-chevron-right"></span>');if(APP.utils.isset(this.icon)&&this.icon!=="")var iconImage=$('<img src="'+this.icon+'" class="img-responsive" alt="" style="margin-top: -5px; max-height: 30px; max-width: 35px;">');header.find(".iconImage").html(iconImage);accordion.append(header).append(content)});$.each(that.myData[section],function(i,v){if(that.currentItinerary&&$.inArray(that.currentItinerary,that.myData[section][i].data.itineraries)===-1)return true;var container=accordion.find("#collapse_"+section+"_"+v.data.typology_id);var media=$('<div class="media">									  <a class="pull-left" href="#" >										<img class="media-object img-responsive img-rounded" src="'+(APP.utils.isset(v.data.thumb_main_image)?v.data.thumb_main_image:APP.config.localConfig.default_overview_image)+'" alt="'+APP.i18n.translate("no_image")+'" style="width: 60px; height: 60px">									  </a>									  <div class="media-body">										<h5 class="media-heading">'+v.data.title+"</h5>									  </div>									</div>");var row=$('<a id="item_'+section+"_"+v.data.id+'" href="#" class="list-group-item '+(that.selectedElement===v.data.id?"active":"")+'"></a>');row.data(v).click(function(){that.onElementClick({element:$(this),section:section,id:v.data.id,latlng:null})});row.append(media);that.insertRowAlphabetically(container,row,".media-heading");var counter=parseInt(container.prev().find(".badge").text());container.prev().find(".badge").text(counter+1)});that.mySidebar.div.html(accordion);break;case"info":that.getPage(section,true);if(APP.utils.isset(callback)&&$.isFunction(callback))callback();return;default:break}that.mySidebar.div.prepend("<h3>"+APP.i18n.translate(APP.utils.capitalize(section)+" section")+"</h3>");$.each(that.mySidebar.div.find("#accordion-"+section+" .list-group"),function(){if($(this).children().length===0){$(this).prev().remove();$(this).remove()}});that.mySidebar.div.find("#accordion-"+section).accordion({heightStyle:"content",collapsible:true,active:false});if(APP.utils.isset(callback)&&$.isFunction(callback))callback()},showItemsOnModal:function(section,callback){var that=this;var myModal=that.body.find("#modal-"+section);if(myModal.length>0)myModal.remove();myModal=$('<div id="modal-'+section+'" class="modal fade" tabindex="-1" role="dialog" aria-labelledby="'+section+'" aria-hidden="true">						<div class="modal-dialog">							<div class="modal-content">							  <div class="modal-header">								<button type="button" class="btn-lg close" data-dismiss="modal" aria-hidden="true"><span class="glyphicon glyphicon-remove"></span></button>								<h3 class="lead">'+APP.i18n.translate(section+"_list")+'</h3>							  </div>							  <div class="modal-body">							  </div>							  <div class="modal-footer">								<button type="button" data-dismiss="modal" class="btn btn-primary">'+APP.i18n.translate("close")+"</button>							  </div>							</div>						</div>					</div>");myModal.on("hidden.bs.modal",function(e){});that.body.append(myModal);switch(section){case"itinerary":var listGroup=$('<div class="list-group list-group-wo-radius" style="margin: -15px"></div>');$.each(that.myData[section],function(i,v){var media=$('<div class="media">									  <a class="pull-left" href="#">										<img class="media-object img-rounded" src="'+that.getOverviewImage(section,v.data.id,true)+'" alt="'+APP.i18n.translate("no_image")+'" style="max-width: 60px; max-height: 60px">									  </a>									  <div class="media-body">										<h4 class="media-heading">'+this.data.name+"</h4>									  </div>									</div>");var a=$("<a item_"+section+"_"+v.data.id+' href="#" class="list-group-item '+(that.currentItinerary===v.data.id?"active":"")+'"></a>');a.data(v).append(media);a.click(function(){APP.config.removeActiveClasses($(this).parents(".list-group:first"),"a");$(this).addClass("active");that.body.find("#modal-"+section).modal("hide");that.onItineraryClick({element:$(this),section:section,id:$(this).data().data.id})});that.insertRowAlphabetically(listGroup,a,".media-heading")});myModal.find(".modal-body").html(listGroup);break;case"poi":case"path":case"area":if(that.body.find("#accordion-"+section).length>0)that.body.find("#accordion-"+section).remove();var accordion=$('<div class="panel-group accordion-list" id="accordion-'+section+'"></div>');$.each(APP.config.localConfig.typology,function(){var panel=$('<div class="panel panel-default">										<div class="panel-heading">											<h4 class="panel-title" style="vertical-align: middle">												<span class="pull-left iconImage" style="margin-right: 5px"></span>												<a data-toggle="collapse" data-parent="#accordion-'+section+'" href="#collapse_'+section+"_"+this.id+'">													'+this.name+'												</a>												<span class="badge pull-right" style="">0</span>											</h4>										</div>										<div id="collapse_'+section+"_"+this.id+'" class="panel-collapse collapse">											<div class="panel-body list-group list-group-wo-radius" style="padding: 0px; margin-bottom: 0px"></div>										</div>									</div>');var iconImage=$('<span class="glyphicon glyphicon-chevron-right"></span>');if(APP.utils.isset(this.icon)&&this.icon!=="")var iconImage=$('<img src="'+this.icon+'" class="img-responsive" alt="" style="margin-top: -5px; max-height: 30px; max-width: 35px;">');panel.find(".panel-title .iconImage").html(iconImage);panel.find(".collapse").collapse({toggle:false});accordion.append(panel)});$.each(that.myData[section],function(i,v){if(that.currentItinerary&&$.inArray(that.currentItinerary,that.myData[section][i].data.itineraries)===-1)return true;var container=accordion.find("#collapse_"+section+"_"+v.data.typology_id+" .panel-body");var media=$('<div class="media">									  <a class="pull-left" href="#" >										<img class="media-object img-responsive img-rounded" src="'+(APP.utils.isset(v.data.thumb_main_image)?v.data.thumb_main_image:APP.config.localConfig.default_overview_image)+'" alt="'+APP.i18n.translate("no_image")+'" style="width: 60px; height: 60px">									  </a>									  <div class="media-body">										<h5 class="media-heading">											'+v.data.title+"										</h5>									  </div>									</div>");var row=$('<a id="item_'+section+"_"+v.data.id+'" href="#" class="list-group-item '+(that.selectedElement===v.data.id?"active":"")+'"</a>');row.data(v).click(function(){that.onElementClick({element:$(this),section:section,id:v.data.id,latlng:null});myModal.modal("hide")});row.append(media);that.insertRowAlphabetically(container,row,".media-heading");var counter=parseInt(container.parents(".panel:first").find(".badge").text());container.parents(".panel:first").find(".badge").text(counter+1)});$.each(accordion.find(".panel-body"),function(){if($(this).children().length===0){$(this).parents(".panel:first").remove()}});that.body.find(".modal-body").html(accordion);break;default:break}myModal.modal();if(APP.utils.isset(callback)&&$.isFunction(callback))callback()},sectionCompleted:function(section){var that=this;if(APP.utils.isset(that.myData[section])){$.each(that.myData[section],function(i,v){if($.isPlainObject(v.data)&&$.isPlainObject(v.media)){if(section=="itinerary"||$.isPlainObject(v.geo)){that.navbars.top.find("#"+section+"Button").parents("li:first").removeClass("disabled");that.qrCodeEventObj.trigger(section+"_completed")}}return false})}return false},getMedia:function(o){var that=this;var section=APP.utils.isset(o.section)?o.section:null;var id=APP.utils.isset(o.id)?o.id:null;var destination=APP.utils.isset(o.destination)?o.destination:that.myData;var url=APP.utils.isset(o.url)?o.url:APP.utils.isset(section)?"/jx/media/"+section+"/":"/jx/media/";var callback=APP.utils.isset(o.callback)?o.callback:null;var bAsync=APP.utils.isset(o.bAsync)?o.bAsync:true;$.ajax({type:"GET",url:url+(APP.utils.isset(id)?"/"+id:""),dataType:"json",async:bAsync,success:function(data){if(!APP.utils.checkError(data.error,null)){if(APP.utils.isset(data.data)&&APP.utils.isset(data.data.items)){$.each(data.data.items,function(i,v){var cs=APP.utils.isset(section)?section:i.toLowerCase();if(!APP.utils.isset(destination[cs]))destination[cs]={};if(!$.isArray(v)&&$.isPlainObject(v)){if(!APP.utils.isset(destination[cs][v.id]))destination[cs][v.id]={};destination[cs][v.id].media=v}else{$.each(v,function(j,k){if(!APP.utils.isset(destination[cs][k.id]))destination[cs][k.id]={};destination[cs][k.id].media=k})}})}that.sectionCompleted(section);if(APP.utils.isset(callback)&&$.isFunction(callback))callback()}else APP.utils.showErrMsg(data)},error:function(result){APP.utils.showErrMsg(result)}})},getData:function(o){var that=this;var section=APP.utils.isset(o.section)?o.section:null;var destination=APP.utils.isset(o.destination)?o.destination:that.myData;var url=APP.utils.isset(o.url)?o.url:APP.utils.isset(section)?"/jx/data/"+section+"/":"/jx/data/";var callback=APP.utils.isset(o.callback)?o.callback:null;var bAsync=APP.utils.isset(o.bAsync)?o.bAsync:true;$.ajax({type:"GET",url:url,dataType:"json",async:bAsync,success:function(data){if(!APP.utils.checkError(data.error,null)){if(data.data&&data.data.items){$.each(data.data.items,function(i,v){var cs=APP.utils.isset(section)?section:i.toLowerCase();if(!APP.utils.isset(destination[cs]))destination[cs]={};if(!$.isArray(v)&&$.isPlainObject(v)){if(!APP.utils.isset(destination[cs][v.id]))destination[cs][v.id]={};destination[cs][v.id].data=v}else{$.each(v,function(j,k){if(!APP.utils.isset(destination[cs][k.id]))destination[cs][k.id]={};destination[cs][k.id].data=k})}})}that.sectionCompleted(section);if(APP.utils.isset(callback)&&$.isFunction(callback))callback()}else APP.utils.showErrMsg(data)},error:function(result){APP.utils.showErrMsg(result)}})},getGeo:function(o){var that=this;var section=APP.utils.isset(o.section)?o.section:null;var destination=APP.utils.isset(o.destination)?o.destination:that.myData;var url=APP.utils.isset(o.url)?o.url:APP.utils.isset(section)?"/jx/geo/"+section+"/":"/jx/geo/";var callback=APP.utils.isset(o.callback)?o.callback:null;var bAsync=APP.utils.isset(o.bAsync)?o.bAsync:true;$.ajax({type:"GET",url:url,dataType:"json",async:bAsync,success:function(data){if(!APP.utils.checkError(data.error,null)){if(data.data&&data.data.items){$.each(data.data.items,function(i,v){var cs=APP.utils.isset(section)?section:i.toLowerCase();if(!APP.utils.isset(destination[cs]))destination[cs]={};if(!$.isArray(v)&&$.isPlainObject(v)){if(!APP.utils.isset(destination[cs][v.id]))destination[cs][v.id]={};destination[cs][v.id].geo=v;that.sendGeojsonLayerToMap(v,cs);APP.map.setGlobalExtent(destination[cs][v.id].geo.extent)}else{$.each(v,function(j,k){if(!APP.utils.isset(destination[cs][k.id]))destination[cs][k.id]={};destination[cs][k.id].geo=k;that.sendGeojsonLayerToMap(k,cs);APP.map.setGlobalExtent(destination[cs][k.id].geo.extent)})}})}that.sectionCompleted(section);if(!APP.utils.isset(that.leafletHash)&&!that.bQrCode)APP.map.setExtent(APP.map.globalData[APP.map.currentMapId].globalExtent);if(APP.utils.isset(callback)&&$.isFunction(callback))callback()}else APP.utils.showErrMsg(data)},error:function(result){APP.utils.showErrMsg(result)}})},sendGeojsonLayerToMap:function(v,section){var that=this;var map=APP.map.getMap();if(v.geoJSON.type==="Point"){var coords=[v.geoJSON.coordinates[1],v.geoJSON.coordinates[0]];var myIcon=null;var myIndex=APP.utils.getIndexFromField(APP.config.localConfig.typology,"id",v.typology_id);if(myIndex>-1&&APP.utils.isset(APP.config.localConfig.typology[myIndex].marker)&&APP.utils.isset(APP.config.localConfig.typology[myIndex].icon)){myIcon=L.icon({iconUrl:APP.config.localConfig.typology[myIndex].marker,iconAnchor:[16,37]})}else{APP.utils.showNoty({title:APP.i18n.translate("error"),content:APP.i18n.translate("typology_icon_marker_requested"),type:"error"});return false}var myObj={bounceOnAdd:that.bouncingMarkers};
if(myIcon)myObj.icon=myIcon;var layer=new L.Marker(coords,myObj);layer.on("click",function(args){that.onElementClick({element:layer,section:section,id:v.id,latlng:null})});if(!APP.map.globalData[APP.map.currentMapId].map.hasLayer(layer))APP.map.addLayer({layer:layer,id:section+"_"+v.id,max_scale:v.max_scale})}else{var layer=new L.geoJson(v.geoJSON,{style:function(feature){var oo={};if(v.color)oo.color=v.color;oo.weight=APP.utils.isset(v.width)?v.width:7;return oo},onEachFeature:function(feature,layer){layer.on("click",function(args){that.onElementClick({element:args.layer,section:section,id:v.id,latlng:args.latlng})})}});if(!APP.map.globalData[APP.map.currentMapId].map.hasLayer(layer))APP.map.addLayer({layer:layer,id:section+"_"+v.id,max_scale:v.max_scale})}},isAvailableObject:function(myObj){if(!APP.utils.isset(myObj.obj)){APP.utils.showNoty({title:APP.i18n.translate("error"),type:"error",content:myObj.label+" "+APP.i18n.translate("not_configured")});return false}return true},setBlueimpGalleryDiv:function(params){var that=this;if(params.container.find("#"+params.id).length>0)params.container.find("#"+params.id).remove();var div=$('<div id="'+params.id+'" class="'+params.classes+'">						<div class="slides"></div>						<h3 class="title"></h3>						<a class="prev"><i class="icon icon-chevron-sign-left"></i></a>						<a class="next"><i class="icon icon-chevron-sign-right"></i></a>						<a class="close"><i class="icon icon-remove"></i></a>						<a class="play-pause"></a>						<ol class="indicator"></ol>					</div>');if(!params.closeBtn)div.find(".close").remove();params.container.append(div)},setSearchModal:function(){var that=this;var modalId="searchModal";that.searchModal=$('<div class="modal fade" id="'+modalId+'" tabindex="-1" role="dialog" aria-labelledby="'+modalId+'Label" aria-hidden="true">								<div class="modal-dialog modal-lg">									<div class="modal-content">										<div class="modal-header">											<button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">'+APP.i18n.translate("Close")+'</span></button>											<h4 class="modal-title" id="'+modalId+'Label">'+APP.i18n.translate("Search Panel")+'</h4>										</div>										<div class="modal-body">											<form role="form">												<div class="form-group">													<label for="searchInput">'+APP.i18n.translate("Search")+'</label>													<div class="input-group">														<input type="text" class="form-control" id="searchInput" placeholder="'+APP.i18n.translate("What are you looking for?")+'">														<span class="input-group-btn">															<button class="btn btn-default submitBtn" type="button"><i class="icon icon-search"></i> '+APP.i18n.translate("OK")+'</button>														</span>													</div>												</div>											</form>											<div class="table-responsive" style="">												<table class="table table-striped table-hover">													<thead>														<tr><th>'+APP.i18n.translate("Type")+"</th><th>"+APP.i18n.translate("Title")+"</th><th>"+APP.i18n.translate("Category")+'</th><th class="hidden-xs hidden-sm">'+APP.i18n.translate("Teaser")+'</th></tr>													</thead>													<tbody>													</tbody>												</table>											</div>										</div>										<div class="modal-footer">											<button type="button" class="btn btn-primary" data-dismiss="modal">'+APP.i18n.translate("Close")+"</button>										</div>									</div>								</div>							</div>");that.searchModal.find(".submitBtn").click(function(){var inp=that.searchModal.find("#searchInput");$.ajax({type:"GET",url:that.searchUrl+inp.val(),dataType:"json",success:function(data){if(!APP.utils.checkError(data.error,null)){var table=that.searchModal.find("table");var tbody=that.searchModal.find("table tbody");if($.fn.DataTable.fnIsDataTable(table[0])){table.dataTable().fnDestroy();tbody.empty()}var createDataTable=function(){that.searchModal.find("table").dataTable({bSort:true,bRetrieve:true,bPaginate:true,sPaginationType:"full_numbers",aLengthMenu:[10,20,30,50,100],iDisplayLength:data.items_per_page?data.items_per_page:10,aaSorting:[[0,"asc"],[1,"asc"]],bJQueryUI:false,oLanguage:APP.utils.getDataTableLanguage(),fnDrawCallback:function(oSettings){},fnInitComplete:function(oSettings,json){}})};if(!data.data||!data.data.items||!$.isArray(data.data.items)||data.data.items.length===0){createDataTable();return false}$.each(data.data.items,function(i,v){var sectionIcon=that.body.find("#"+v.type.toLowerCase()+"Button .icon").clone().addClass("icon-2x").tooltip({title:APP.i18n.translate(v.type.toLowerCase())});var row=$('<tr style="cursor: pointer"><td class="sectionIcon"><span style="display:none">'+v.type.toLowerCase()+"</span></td><td>"+v.title+'</td><td class="categoryTd"></td><td class="hidden-xs hidden-sm">'+v.teaser+"</td></tr>");row.find(".sectionIcon").append(sectionIcon);var typology=that.getTypology(that.myData[v.type.toLowerCase()][v.id].data.typology_id);if(typology){var span=$('<span style="display:none">'+typology.name+"</span>");var img=$('<img class="img-responsive" src="'+typology.icon+'"  alt="'+typology.name+'" style="max-width: 32px">');img.tooltip({title:APP.i18n.translate(typology.name)});row.find(".categoryTd").append(span).append(img)}row.data({section:v.type.toLowerCase(),id:v.id});row.click(function(){var myData=$(this).data();that.searchModal.modal("hide");var openItem=function(){if(myData.section==="itinerary")that.onItineraryClick({element:$(this),section:myData.section,id:myData.id});else that.onElementClick({element:$(this),section:myData.section,id:myData.id,latlng:null})};if(that.currentItinerary){that.closeItinerary(function(){openItem()})}else openItem()});tbody.append(row)});createDataTable()}else{APP.utils.showErrMsg(data)}},error:function(result){APP.utils.showErrMsg(result)}})});that.searchModal.find("#searchInput").on("keypress",function(e){var code=e.keyCode||e.which;if(code==13){that.searchModal.find(".submitBtn").click();e.preventDefault()}});that.searchModal.on("show.bs.modal",function(){var n=that.navbars.top.parents(".navbar:first");if(n.find(".navbar-collapse").hasClass("in"))n.find(".navbar-collapse").collapse("hide");that.body.find("#searchButton").parent().addClass("active")});that.searchModal.on("shown.bs.modal",function(){that.searchModal.find("#searchInput").focus()});that.searchModal.on("hide.bs.modal",function(){that.body.find("#searchButton").parent().removeClass("active")});that.body.append(that.searchModal);var bt=that.body.find("#searchButton");bt.attr("data-target","#"+modalId).click(function(){if(that.itemsOnSidebar&&L.control.sidebar&&that.mySidebar.control)that.mySidebar.control.hide()})},getScale:function(map){var that=this;var maxWidth=100;var bounds=map.getBounds(),centerLat=bounds.getCenter().lat,halfWorldMeters=6378137*Math.PI*Math.cos(centerLat*Math.PI/180),dist=halfWorldMeters*(bounds.getNorthEast().lng-bounds.getSouthWest().lng)/180,size=map.getSize(),options=this.options,maxMeters=0;if(size.x>0){maxMeters=dist*(maxWidth/size.x)}var getRoundNum=function(num){var pow10=Math.pow(10,(Math.floor(num)+"").length-1),d=num/pow10;d=d>=10?10:d>=5?5:d>=3?3:d>=2?2:1;return pow10*d};if(maxMeters)return getRoundNum(maxMeters)},showPage:function(section){var that=this;var htmlPage=that.pages[section].content;if(that.pages[section].type==="sidebar"&&that.itemsOnSidebar&&L.control.sidebar&&that.mySidebar.control){that.mySidebar.div.append(htmlPage);that.mySidebar.control.show()}else{var modalId="modal-"+section;var myModal=that.body.find("#"+modalId);if(myModal.length===0){myModal=APP.utils.createModal({container:that.body,id:modalId,size:"lg",header:APP.utils.capitalize(APP.i18n.translate(section)),body:htmlPage,shown:function(){},hidden:function(){}})}var n=that.navbars.top.parents(".navbar:first");if(n.find(".navbar-collapse").hasClass("in"))n.find(".navbar-collapse").collapse("hide");myModal.modal("show")}},getPage:function(section,bShow){var that=this;if(!APP.utils.isset(that.pages[section])){APP.utils.showNoty({title:APP.i18n.translate("error"),type:"error",content:APP.i18n.translate("page_not_found")});return false}if(!APP.utils.isset(that.pages[section].content)){$.ajax({type:"GET",url:that.pages[section].url,dataType:"json",success:function(data){if(!APP.utils.checkError(data.error,null)){that.pages[section].content=data.data.items[0].body;that.body.find("#"+section+"Button").parent().removeClass("disabled");if(bShow)that.showPage(section)}else{APP.utils.showErrMsg(data)}},error:function(result){APP.utils.showErrMsg(result)}})}else if(bShow)that.showPage(section)},setPages:function(){var that=this;$.each(APP.config.localConfig.page_urls,function(i,v){var t=i==="help"?"modal":"sidebar";that.pages[i]={url:v,content:null,type:t}})},checkUrlCoords:function(){var that=this;var uc=window.location.href;uc=uc.split("#");if(uc.length===1)return;uc=uc[1].split("/");if(uc.length===3){that.leafletHash={zoom:uc[0],lat:uc[1],lng:uc[2]}}if(uc.length===2){var section=uc[0];var id=parseInt(uc[1]);var callback=function(){that.onElementClick({element:null,section:section,id:id})};if(section=="itinerary"){callback=function(){that.onItineraryClick({element:null,section:section,id:id})}}if(!isNaN(id)){that.bQrCode=true;that.qrCodeEventObj.on(section+"_completed",function(){callback()})}}},start:function(){var that=this;var arr=[{obj:APP.config.localConfig,label:"config"},{obj:APP.config.localConfig.background_layer,label:"background_layer"},{obj:APP.config.localConfig.default_extent,label:"default_extent"},{obj:APP.config.localConfig.default_overview_image,label:"default_overview_image"},{obj:APP.config.localConfig.i18n,label:"i18n"},{obj:APP.config.localConfig.page_urls,label:"page_urls"},{obj:APP.config.localConfig.path_mode,label:"path_mode"},{obj:APP.config.localConfig.typology,label:"typology"},{obj:APP.config.localConfig.urls,label:"urls"}];var errorObj=false;$.each(arr,function(){if(!that.isAvailableObject(this)){errorObj=true;return false}});if(errorObj)return;var errorIM=false;$.each(APP.config.localConfig.typology,function(){if(!APP.utils.isset(this.icon)||!APP.utils.isset(this.marker)){errorIM=true;return false}});if(errorIM){APP.utils.showNoty({title:APP.i18n.translate("error"),type:"error",content:APP.i18n.translate("typology_icon_marker_requested")});return}that.checkUrlCoords();that.setPages();$("html").css({height:"100%",width:"100%"});that.body=$("body");that.body.css({height:"100%",width:"100%","padding-top":"50px"});that.body.find(".navbar-nav:first li").addClass("disabled");that.navbars.top=that.body.find(".navbar-nav:first");that.navbars.top.find("a").click(function(){var n=that.navbars.top.parents(".navbar:first");if(n.find(".navbar-collapse").hasClass("in"))n.find(".navbar-collapse").collapse("hide");if($(this).parents("li:first").hasClass("disabled"))return false;that.navbars.top.find("li").removeClass("active");$(this).parents("li:first").addClass("active");var section=$(this).attr("id");section=section.split("Button")[0];that.previousSection=that.currentSection;that.currentSection=section;switch(section){case"to_default_extent":$(this).parents("li:first").removeClass("active");if(!APP.utils.isset(APP.config.localConfig.default_extent))APP.utils.showNoty({title:APP.i18n.translate("error"),type:"error",content:APP.i18n.translate("Default extent not found")});APP.map.setGlobalExtent(APP.config.localConfig.default_extent);APP.map.setExtent(APP.config.localConfig.default_extent);break;default:that.showItems(section)}});that.navbars.top.find("#to_default_extentButton").parent().removeClass("disabled");that.setSearchModal();$("#mainContent").css({height:"100%",width:"100%","margin-bottom":"0px"});APP.map.sidebar.div=$('<div id="leafletSidebar" style="margin-top: -60px"></div>');that.body.append(APP.map.sidebar.div);var params={container:$("#mainContent")};if(that.leafletHash){params.center=new L.LatLng(that.leafletHash.lat,that.leafletHash.lng);params.zoom=that.leafletHash.zoom}APP.map.setMap(params);that.mySidebar.div=APP.map.sidebar.div;that.mySidebar.control=APP.map.sidebar.control;that.getPage("info",false);APP.map.getMap().on("click",function(){that.selectedElement=null;that.resetHighlightLayer()});APP.map.getMap().on("zoomend",function(){var map=APP.map.getMap();var scale=that.getScale(APP.map.globalData[APP.map.currentMapId].map);$.each(APP.map.globalData[APP.map.currentMapId].addedLayers,function(i,v){if(i.indexOf("poi")===-1||that.currentItinerary)return true;if(!APP.utils.isset(v.max_scale)||scale<=v.max_scale)APP.map.showLayer(i);else APP.map.hideLayer(i)})});$("#mainContent").height($("#mainContent").height());that.getGeo({section:"poi",callback:function(){var map=APP.map.getMap();map.fire("zoomend")}});that.getData({section:"poi"});that.getMedia({section:"poi"});that.getGeo({section:"path"});that.getData({section:"path"});that.getMedia({section:"path"});that.getGeo({section:"area"});that.getData({section:"area"});that.getMedia({section:"area"});that.getData({section:"itinerary"});that.getMedia({section:"itinerary"});that.body.find("#helpButton").click(function(){that.closeItems();that.getPage("help",true)});if(!that.leafletHash&&!that.navbars.top.parents(".navbar").find(".navbar-toggle").is(":visible")){setTimeout(function(){that.navbars.top.find("#infoButton").click()},2e3)}}});$(document).ready(function(){APP.config.init();var hhtml=$("html").height();var login=$("#login");if(login.length>0)login.css("margin-top",(hhtml-login.height())/2)});